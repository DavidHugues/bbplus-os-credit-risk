[0m17:58:26.078132 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f961f65c5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9623271d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f96232713d0>]}


============================== 17:58:26.082596 | df718c7b-aafa-4abf-b0e4-9db617448b37 ==============================
[0m17:58:26.082596 [info ] [MainThread]: Running with dbt=1.8.8
[0m17:58:26.083592 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'indirect_selection': 'eager', 'debug': 'False', 'no_print': 'None', 'use_colors': 'True', 'warn_error': 'None', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'static_parser': 'True', 'log_format': 'default', 'use_experimental_parser': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'printer_width': '80', 'empty': 'None', 'cache_selected_only': 'False', 'fail_fast': 'False', 'version_check': 'True', 'quiet': 'False', 'introspect': 'True', 'log_cache_events': 'False', 'profiles_dir': '/Users/david/.dbt', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt seed', 'partial_parse': 'True'}
[0m17:58:31.297537 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'df718c7b-aafa-4abf-b0e4-9db617448b37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9627582e80>]}
[0m17:58:31.406454 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'df718c7b-aafa-4abf-b0e4-9db617448b37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f961c17f310>]}
[0m17:58:31.407461 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m17:58:31.451017 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m17:58:31.453100 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m17:58:31.453924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'df718c7b-aafa-4abf-b0e4-9db617448b37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9627cac970>]}
[0m17:58:33.686607 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'df718c7b-aafa-4abf-b0e4-9db617448b37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9628390eb0>]}
[0m17:58:33.870408 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'df718c7b-aafa-4abf-b0e4-9db617448b37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9628361b80>]}
[0m17:58:33.871199 [info ] [MainThread]: Found 2 models, 2 seeds, 4 data tests, 479 macros
[0m17:58:33.871750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'df718c7b-aafa-4abf-b0e4-9db617448b37', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f962822d190>]}
[0m17:58:33.873660 [info ] [MainThread]: 
[0m17:58:33.874479 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m17:58:33.881678 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m17:58:33.882540 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:58:36.847070 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:58:36.847868 [debug] [MainThread]: Connection 'list_steam-outlet-209412' was properly closed.
[0m17:58:36.848460 [info ] [MainThread]: 
[0m17:58:36.849066 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 2.97 seconds (2.97s).
[0m17:58:36.850158 [error] [MainThread]: Encountered an error:
Runtime Error
  Unable to generate access token, if you're using impersonate_service_account, make sure your initial account has the "roles/iam.serviceAccountTokenCreator" role on the account you are trying to impersonate.
  
  Reauthentication is needed. Please run `gcloud auth application-default login` to reauthenticate.
[0m17:58:36.850953 [debug] [MainThread]: Resource report: {"command_name": "seed", "command_wall_clock_time": 10.922649, "process_user_time": 6.880285, "process_kernel_time": 1.091449, "process_mem_max_rss": "231182336", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m17:58:36.851843 [debug] [MainThread]: Command `dbt seed` failed at 17:58:36.851687 after 10.92 seconds
[0m17:58:36.852467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f961f65c5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f962808c0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f96286e73a0>]}
[0m17:58:36.853066 [debug] [MainThread]: Flushing usage events
[0m18:00:23.357323 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd18ea24580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd190a30c40>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd190a30160>]}


============================== 18:00:23.363069 | e978a034-bced-49a7-9e0f-a46b366fe15b ==============================
[0m18:00:23.363069 [info ] [MainThread]: Running with dbt=1.8.8
[0m18:00:23.364032 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'version_check': 'True', 'quiet': 'False', 'profiles_dir': '/Users/david/.dbt', 'cache_selected_only': 'False', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'debug': 'False', 'printer_width': '80', 'introspect': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'invocation_command': 'dbt seed', 'fail_fast': 'False', 'empty': 'None', 'static_parser': 'True', 'use_colors': 'True', 'target_path': 'None', 'no_print': 'None', 'warn_error': 'None', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'indirect_selection': 'eager'}
[0m18:00:28.064688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'e978a034-bced-49a7-9e0f-a46b366fe15b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd19445afa0>]}
[0m18:00:28.152113 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'e978a034-bced-49a7-9e0f-a46b366fe15b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd194d5a250>]}
[0m18:00:28.153112 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m18:00:28.185772 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m18:00:28.546533 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m18:00:28.547147 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m18:00:28.632872 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'e978a034-bced-49a7-9e0f-a46b366fe15b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd195117130>]}
[0m18:00:28.818906 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'e978a034-bced-49a7-9e0f-a46b366fe15b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd194f9c5e0>]}
[0m18:00:28.819760 [info ] [MainThread]: Found 2 models, 2 seeds, 4 data tests, 479 macros
[0m18:00:28.820336 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'e978a034-bced-49a7-9e0f-a46b366fe15b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd1950e9040>]}
[0m18:00:28.822371 [info ] [MainThread]: 
[0m18:00:28.823244 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:00:28.829975 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m18:00:28.831605 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:00:32.192319 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now create_steam-outlet-209412_os-creditrisk)
[0m18:00:32.195741 [debug] [ThreadPool]: Creating schema "database: "steam-outlet-209412"
schema: "os-creditrisk"
"
[0m18:00:32.219131 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:00:32.219884 [debug] [ThreadPool]: On create_steam-outlet-209412_os-creditrisk: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "create_steam-outlet-209412_os-creditrisk"} */
create schema if not exists `steam-outlet-209412`.`os-creditrisk`
  
[0m18:00:33.115635 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:c5302909-11df-47d6-a912-0e75643b230f&page=queryresults
[0m18:00:33.448560 [debug] [ThreadPool]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Invalid dataset ID "os-creditrisk". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.; reason: invalid, message: Invalid dataset ID "os-creditrisk". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.')
[0m18:00:34.002655 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:c347b154-f2f0-48c1-a7bb-a1f7dff08834&page=queryresults
[0m18:00:34.309487 [error] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:c347b154-f2f0-48c1-a7bb-a1f7dff08834&page=queryresults
[0m18:00:34.310387 [debug] [ThreadPool]: BigQuery adapter: Unhandled error while running:
macro create_schema
[0m18:00:34.310933 [debug] [ThreadPool]: BigQuery adapter: Database Error
  Invalid dataset ID "os-creditrisk". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m18:00:34.312128 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:00:34.312636 [debug] [MainThread]: Connection 'create_steam-outlet-209412_os-creditrisk' was properly closed.
[0m18:00:34.313198 [info ] [MainThread]: 
[0m18:00:34.314986 [info ] [MainThread]: Finished running  in 0 hours 0 minutes and 5.49 seconds (5.49s).
[0m18:00:34.315913 [error] [MainThread]: Encountered an error:
Database Error
  Invalid dataset ID "os-creditrisk". Dataset IDs must be alphanumeric (plus underscores) and must be at most 1024 characters long.
[0m18:00:34.316836 [debug] [MainThread]: Resource report: {"command_name": "seed", "command_wall_clock_time": 11.068038, "process_user_time": 5.619461, "process_kernel_time": 1.189519, "process_mem_max_rss": "223653888", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m18:00:34.318006 [debug] [MainThread]: Command `dbt seed` failed at 18:00:34.317707 after 11.07 seconds
[0m18:00:34.319289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd18ea24580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd1950e9850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd195779550>]}
[0m18:00:34.321049 [debug] [MainThread]: Flushing usage events
[0m18:02:23.858417 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74422f5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd746267b20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd746267250>]}


============================== 18:02:23.863863 | bdb00794-8a55-4dac-b439-3d72c6dc85bb ==============================
[0m18:02:23.863863 [info ] [MainThread]: Running with dbt=1.8.8
[0m18:02:23.864889 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'quiet': 'False', 'use_experimental_parser': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'indirect_selection': 'eager', 'printer_width': '80', 'partial_parse': 'True', 'invocation_command': 'dbt seed', 'version_check': 'True', 'target_path': 'None', 'log_format': 'default', 'use_colors': 'True', 'cache_selected_only': 'False', 'static_parser': 'True', 'write_json': 'True', 'warn_error': 'None', 'debug': 'False', 'introspect': 'True', 'empty': 'None', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/Users/david/.dbt'}
[0m18:02:29.120289 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd749c193d0>]}
[0m18:02:29.192462 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7460ffaf0>]}
[0m18:02:29.193363 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m18:02:29.291883 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m18:02:29.669227 [info ] [MainThread]: Unable to do partial parsing because profile has changed
[0m18:02:29.669884 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7454a00d0>]}
[0m18:02:32.014912 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74a602b80>]}
[0m18:02:32.193725 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74ab78fa0>]}
[0m18:02:32.194524 [info ] [MainThread]: Found 2 models, 2 seeds, 4 data tests, 479 macros
[0m18:02:32.195063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74ac06940>]}
[0m18:02:32.196968 [info ] [MainThread]: 
[0m18:02:32.197777 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m18:02:32.204705 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m18:02:32.205657 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m18:02:35.542253 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now create_steam-outlet-209412_oscreditrisk)
[0m18:02:35.544880 [debug] [ThreadPool]: Creating schema "database: "steam-outlet-209412"
schema: "oscreditrisk"
"
[0m18:02:35.560450 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:02:35.561200 [debug] [ThreadPool]: On create_steam-outlet-209412_oscreditrisk: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "create_steam-outlet-209412_oscreditrisk"} */
create schema if not exists `steam-outlet-209412`.`oscreditrisk`
  
[0m18:02:36.508984 [debug] [ThreadPool]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:d54e1972-4355-4954-b1cb-1b1b05993754&page=queryresults
[0m18:02:38.281506 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly create_steam-outlet-209412_oscreditrisk, now list_steam-outlet-209412_oscreditrisk)
[0m18:02:38.282202 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m18:02:39.144926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74abf2f70>]}
[0m18:02:39.146017 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m18:02:39.146596 [info ] [MainThread]: 
[0m18:02:39.151322 [debug] [Thread-1  ]: Began running node seed.creditrisk.loans
[0m18:02:39.159950 [info ] [Thread-1  ]: 1 of 2 START seed file oscreditrisk.loans ...................................... [RUN]
[0m18:02:39.161054 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now seed.creditrisk.loans)
[0m18:02:39.161830 [debug] [Thread-1  ]: Began compiling node seed.creditrisk.loans
[0m18:02:39.162504 [debug] [Thread-1  ]: Began executing node seed.creditrisk.loans
[0m18:02:39.955661 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:02:44.562140 [debug] [Thread-1  ]: BigQuery adapter: Unhandled error while running:
LOAD TABLE
[0m18:02:44.563876 [debug] [Thread-1  ]: BigQuery adapter: Runtime Error
  Error while reading data, error message: CSV table encountered too many errors, giving up. Rows: 100; errors: 100. Please look into the errors[] collection for more details.
  Error while reading data, error message: CSV processing encountered too many errors, giving up. Rows: 100; errors: 100; max bad: 0; error percent: 0
  Error while reading data, error message: Unable to parse; line_number: 2 byte_offset_to_start_of_line: 93 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 3 byte_offset_to_start_of_line: 163 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 4 byte_offset_to_start_of_line: 233 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 5 byte_offset_to_start_of_line: 303 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 6 byte_offset_to_start_of_line: 373 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 7 byte_offset_to_start_of_line: 443 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 8 byte_offset_to_start_of_line: 513 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 9 byte_offset_to_start_of_line: 583 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 10 byte_offset_to_start_of_line: 653 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2846400.0"
  Error while reading data, error message: Unable to parse; line_number: 11 byte_offset_to_start_of_line: 723 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 12 byte_offset_to_start_of_line: 793 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 13 byte_offset_to_start_of_line: 863 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2855920.0"
  Error while reading data, error message: Unable to parse; line_number: 14 byte_offset_to_start_of_line: 933 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 15 byte_offset_to_start_of_line: 1003 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 16 byte_offset_to_start_of_line: 1073 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 17 byte_offset_to_start_of_line: 1143 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2573120.0"
  Error while reading data, error message: Unable to parse; line_number: 18 byte_offset_to_start_of_line: 1213 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2566400.0"
  Error while reading data, error message: Unable to parse; line_number: 19 byte_offset_to_start_of_line: 1283 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 20 byte_offset_to_start_of_line: 1353 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 21 byte_offset_to_start_of_line: 1423 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2846400.0"
  Error while reading data, error message: Unable to parse; line_number: 22 byte_offset_to_start_of_line: 1493 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 23 byte_offset_to_start_of_line: 1563 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2480000.0"
  Error while reading data, error message: Unable to parse; line_number: 24 byte_offset_to_start_of_line: 1638 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "4000000.0"
  Error while reading data, error message: Unable to parse; line_number: 25 byte_offset_to_start_of_line: 1708 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 26 byte_offset_to_start_of_line: 1778 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 27 byte_offset_to_start_of_line: 1848 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 28 byte_offset_to_start_of_line: 1918 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 29 byte_offset_to_start_of_line: 1988 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 30 byte_offset_to_start_of_line: 2058 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2480000.0"
  Error while reading data, error message: Unable to parse; line_number: 31 byte_offset_to_start_of_line: 2133 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 32 byte_offset_to_start_of_line: 2203 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 33 byte_offset_to_start_of_line: 2273 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2766400.0"
  Error while reading data, error message: Unable to parse; line_number: 34 byte_offset_to_start_of_line: 2343 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 35 byte_offset_to_start_of_line: 2413 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2711800.0"
  Error while reading data, error message: Unable to parse; line_number: 36 byte_offset_to_start_of_line: 2483 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2770600.0"
  Error while reading data, error message: Unable to parse; line_number: 37 byte_offset_to_start_of_line: 2553 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 38 byte_offset_to_start_of_line: 2623 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 39 byte_offset_to_start_of_line: 2693 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 40 byte_offset_to_start_of_line: 2763 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 41 byte_offset_to_start_of_line: 2833 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 42 byte_offset_to_start_of_line: 2908 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "1840000.0"
  Error while reading data, error message: Unable to parse; line_number: 43 byte_offset_to_start_of_line: 2983 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 44 byte_offset_to_start_of_line: 3053 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2770600.0"
  Error while reading data, error message: Unable to parse; line_number: 45 byte_offset_to_start_of_line: 3123 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 46 byte_offset_to_start_of_line: 3193 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 47 byte_offset_to_start_of_line: 3268 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 48 byte_offset_to_start_of_line: 3338 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 49 byte_offset_to_start_of_line: 3409 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 50 byte_offset_to_start_of_line: 3480 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2766400.0"
  Error while reading data, error message: Unable to parse; line_number: 51 byte_offset_to_start_of_line: 3551 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 52 byte_offset_to_start_of_line: 3622 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 53 byte_offset_to_start_of_line: 3693 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 54 byte_offset_to_start_of_line: 3769 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 55 byte_offset_to_start_of_line: 3840 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 56 byte_offset_to_start_of_line: 3911 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 57 byte_offset_to_start_of_line: 3982 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 58 byte_offset_to_start_of_line: 4053 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 59 byte_offset_to_start_of_line: 4124 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 60 byte_offset_to_start_of_line: 4195 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 61 byte_offset_to_start_of_line: 4265 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 62 byte_offset_to_start_of_line: 4335 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 63 byte_offset_to_start_of_line: 4405 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 64 byte_offset_to_start_of_line: 4475 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2774000.0"
  Error while reading data, error message: Unable to parse; line_number: 65 byte_offset_to_start_of_line: 4545 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 66 byte_offset_to_start_of_line: 4615 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 67 byte_offset_to_start_of_line: 4685 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 68 byte_offset_to_start_of_line: 4755 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 69 byte_offset_to_start_of_line: 4825 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 70 byte_offset_to_start_of_line: 4895 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 71 byte_offset_to_start_of_line: 4965 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 72 byte_offset_to_start_of_line: 5035 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 73 byte_offset_to_start_of_line: 5105 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 74 byte_offset_to_start_of_line: 5175 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 75 byte_offset_to_start_of_line: 5245 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 76 byte_offset_to_start_of_line: 5315 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 77 byte_offset_to_start_of_line: 5385 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 78 byte_offset_to_start_of_line: 5455 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 79 byte_offset_to_start_of_line: 5525 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 80 byte_offset_to_start_of_line: 5595 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 81 byte_offset_to_start_of_line: 5665 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 82 byte_offset_to_start_of_line: 5735 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 83 byte_offset_to_start_of_line: 5805 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 84 byte_offset_to_start_of_line: 5875 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 85 byte_offset_to_start_of_line: 5945 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 86 byte_offset_to_start_of_line: 6015 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 87 byte_offset_to_start_of_line: 6085 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 88 byte_offset_to_start_of_line: 6155 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 89 byte_offset_to_start_of_line: 6225 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 90 byte_offset_to_start_of_line: 6295 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 91 byte_offset_to_start_of_line: 6365 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2700800.0"
  Error while reading data, error message: Unable to parse; line_number: 92 byte_offset_to_start_of_line: 6435 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 93 byte_offset_to_start_of_line: 6505 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2712000.0"
  Error while reading data, error message: Unable to parse; line_number: 94 byte_offset_to_start_of_line: 6575 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 95 byte_offset_to_start_of_line: 6645 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 96 byte_offset_to_start_of_line: 6715 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 97 byte_offset_to_start_of_line: 6785 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2609200.0"
  Error while reading data, error message: Unable to parse; line_number: 98 byte_offset_to_start_of_line: 6855 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 99 byte_offset_to_start_of_line: 6925 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 100 byte_offset_to_start_of_line: 6995 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 101 byte_offset_to_start_of_line: 7065 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  You are loading data without specifying data format, data will be treated as CSV format by default. If this is not what you mean, please specify data format by --source_format.
[0m18:02:44.574678 [debug] [Thread-1  ]: Runtime Error in seed loans (seeds/loans.csv)
  Error while reading data, error message: CSV table encountered too many errors, giving up. Rows: 100; errors: 100. Please look into the errors[] collection for more details.
  Error while reading data, error message: CSV processing encountered too many errors, giving up. Rows: 100; errors: 100; max bad: 0; error percent: 0
  Error while reading data, error message: Unable to parse; line_number: 2 byte_offset_to_start_of_line: 93 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 3 byte_offset_to_start_of_line: 163 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 4 byte_offset_to_start_of_line: 233 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 5 byte_offset_to_start_of_line: 303 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 6 byte_offset_to_start_of_line: 373 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 7 byte_offset_to_start_of_line: 443 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 8 byte_offset_to_start_of_line: 513 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 9 byte_offset_to_start_of_line: 583 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 10 byte_offset_to_start_of_line: 653 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2846400.0"
  Error while reading data, error message: Unable to parse; line_number: 11 byte_offset_to_start_of_line: 723 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 12 byte_offset_to_start_of_line: 793 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 13 byte_offset_to_start_of_line: 863 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2855920.0"
  Error while reading data, error message: Unable to parse; line_number: 14 byte_offset_to_start_of_line: 933 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 15 byte_offset_to_start_of_line: 1003 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 16 byte_offset_to_start_of_line: 1073 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 17 byte_offset_to_start_of_line: 1143 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2573120.0"
  Error while reading data, error message: Unable to parse; line_number: 18 byte_offset_to_start_of_line: 1213 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2566400.0"
  Error while reading data, error message: Unable to parse; line_number: 19 byte_offset_to_start_of_line: 1283 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 20 byte_offset_to_start_of_line: 1353 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 21 byte_offset_to_start_of_line: 1423 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2846400.0"
  Error while reading data, error message: Unable to parse; line_number: 22 byte_offset_to_start_of_line: 1493 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 23 byte_offset_to_start_of_line: 1563 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2480000.0"
  Error while reading data, error message: Unable to parse; line_number: 24 byte_offset_to_start_of_line: 1638 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "4000000.0"
  Error while reading data, error message: Unable to parse; line_number: 25 byte_offset_to_start_of_line: 1708 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 26 byte_offset_to_start_of_line: 1778 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 27 byte_offset_to_start_of_line: 1848 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 28 byte_offset_to_start_of_line: 1918 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 29 byte_offset_to_start_of_line: 1988 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 30 byte_offset_to_start_of_line: 2058 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2480000.0"
  Error while reading data, error message: Unable to parse; line_number: 31 byte_offset_to_start_of_line: 2133 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 32 byte_offset_to_start_of_line: 2203 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 33 byte_offset_to_start_of_line: 2273 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2766400.0"
  Error while reading data, error message: Unable to parse; line_number: 34 byte_offset_to_start_of_line: 2343 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 35 byte_offset_to_start_of_line: 2413 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2711800.0"
  Error while reading data, error message: Unable to parse; line_number: 36 byte_offset_to_start_of_line: 2483 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2770600.0"
  Error while reading data, error message: Unable to parse; line_number: 37 byte_offset_to_start_of_line: 2553 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 38 byte_offset_to_start_of_line: 2623 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 39 byte_offset_to_start_of_line: 2693 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 40 byte_offset_to_start_of_line: 2763 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 41 byte_offset_to_start_of_line: 2833 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 42 byte_offset_to_start_of_line: 2908 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "1840000.0"
  Error while reading data, error message: Unable to parse; line_number: 43 byte_offset_to_start_of_line: 2983 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 44 byte_offset_to_start_of_line: 3053 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2770600.0"
  Error while reading data, error message: Unable to parse; line_number: 45 byte_offset_to_start_of_line: 3123 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 46 byte_offset_to_start_of_line: 3193 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 47 byte_offset_to_start_of_line: 3268 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 48 byte_offset_to_start_of_line: 3338 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 49 byte_offset_to_start_of_line: 3409 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 50 byte_offset_to_start_of_line: 3480 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2766400.0"
  Error while reading data, error message: Unable to parse; line_number: 51 byte_offset_to_start_of_line: 3551 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 52 byte_offset_to_start_of_line: 3622 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 53 byte_offset_to_start_of_line: 3693 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 54 byte_offset_to_start_of_line: 3769 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 55 byte_offset_to_start_of_line: 3840 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 56 byte_offset_to_start_of_line: 3911 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 57 byte_offset_to_start_of_line: 3982 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 58 byte_offset_to_start_of_line: 4053 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 59 byte_offset_to_start_of_line: 4124 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 60 byte_offset_to_start_of_line: 4195 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 61 byte_offset_to_start_of_line: 4265 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 62 byte_offset_to_start_of_line: 4335 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 63 byte_offset_to_start_of_line: 4405 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 64 byte_offset_to_start_of_line: 4475 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2774000.0"
  Error while reading data, error message: Unable to parse; line_number: 65 byte_offset_to_start_of_line: 4545 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 66 byte_offset_to_start_of_line: 4615 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 67 byte_offset_to_start_of_line: 4685 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 68 byte_offset_to_start_of_line: 4755 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 69 byte_offset_to_start_of_line: 4825 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 70 byte_offset_to_start_of_line: 4895 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 71 byte_offset_to_start_of_line: 4965 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 72 byte_offset_to_start_of_line: 5035 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 73 byte_offset_to_start_of_line: 5105 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 74 byte_offset_to_start_of_line: 5175 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 75 byte_offset_to_start_of_line: 5245 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 76 byte_offset_to_start_of_line: 5315 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 77 byte_offset_to_start_of_line: 5385 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 78 byte_offset_to_start_of_line: 5455 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 79 byte_offset_to_start_of_line: 5525 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 80 byte_offset_to_start_of_line: 5595 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 81 byte_offset_to_start_of_line: 5665 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 82 byte_offset_to_start_of_line: 5735 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 83 byte_offset_to_start_of_line: 5805 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 84 byte_offset_to_start_of_line: 5875 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 85 byte_offset_to_start_of_line: 5945 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 86 byte_offset_to_start_of_line: 6015 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 87 byte_offset_to_start_of_line: 6085 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 88 byte_offset_to_start_of_line: 6155 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 89 byte_offset_to_start_of_line: 6225 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 90 byte_offset_to_start_of_line: 6295 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 91 byte_offset_to_start_of_line: 6365 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2700800.0"
  Error while reading data, error message: Unable to parse; line_number: 92 byte_offset_to_start_of_line: 6435 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 93 byte_offset_to_start_of_line: 6505 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2712000.0"
  Error while reading data, error message: Unable to parse; line_number: 94 byte_offset_to_start_of_line: 6575 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 95 byte_offset_to_start_of_line: 6645 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 96 byte_offset_to_start_of_line: 6715 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 97 byte_offset_to_start_of_line: 6785 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2609200.0"
  Error while reading data, error message: Unable to parse; line_number: 98 byte_offset_to_start_of_line: 6855 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 99 byte_offset_to_start_of_line: 6925 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 100 byte_offset_to_start_of_line: 6995 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 101 byte_offset_to_start_of_line: 7065 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  You are loading data without specifying data format, data will be treated as CSV format by default. If this is not what you mean, please specify data format by --source_format.
[0m18:02:44.578048 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74394d670>]}
[0m18:02:44.580609 [error] [Thread-1  ]: 1 of 2 ERROR loading seed file oscreditrisk.loans .............................. [[31mERROR[0m in 5.42s]
[0m18:02:44.583428 [debug] [Thread-1  ]: Finished running node seed.creditrisk.loans
[0m18:02:44.584227 [debug] [Thread-1  ]: Began running node seed.creditrisk.payments
[0m18:02:44.585300 [info ] [Thread-1  ]: 2 of 2 START seed file oscreditrisk.payments ................................... [RUN]
[0m18:02:44.586371 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly seed.creditrisk.loans, now seed.creditrisk.payments)
[0m18:02:44.587236 [debug] [Thread-1  ]: Began compiling node seed.creditrisk.payments
[0m18:02:44.587867 [debug] [Thread-1  ]: Began executing node seed.creditrisk.payments
[0m18:02:49.333528 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m18:03:05.611714 [debug] [Thread-1  ]: On seed.creditrisk.payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "seed.creditrisk.payments"} */

    alter table `steam-outlet-209412`.`oscreditrisk`.`payments` set OPTIONS()
  
[0m18:03:06.037936 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:9ea9dd2c-7614-4d86-a24d-2d3a4bdfcbf6&page=queryresults
[0m18:03:06.666537 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.creditrisk.payments"
[0m18:03:06.692781 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'bdb00794-8a55-4dac-b439-3d72c6dc85bb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd7454d66d0>]}
[0m18:03:06.693608 [info ] [Thread-1  ]: 2 of 2 OK loaded seed file oscreditrisk.payments ............................... [[32mINSERT 149506[0m in 22.11s]
[0m18:03:06.694539 [debug] [Thread-1  ]: Finished running node seed.creditrisk.payments
[0m18:03:06.696087 [debug] [MainThread]: Connection 'master' was properly closed.
[0m18:03:06.696571 [debug] [MainThread]: Connection 'seed.creditrisk.payments' was properly closed.
[0m18:03:06.697104 [info ] [MainThread]: 
[0m18:03:06.697695 [info ] [MainThread]: Finished running 2 seeds in 0 hours 0 minutes and 34.50 seconds (34.50s).
[0m18:03:06.700087 [debug] [MainThread]: Command end result
[0m18:03:06.754629 [info ] [MainThread]: 
[0m18:03:06.755359 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m18:03:06.755860 [info ] [MainThread]: 
[0m18:03:06.757500 [error] [MainThread]:   Runtime Error in seed loans (seeds/loans.csv)
  Error while reading data, error message: CSV table encountered too many errors, giving up. Rows: 100; errors: 100. Please look into the errors[] collection for more details.
  Error while reading data, error message: CSV processing encountered too many errors, giving up. Rows: 100; errors: 100; max bad: 0; error percent: 0
  Error while reading data, error message: Unable to parse; line_number: 2 byte_offset_to_start_of_line: 93 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 3 byte_offset_to_start_of_line: 163 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 4 byte_offset_to_start_of_line: 233 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 5 byte_offset_to_start_of_line: 303 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 6 byte_offset_to_start_of_line: 373 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 7 byte_offset_to_start_of_line: 443 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 8 byte_offset_to_start_of_line: 513 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 9 byte_offset_to_start_of_line: 583 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 10 byte_offset_to_start_of_line: 653 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2846400.0"
  Error while reading data, error message: Unable to parse; line_number: 11 byte_offset_to_start_of_line: 723 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 12 byte_offset_to_start_of_line: 793 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 13 byte_offset_to_start_of_line: 863 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2855920.0"
  Error while reading data, error message: Unable to parse; line_number: 14 byte_offset_to_start_of_line: 933 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 15 byte_offset_to_start_of_line: 1003 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 16 byte_offset_to_start_of_line: 1073 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 17 byte_offset_to_start_of_line: 1143 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2573120.0"
  Error while reading data, error message: Unable to parse; line_number: 18 byte_offset_to_start_of_line: 1213 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2566400.0"
  Error while reading data, error message: Unable to parse; line_number: 19 byte_offset_to_start_of_line: 1283 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 20 byte_offset_to_start_of_line: 1353 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 21 byte_offset_to_start_of_line: 1423 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2846400.0"
  Error while reading data, error message: Unable to parse; line_number: 22 byte_offset_to_start_of_line: 1493 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 23 byte_offset_to_start_of_line: 1563 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2480000.0"
  Error while reading data, error message: Unable to parse; line_number: 24 byte_offset_to_start_of_line: 1638 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "4000000.0"
  Error while reading data, error message: Unable to parse; line_number: 25 byte_offset_to_start_of_line: 1708 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 26 byte_offset_to_start_of_line: 1778 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 27 byte_offset_to_start_of_line: 1848 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 28 byte_offset_to_start_of_line: 1918 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 29 byte_offset_to_start_of_line: 1988 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 30 byte_offset_to_start_of_line: 2058 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2480000.0"
  Error while reading data, error message: Unable to parse; line_number: 31 byte_offset_to_start_of_line: 2133 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 32 byte_offset_to_start_of_line: 2203 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 33 byte_offset_to_start_of_line: 2273 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2766400.0"
  Error while reading data, error message: Unable to parse; line_number: 34 byte_offset_to_start_of_line: 2343 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 35 byte_offset_to_start_of_line: 2413 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2711800.0"
  Error while reading data, error message: Unable to parse; line_number: 36 byte_offset_to_start_of_line: 2483 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2770600.0"
  Error while reading data, error message: Unable to parse; line_number: 37 byte_offset_to_start_of_line: 2553 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 38 byte_offset_to_start_of_line: 2623 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 39 byte_offset_to_start_of_line: 2693 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 40 byte_offset_to_start_of_line: 2763 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 41 byte_offset_to_start_of_line: 2833 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 42 byte_offset_to_start_of_line: 2908 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "1840000.0"
  Error while reading data, error message: Unable to parse; line_number: 43 byte_offset_to_start_of_line: 2983 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 44 byte_offset_to_start_of_line: 3053 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2770600.0"
  Error while reading data, error message: Unable to parse; line_number: 45 byte_offset_to_start_of_line: 3123 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 46 byte_offset_to_start_of_line: 3193 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 47 byte_offset_to_start_of_line: 3268 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 48 byte_offset_to_start_of_line: 3338 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 49 byte_offset_to_start_of_line: 3409 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 50 byte_offset_to_start_of_line: 3480 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2766400.0"
  Error while reading data, error message: Unable to parse; line_number: 51 byte_offset_to_start_of_line: 3551 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 52 byte_offset_to_start_of_line: 3622 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 53 byte_offset_to_start_of_line: 3693 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2240000.0"
  Error while reading data, error message: Unable to parse; line_number: 54 byte_offset_to_start_of_line: 3769 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 55 byte_offset_to_start_of_line: 3840 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 56 byte_offset_to_start_of_line: 3911 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 57 byte_offset_to_start_of_line: 3982 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 58 byte_offset_to_start_of_line: 4053 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 59 byte_offset_to_start_of_line: 4124 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2800000.0"
  Error while reading data, error message: Unable to parse; line_number: 60 byte_offset_to_start_of_line: 4195 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 61 byte_offset_to_start_of_line: 4265 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 62 byte_offset_to_start_of_line: 4335 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 63 byte_offset_to_start_of_line: 4405 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 64 byte_offset_to_start_of_line: 4475 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2774000.0"
  Error while reading data, error message: Unable to parse; line_number: 65 byte_offset_to_start_of_line: 4545 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 66 byte_offset_to_start_of_line: 4615 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 67 byte_offset_to_start_of_line: 4685 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 68 byte_offset_to_start_of_line: 4755 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 69 byte_offset_to_start_of_line: 4825 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 70 byte_offset_to_start_of_line: 4895 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 71 byte_offset_to_start_of_line: 4965 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 72 byte_offset_to_start_of_line: 5035 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 73 byte_offset_to_start_of_line: 5105 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 74 byte_offset_to_start_of_line: 5175 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 75 byte_offset_to_start_of_line: 5245 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 76 byte_offset_to_start_of_line: 5315 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 77 byte_offset_to_start_of_line: 5385 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 78 byte_offset_to_start_of_line: 5455 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 79 byte_offset_to_start_of_line: 5525 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 80 byte_offset_to_start_of_line: 5595 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 81 byte_offset_to_start_of_line: 5665 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 82 byte_offset_to_start_of_line: 5735 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 83 byte_offset_to_start_of_line: 5805 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 84 byte_offset_to_start_of_line: 5875 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 85 byte_offset_to_start_of_line: 5945 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 86 byte_offset_to_start_of_line: 6015 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 87 byte_offset_to_start_of_line: 6085 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 88 byte_offset_to_start_of_line: 6155 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 89 byte_offset_to_start_of_line: 6225 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 90 byte_offset_to_start_of_line: 6295 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 91 byte_offset_to_start_of_line: 6365 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2700800.0"
  Error while reading data, error message: Unable to parse; line_number: 92 byte_offset_to_start_of_line: 6435 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 93 byte_offset_to_start_of_line: 6505 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2712000.0"
  Error while reading data, error message: Unable to parse; line_number: 94 byte_offset_to_start_of_line: 6575 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 95 byte_offset_to_start_of_line: 6645 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 96 byte_offset_to_start_of_line: 6715 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 97 byte_offset_to_start_of_line: 6785 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2609200.0"
  Error while reading data, error message: Unable to parse; line_number: 98 byte_offset_to_start_of_line: 6855 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2852000.0"
  Error while reading data, error message: Unable to parse; line_number: 99 byte_offset_to_start_of_line: 6925 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 100 byte_offset_to_start_of_line: 6995 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  Error while reading data, error message: Unable to parse; line_number: 101 byte_offset_to_start_of_line: 7065 column_index: 2 column_name: "unlock_price" column_type: INT64 value: "2880000.0"
  You are loading data without specifying data format, data will be treated as CSV format by default. If this is not what you mean, please specify data format by --source_format.
[0m18:03:06.760566 [info ] [MainThread]: 
[0m18:03:06.761161 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m18:03:06.762033 [debug] [MainThread]: Resource report: {"command_name": "seed", "command_wall_clock_time": 43.006104, "process_user_time": 12.705898, "process_kernel_time": 1.444183, "process_mem_max_rss": "386936832", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m18:03:06.762870 [debug] [MainThread]: Command `dbt seed` failed at 18:03:06.762714 after 43.01 seconds
[0m18:03:06.763467 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74422f5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd745b408e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd74b381e50>]}
[0m18:03:06.764102 [debug] [MainThread]: Flushing usage events
[0m20:08:12.573220 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff281260520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff283270d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff283270070>]}


============================== 20:08:12.579030 | 799c7073-d101-4612-b7d0-1324516ac387 ==============================
[0m20:08:12.579030 [info ] [MainThread]: Running with dbt=1.8.8
[0m20:08:12.580029 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'target_path': 'None', 'introspect': 'True', 'empty': 'None', 'profiles_dir': '/Users/david/.dbt', 'log_cache_events': 'False', 'fail_fast': 'False', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'partial_parse': 'True', 'log_format': 'default', 'quiet': 'False', 'static_parser': 'True', 'use_experimental_parser': 'False', 'warn_error': 'None', 'use_colors': 'True', 'invocation_command': 'dbt seed', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'debug': 'False', 'version_check': 'True', 'printer_width': '80', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs'}
[0m20:08:17.903043 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff286e88520>]}
[0m20:08:17.985055 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff286dd7eb0>]}
[0m20:08:17.986024 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m20:08:18.025890 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m20:08:18.422527 [debug] [MainThread]: Partial parsing enabled: 2 files deleted, 2 files added, 0 files changed.
[0m20:08:18.423702 [debug] [MainThread]: Partial parsing: added file: creditrisk://seeds/raw_payments.csv
[0m20:08:18.424481 [debug] [MainThread]: Partial parsing: added file: creditrisk://seeds/raw_accounts.csv
[0m20:08:18.425008 [debug] [MainThread]: Partial parsing: deleted file: creditrisk://seeds/payments.csv
[0m20:08:18.425471 [debug] [MainThread]: Partial parsing: deleted file: creditrisk://seeds/loans.csv
[0m20:08:18.782708 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff287a51130>]}
[0m20:08:19.038649 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff287a73fa0>]}
[0m20:08:19.039492 [info ] [MainThread]: Found 2 models, 4 data tests, 2 seeds, 479 macros
[0m20:08:19.040070 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff287a6f460>]}
[0m20:08:19.042110 [info ] [MainThread]: 
[0m20:08:19.043154 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:08:19.051375 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m20:08:19.052323 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:08:22.551587 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m20:08:22.553316 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:08:23.168559 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2811edbb0>]}
[0m20:08:23.169663 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:08:23.170264 [info ] [MainThread]: 
[0m20:08:23.175720 [debug] [Thread-1  ]: Began running node seed.creditrisk.raw_accounts
[0m20:08:23.176809 [info ] [Thread-1  ]: 1 of 2 START seed file oscreditrisk.raw_accounts ............................... [RUN]
[0m20:08:23.177651 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now seed.creditrisk.raw_accounts)
[0m20:08:23.178291 [debug] [Thread-1  ]: Began compiling node seed.creditrisk.raw_accounts
[0m20:08:23.178936 [debug] [Thread-1  ]: Began executing node seed.creditrisk.raw_accounts
[0m20:08:23.620960 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:08:29.520718 [debug] [Thread-1  ]: On seed.creditrisk.raw_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "seed.creditrisk.raw_accounts"} */

    alter table `steam-outlet-209412`.`oscreditrisk`.`raw_accounts` set OPTIONS()
  
[0m20:08:30.413515 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:a5c0a6e8-f6b7-44f7-aab4-d591c2d67197&page=queryresults
[0m20:08:31.209568 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.creditrisk.raw_accounts"
[0m20:08:31.236883 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff282378cd0>]}
[0m20:08:31.238514 [info ] [Thread-1  ]: 1 of 2 OK loaded seed file oscreditrisk.raw_accounts ........................... [[32mINSERT 6201[0m in 8.06s]
[0m20:08:31.239559 [debug] [Thread-1  ]: Finished running node seed.creditrisk.raw_accounts
[0m20:08:31.240696 [debug] [Thread-1  ]: Began running node seed.creditrisk.raw_payments
[0m20:08:31.241567 [info ] [Thread-1  ]: 2 of 2 START seed file oscreditrisk.raw_payments ............................... [RUN]
[0m20:08:31.242283 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly seed.creditrisk.raw_accounts, now seed.creditrisk.raw_payments)
[0m20:08:31.242875 [debug] [Thread-1  ]: Began compiling node seed.creditrisk.raw_payments
[0m20:08:31.243454 [debug] [Thread-1  ]: Began executing node seed.creditrisk.raw_payments
[0m20:08:36.087519 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:08:43.402195 [debug] [Thread-1  ]: On seed.creditrisk.raw_payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "seed.creditrisk.raw_payments"} */

    alter table `steam-outlet-209412`.`oscreditrisk`.`raw_payments` set OPTIONS()
  
[0m20:08:43.804443 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:437a38eb-24ad-4f5f-a031-ead78462b18d&page=queryresults
[0m20:08:44.526451 [debug] [Thread-1  ]: Writing runtime SQL for node "seed.creditrisk.raw_payments"
[0m20:08:44.529892 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '799c7073-d101-4612-b7d0-1324516ac387', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2811dde20>]}
[0m20:08:44.530672 [info ] [Thread-1  ]: 2 of 2 OK loaded seed file oscreditrisk.raw_payments ........................... [[32mINSERT 149506[0m in 13.29s]
[0m20:08:44.531598 [debug] [Thread-1  ]: Finished running node seed.creditrisk.raw_payments
[0m20:08:44.533195 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:08:44.533678 [debug] [MainThread]: Connection 'seed.creditrisk.raw_payments' was properly closed.
[0m20:08:44.534228 [info ] [MainThread]: 
[0m20:08:44.534820 [info ] [MainThread]: Finished running 2 seeds in 0 hours 0 minutes and 25.49 seconds (25.49s).
[0m20:08:44.536115 [debug] [MainThread]: Command end result
[0m20:08:44.591672 [info ] [MainThread]: 
[0m20:08:44.592650 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:08:44.593272 [info ] [MainThread]: 
[0m20:08:44.593914 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m20:08:44.594782 [debug] [MainThread]: Resource report: {"command_name": "seed", "command_success": true, "command_wall_clock_time": 32.12951, "process_user_time": 11.036833, "process_kernel_time": 1.422405, "process_mem_max_rss": "392900608", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:08:44.595758 [debug] [MainThread]: Command `dbt seed` succeeded at 20:08:44.595586 after 32.13 seconds
[0m20:08:44.596401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff281260520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff282a30760>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff287a73df0>]}
[0m20:08:44.596993 [debug] [MainThread]: Flushing usage events
[0m20:10:48.502916 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8098932520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f809b3afa90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f809b3af340>]}


============================== 20:10:48.508449 | f6524df1-b145-4131-91a6-fa3b92aaedbe ==============================
[0m20:10:48.508449 [info ] [MainThread]: Running with dbt=1.8.8
[0m20:10:48.509382 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'use_colors': 'True', 'printer_width': '80', 'fail_fast': 'False', 'warn_error': 'None', 'cache_selected_only': 'False', 'invocation_command': 'dbt run --select cleaned_accounts', 'static_parser': 'True', 'quiet': 'False', 'profiles_dir': '/Users/david/.dbt', 'log_cache_events': 'False', 'partial_parse': 'True', 'target_path': 'None', 'empty': 'False', 'no_print': 'None', 'write_json': 'True', 'introspect': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'version_check': 'True', 'use_experimental_parser': 'False', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True', 'debug': 'False'}
[0m20:10:52.966530 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f6524df1-b145-4131-91a6-fa3b92aaedbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f809ed84fd0>]}
[0m20:10:53.044254 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f6524df1-b145-4131-91a6-fa3b92aaedbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f809ecd9fa0>]}
[0m20:10:53.045245 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m20:10:53.080601 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m20:10:53.440875 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m20:10:53.441688 [debug] [MainThread]: Partial parsing: added file: creditrisk://models/example/1. cleaning/cleaned_accounts.sql
[0m20:10:53.800452 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f6524df1-b145-4131-91a6-fa3b92aaedbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f80a02c5130>]}
[0m20:10:53.979357 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f6524df1-b145-4131-91a6-fa3b92aaedbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f80a02c4eb0>]}
[0m20:10:53.980157 [info ] [MainThread]: Found 3 models, 4 data tests, 2 seeds, 479 macros
[0m20:10:53.980721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6524df1-b145-4131-91a6-fa3b92aaedbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f80a0404070>]}
[0m20:10:53.982315 [info ] [MainThread]: 
[0m20:10:53.983130 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:10:53.984327 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m20:10:53.984955 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:10:57.027874 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m20:10:57.029583 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:10:57.724534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6524df1-b145-4131-91a6-fa3b92aaedbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f80988bfbb0>]}
[0m20:10:57.725586 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:10:57.726169 [info ] [MainThread]: 
[0m20:10:57.729919 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m20:10:57.730793 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m20:10:57.731627 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m20:10:57.732289 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m20:10:57.746996 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m20:10:57.748724 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m20:10:57.805296 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m20:10:57.806686 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:10:57.807412 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as WITH accounts as (
    `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date AS TIMESTAMP) as registration_date, 
  CAST(unlock_price AS FLOAT) as unlock_price, 
  CAST(down_payment AS FLOAT) as down_payment, 
  CAST(down_payment_days_included AS FLOAT) as down_payment_days_included, 
  CAST(daily_rate AS FLOAT) as daily_rate, 
FROM accounts;


[0m20:10:58.956193 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:8741498a-aff5-4820-85af-b013687e07ba&page=queryresults
[0m20:10:58.977293 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]; reason: invalidQuery, location: query, message: Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]')
[0m20:11:00.012577 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:1c150bb9-df65-4ac3-8664-7177f7438d46&page=queryresults
[0m20:11:00.013514 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:1c150bb9-df65-4ac3-8664-7177f7438d46&page=queryresults
[0m20:11:00.028561 [debug] [Thread-1  ]: Database Error in model cleaned_accounts (models/example/1. cleaning/cleaned_accounts.sql)
  Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]
  compiled code at target/run/creditrisk/models/example/1. cleaning/cleaned_accounts.sql
[0m20:11:00.030979 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6524df1-b145-4131-91a6-fa3b92aaedbe', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f80a0a29940>]}
[0m20:11:00.033057 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.cleaned_accounts ............. [[31mERROR[0m in 2.30s]
[0m20:11:00.034115 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m20:11:00.035872 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:11:00.036372 [debug] [MainThread]: Connection 'model.creditrisk.cleaned_accounts' was properly closed.
[0m20:11:00.036874 [info ] [MainThread]: 
[0m20:11:00.037412 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 6.05 seconds (6.05s).
[0m20:11:00.038557 [debug] [MainThread]: Command end result
[0m20:11:00.090512 [info ] [MainThread]: 
[0m20:11:00.091305 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:11:00.091822 [info ] [MainThread]: 
[0m20:11:00.092471 [error] [MainThread]:   Database Error in model cleaned_accounts (models/example/1. cleaning/cleaned_accounts.sql)
  Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]
  compiled code at target/run/creditrisk/models/example/1. cleaning/cleaned_accounts.sql
[0m20:11:00.093125 [info ] [MainThread]: 
[0m20:11:00.093812 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:11:00.095252 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 11.686525, "process_user_time": 5.70933, "process_kernel_time": 1.083614, "process_mem_max_rss": "229711872", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:11:00.096426 [debug] [MainThread]: Command `dbt run` failed at 20:11:00.096232 after 11.69 seconds
[0m20:11:00.097297 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8098932520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8098e87670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f80a0404070>]}
[0m20:11:00.098459 [debug] [MainThread]: Flushing usage events
[0m20:14:01.018401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8daa32580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8dc9b0be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8dc9b0190>]}


============================== 20:14:01.026870 | 05b84beb-7cfc-442a-b60d-6d0c31ced306 ==============================
[0m20:14:01.026870 [info ] [MainThread]: Running with dbt=1.8.8
[0m20:14:01.028206 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'fail_fast': 'False', 'warn_error': 'None', 'quiet': 'False', 'invocation_command': 'dbt run --select cleaned_accounts', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'introspect': 'True', 'write_json': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'printer_width': '80', 'empty': 'False', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'log_format': 'default', 'static_parser': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'target_path': 'None', 'indirect_selection': 'eager', 'profiles_dir': '/Users/david/.dbt', 'use_experimental_parser': 'False'}
[0m20:14:06.871276 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '05b84beb-7cfc-442a-b60d-6d0c31ced306', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e0488f70>]}
[0m20:14:06.967066 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '05b84beb-7cfc-442a-b60d-6d0c31ced306', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e0b9b280>]}
[0m20:14:06.968029 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m20:14:07.008188 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m20:14:07.386114 [debug] [MainThread]: Partial parsing enabled: 1 files deleted, 1 files added, 0 files changed.
[0m20:14:07.386900 [debug] [MainThread]: Partial parsing: added file: creditrisk://models/example/0_cleaning/cleaned_accounts.sql
[0m20:14:07.387383 [debug] [MainThread]: Partial parsing: deleted file: creditrisk://models/example/1. cleaning/cleaned_accounts.sql
[0m20:14:07.766509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '05b84beb-7cfc-442a-b60d-6d0c31ced306', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e0fc8130>]}
[0m20:14:07.966615 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '05b84beb-7cfc-442a-b60d-6d0c31ced306', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e0fd8100>]}
[0m20:14:07.967508 [info ] [MainThread]: Found 3 models, 4 data tests, 2 seeds, 479 macros
[0m20:14:07.968223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05b84beb-7cfc-442a-b60d-6d0c31ced306', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8daf06bb0>]}
[0m20:14:07.970166 [info ] [MainThread]: 
[0m20:14:07.971138 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:14:07.972422 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m20:14:07.973084 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:14:11.695281 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m20:14:11.696317 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:14:12.326898 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '05b84beb-7cfc-442a-b60d-6d0c31ced306', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e1006040>]}
[0m20:14:12.327957 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:14:12.328531 [info ] [MainThread]: 
[0m20:14:12.332242 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m20:14:12.333090 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m20:14:12.334120 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m20:14:12.334808 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m20:14:12.350923 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m20:14:12.352326 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m20:14:12.410374 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m20:14:12.411594 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:14:12.412330 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as WITH accounts as (
    `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)   as registration_date, 
  CAST(unlock_price                 AS FLOAT)       as unlock_price, 
  CAST(down_payment                 AS FLOAT)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT)       as daily_rate, 
FROM accounts;


[0m20:14:13.049776 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:d63f8d0c-a3a9-4867-8ce1-66404f4d1944&page=queryresults
[0m20:14:13.051082 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]; reason: invalidQuery, location: query, message: Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]')
[0m20:14:13.709778 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:881f5b9f-9509-411f-a331-2b5d4748c8e2&page=queryresults
[0m20:14:13.715962 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:881f5b9f-9509-411f-a331-2b5d4748c8e2&page=queryresults
[0m20:14:13.819967 [debug] [Thread-1  ]: Database Error in model cleaned_accounts (models/example/0_cleaning/cleaned_accounts.sql)
  Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]
  compiled code at target/run/creditrisk/models/example/0_cleaning/cleaned_accounts.sql
[0m20:14:13.831686 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '05b84beb-7cfc-442a-b60d-6d0c31ced306', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e10075b0>]}
[0m20:14:13.835693 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.cleaned_accounts ............. [[31mERROR[0m in 1.49s]
[0m20:14:13.839892 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m20:14:13.851107 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:14:13.852859 [debug] [MainThread]: Connection 'model.creditrisk.cleaned_accounts' was properly closed.
[0m20:14:13.856332 [info ] [MainThread]: 
[0m20:14:13.860869 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 5.89 seconds (5.89s).
[0m20:14:13.865527 [debug] [MainThread]: Command end result
[0m20:14:14.017957 [info ] [MainThread]: 
[0m20:14:14.036593 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:14:14.056754 [info ] [MainThread]: 
[0m20:14:14.059011 [error] [MainThread]:   Database Error in model cleaned_accounts (models/example/0_cleaning/cleaned_accounts.sql)
  Syntax error: Unexpected identifier `steam-outlet-209412` at [7:5]
  compiled code at target/run/creditrisk/models/example/0_cleaning/cleaned_accounts.sql
[0m20:14:14.078449 [info ] [MainThread]: 
[0m20:14:14.079818 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:14:14.081366 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 13.185333, "process_user_time": 6.85866, "process_kernel_time": 1.456666, "process_mem_max_rss": "229117952", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:14:14.083029 [debug] [MainThread]: Command `dbt run` failed at 20:14:14.082735 after 13.19 seconds
[0m20:14:14.083927 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8daa32580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e0b83910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc8e10040a0>]}
[0m20:14:14.084742 [debug] [MainThread]: Flushing usage events
[0m20:15:25.214274 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b6aa24580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b6cbfd430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b6cbfde80>]}


============================== 20:15:25.219594 | 63984358-e7e3-431e-be71-91ca10404428 ==============================
[0m20:15:25.219594 [info ] [MainThread]: Running with dbt=1.8.8
[0m20:15:25.220589 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'empty': 'False', 'invocation_command': 'dbt run --select cleaned_accounts', 'profiles_dir': '/Users/david/.dbt', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'use_experimental_parser': 'False', 'version_check': 'True', 'log_format': 'default', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'target_path': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'use_colors': 'True', 'quiet': 'False', 'partial_parse': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'no_print': 'None', 'static_parser': 'True', 'cache_selected_only': 'False', 'introspect': 'True', 'write_json': 'True'}
[0m20:15:29.556527 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '63984358-e7e3-431e-be71-91ca10404428', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b7046dee0>]}
[0m20:15:29.630638 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '63984358-e7e3-431e-be71-91ca10404428', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b703bfd30>]}
[0m20:15:29.631540 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m20:15:29.664455 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m20:15:29.992168 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:15:29.992749 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:15:30.074164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '63984358-e7e3-431e-be71-91ca10404428', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b7115eee0>]}
[0m20:15:30.294128 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '63984358-e7e3-431e-be71-91ca10404428', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b7116e6d0>]}
[0m20:15:30.329697 [info ] [MainThread]: Found 3 models, 4 data tests, 2 seeds, 479 macros
[0m20:15:30.330378 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '63984358-e7e3-431e-be71-91ca10404428', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b7116bb20>]}
[0m20:15:30.331984 [info ] [MainThread]: 
[0m20:15:30.332830 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:15:30.334177 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m20:15:30.334899 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:15:33.406895 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m20:15:33.408122 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:15:34.084830 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '63984358-e7e3-431e-be71-91ca10404428', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b703fac70>]}
[0m20:15:34.085891 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:15:34.086456 [info ] [MainThread]: 
[0m20:15:34.090002 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m20:15:34.090835 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m20:15:34.091646 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m20:15:34.092304 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m20:15:34.116327 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m20:15:34.117721 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m20:15:34.163988 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m20:15:34.165177 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:15:34.166007 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)   as registration_date, 
  CAST(unlock_price                 AS FLOAT)       as unlock_price, 
  CAST(down_payment                 AS FLOAT)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT)       as daily_rate, 
FROM accounts;


[0m20:15:34.894904 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:aeb018c3-fed8-4b55-ade2-e589f547c8e0&page=queryresults
[0m20:15:35.234265 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Type not found: FLOAT at [13:40]; reason: invalidQuery, location: query, message: Type not found: FLOAT at [13:40]')
[0m20:15:36.988754 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b3ffc83a-e8b9-4ef7-b547-1f779fc54a1a&page=queryresults
[0m20:15:37.274464 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b3ffc83a-e8b9-4ef7-b547-1f779fc54a1a&page=queryresults
[0m20:15:37.289119 [debug] [Thread-1  ]: Database Error in model cleaned_accounts (models/example/0_cleaning/cleaned_accounts.sql)
  Type not found: FLOAT at [13:40]
  compiled code at target/run/creditrisk/models/example/0_cleaning/cleaned_accounts.sql
[0m20:15:37.291435 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '63984358-e7e3-431e-be71-91ca10404428', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b71813970>]}
[0m20:15:37.292470 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.cleaned_accounts ............. [[31mERROR[0m in 3.20s]
[0m20:15:37.294086 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m20:15:37.296242 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:15:37.296862 [debug] [MainThread]: Connection 'model.creditrisk.cleaned_accounts' was properly closed.
[0m20:15:37.297388 [info ] [MainThread]: 
[0m20:15:37.297992 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 6.96 seconds (6.96s).
[0m20:15:37.299566 [debug] [MainThread]: Command end result
[0m20:15:37.359437 [info ] [MainThread]: 
[0m20:15:37.360223 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m20:15:37.360740 [info ] [MainThread]: 
[0m20:15:37.361379 [error] [MainThread]:   Database Error in model cleaned_accounts (models/example/0_cleaning/cleaned_accounts.sql)
  Type not found: FLOAT at [13:40]
  compiled code at target/run/creditrisk/models/example/0_cleaning/cleaned_accounts.sql
[0m20:15:37.362182 [info ] [MainThread]: 
[0m20:15:37.362830 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m20:15:37.363770 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 12.247308, "process_user_time": 5.542869, "process_kernel_time": 1.025964, "process_mem_max_rss": "226476032", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:15:37.364868 [debug] [MainThread]: Command `dbt run` failed at 20:15:37.364684 after 12.25 seconds
[0m20:15:37.365623 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b6aa24580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b6ad21d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8b70e0bc70>]}
[0m20:15:37.366479 [debug] [MainThread]: Flushing usage events
[0m20:17:03.698509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d66a33520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d68938a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d68938340>]}


============================== 20:17:03.703824 | 5140bb9f-51c0-4b03-b4fa-6139912c30d3 ==============================
[0m20:17:03.703824 [info ] [MainThread]: Running with dbt=1.8.8
[0m20:17:03.705032 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'invocation_command': 'dbt run --select cleaned_accounts', 'log_cache_events': 'False', 'write_json': 'True', 'introspect': 'True', 'indirect_selection': 'eager', 'profiles_dir': '/Users/david/.dbt', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'printer_width': '80', 'quiet': 'False', 'no_print': 'None', 'use_experimental_parser': 'False', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'cache_selected_only': 'False', 'version_check': 'True', 'partial_parse': 'True', 'log_format': 'default', 'use_colors': 'True', 'static_parser': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'target_path': 'None'}
[0m20:17:08.381129 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '5140bb9f-51c0-4b03-b4fa-6139912c30d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d6c596b20>]}
[0m20:17:08.479027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '5140bb9f-51c0-4b03-b4fa-6139912c30d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d688f90d0>]}
[0m20:17:08.480015 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m20:17:08.509981 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m20:17:08.861685 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:17:08.862376 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:17:08.952156 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '5140bb9f-51c0-4b03-b4fa-6139912c30d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d6d160130>]}
[0m20:17:09.140624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '5140bb9f-51c0-4b03-b4fa-6139912c30d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d6d16ea60>]}
[0m20:17:09.141616 [info ] [MainThread]: Found 4 models, 4 data tests, 2 seeds, 479 macros
[0m20:17:09.142293 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5140bb9f-51c0-4b03-b4fa-6139912c30d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d6d12e370>]}
[0m20:17:09.144003 [info ] [MainThread]: 
[0m20:17:09.145039 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:17:09.146411 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m20:17:09.147593 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:17:12.220572 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m20:17:12.222048 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:17:12.811613 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '5140bb9f-51c0-4b03-b4fa-6139912c30d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d687cfa60>]}
[0m20:17:12.812706 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:17:12.813284 [info ] [MainThread]: 
[0m20:17:12.817392 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m20:17:12.818255 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m20:17:12.819274 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m20:17:12.820169 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m20:17:13.289581 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m20:17:13.291590 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m20:17:13.336560 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m20:17:13.337659 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:17:13.338366 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)     as registration_date, 
  CAST(unlock_price                 AS FLOAT64)       as unlock_price, 
  CAST(down_payment                 AS FLOAT64)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT64)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT64)       as daily_rate, 
FROM accounts;


[0m20:17:14.172313 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:908d9746-48eb-4587-be12-1cd892cd3f23&page=queryresults
[0m20:17:14.895754 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5140bb9f-51c0-4b03-b4fa-6139912c30d3', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d67b76af0>]}
[0m20:17:14.896967 [info ] [Thread-1  ]: 1 of 1 OK created sql view model oscreditrisk.cleaned_accounts ................. [[32mCREATE VIEW (0 processed)[0m in 2.08s]
[0m20:17:14.899307 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m20:17:14.901559 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:17:14.902137 [debug] [MainThread]: Connection 'model.creditrisk.cleaned_accounts' was properly closed.
[0m20:17:14.902684 [info ] [MainThread]: 
[0m20:17:14.903237 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 5.76 seconds (5.76s).
[0m20:17:14.904584 [debug] [MainThread]: Command end result
[0m20:17:14.996488 [info ] [MainThread]: 
[0m20:17:14.997996 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:17:14.999186 [info ] [MainThread]: 
[0m20:17:15.000779 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:17:15.003993 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 11.415193, "process_user_time": 5.912645, "process_kernel_time": 1.107585, "process_mem_max_rss": "225361920", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:17:15.007789 [debug] [MainThread]: Command `dbt run` succeeded at 20:17:15.007257 after 11.42 seconds
[0m20:17:15.011391 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d66a33520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d6cdcf190>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9d688f90d0>]}
[0m20:17:15.012809 [debug] [MainThread]: Flushing usage events
[0m20:17:38.961647 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7112634f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe713169d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe713169100>]}


============================== 20:17:38.968132 | d35efe3a-f8f6-4e02-9fe0-34fd8558c924 ==============================
[0m20:17:38.968132 [info ] [MainThread]: Running with dbt=1.8.8
[0m20:17:38.969223 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'no_print': 'None', 'debug': 'False', 'printer_width': '80', 'static_parser': 'True', 'partial_parse': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'write_json': 'True', 'version_check': 'True', 'target_path': 'None', 'fail_fast': 'False', 'log_format': 'default', 'quiet': 'False', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'invocation_command': 'dbt run --select 0_cleaning', 'warn_error': 'None', 'use_colors': 'True', 'introspect': 'True', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/Users/david/.dbt'}
[0m20:17:43.731084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd35efe3a-f8f6-4e02-9fe0-34fd8558c924', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe711529dc0>]}
[0m20:17:43.803027 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd35efe3a-f8f6-4e02-9fe0-34fd8558c924', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe716cd9a60>]}
[0m20:17:43.803931 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m20:17:43.835468 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m20:17:44.191893 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:17:44.192526 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:17:44.273556 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd35efe3a-f8f6-4e02-9fe0-34fd8558c924', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe717960130>]}
[0m20:17:44.458783 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd35efe3a-f8f6-4e02-9fe0-34fd8558c924', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7179865b0>]}
[0m20:17:44.459567 [info ] [MainThread]: Found 4 models, 4 data tests, 2 seeds, 479 macros
[0m20:17:44.460124 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd35efe3a-f8f6-4e02-9fe0-34fd8558c924', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe717929070>]}
[0m20:17:44.460991 [warn ] [MainThread]: The selection criterion '0_cleaning' does not match any enabled nodes
[0m20:17:44.462145 [info ] [MainThread]: 
[0m20:17:44.462688 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m20:17:44.465427 [debug] [MainThread]: Command end result
[0m20:17:44.508388 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 5.6463394, "process_user_time": 5.781468, "process_kernel_time": 1.029828, "process_mem_max_rss": "219955200", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:17:44.509494 [debug] [MainThread]: Command `dbt run` succeeded at 20:17:44.509306 after 5.65 seconds
[0m20:17:44.510141 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7112634f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe7179296a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fe716cd9a60>]}
[0m20:17:44.510720 [debug] [MainThread]: Flushing usage events
[0m20:22:40.162097 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ac882f5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8accb7e280>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8accb7ec40>]}


============================== 20:22:40.166846 | 22aa6c08-6638-40b5-98f5-c1750d95df41 ==============================
[0m20:22:40.166846 [info ] [MainThread]: Running with dbt=1.8.8
[0m20:22:40.167802 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt run --select date_spine', 'debug': 'False', 'profiles_dir': '/Users/david/.dbt', 'use_colors': 'True', 'version_check': 'True', 'empty': 'False', 'introspect': 'True', 'no_print': 'None', 'quiet': 'False', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'cache_selected_only': 'False', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'target_path': 'None', 'log_format': 'default', 'log_cache_events': 'False', 'printer_width': '80', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'static_parser': 'True', 'warn_error': 'None'}
[0m20:22:44.003201 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '22aa6c08-6638-40b5-98f5-c1750d95df41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8accb29b50>]}
[0m20:22:44.060949 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '22aa6c08-6638-40b5-98f5-c1750d95df41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ad0c155b0>]}
[0m20:22:44.061716 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m20:22:44.086269 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m20:22:44.340747 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m20:22:44.341224 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m20:22:44.406270 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '22aa6c08-6638-40b5-98f5-c1750d95df41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ad1160130>]}
[0m20:22:44.552136 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '22aa6c08-6638-40b5-98f5-c1750d95df41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ad115ed60>]}
[0m20:22:44.552748 [info ] [MainThread]: Found 5 models, 4 data tests, 2 seeds, 479 macros
[0m20:22:44.553175 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '22aa6c08-6638-40b5-98f5-c1750d95df41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ad11833a0>]}
[0m20:22:44.554551 [info ] [MainThread]: 
[0m20:22:44.555320 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m20:22:44.556322 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m20:22:44.556801 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m20:22:47.414101 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m20:22:47.415055 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m20:22:48.044974 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '22aa6c08-6638-40b5-98f5-c1750d95df41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ad0410040>]}
[0m20:22:48.046023 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m20:22:48.046594 [info ] [MainThread]: 
[0m20:22:48.050866 [debug] [Thread-1  ]: Began running node model.creditrisk.date_spine
[0m20:22:48.051779 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.date_spine ............................ [RUN]
[0m20:22:48.052662 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.date_spine)
[0m20:22:48.053378 [debug] [Thread-1  ]: Began compiling node model.creditrisk.date_spine
[0m20:22:48.076564 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.date_spine"
[0m20:22:48.077671 [debug] [Thread-1  ]: Began executing node model.creditrisk.date_spine
[0m20:22:48.124062 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.date_spine"
[0m20:22:48.125288 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m20:22:48.126059 [debug] [Thread-1  ]: On model.creditrisk.date_spine: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.date_spine"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`date_spine`
  OPTIONS()
  as WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

min_max_dates as (
    SELECT 
        CAST(MIN(registration_date) AS DATE) as min_date,
        CAST(MAX(registration_date) AS DATE) as max_date,
    FROM accounts
)

SELECT
    TIMESTAMP_ADD(
        (SELECT min_date FROM min_max_dates), 
        INTERVAL n DAY
    ) AS reporting_date,
FROM 
  UNNEST(
    GENERATE_ARRAY(
        0, 
        DATE_DIFF(
            (SELECT max_date FROM min_max_dates),
            (SELECT min_date FROM min_max_dates),
            --'2021-12-31', 
            --'2015-01-01', -- Date the first account was 
            DAY
        )
    )
) AS n;


[0m20:22:49.239734 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:f4b562dd-5636-46d0-a4f5-b082ccb1bfcb&page=queryresults
[0m20:22:49.906069 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22aa6c08-6638-40b5-98f5-c1750d95df41', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ad178a5e0>]}
[0m20:22:49.907095 [info ] [Thread-1  ]: 1 of 1 OK created sql view model oscreditrisk.date_spine ....................... [[32mCREATE VIEW (0 processed)[0m in 1.85s]
[0m20:22:49.908081 [debug] [Thread-1  ]: Finished running node model.creditrisk.date_spine
[0m20:22:49.909648 [debug] [MainThread]: Connection 'master' was properly closed.
[0m20:22:49.910129 [debug] [MainThread]: Connection 'model.creditrisk.date_spine' was properly closed.
[0m20:22:49.910633 [info ] [MainThread]: 
[0m20:22:49.911176 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 5.36 seconds (5.36s).
[0m20:22:49.912323 [debug] [MainThread]: Command end result
[0m20:22:49.965204 [info ] [MainThread]: 
[0m20:22:49.966174 [info ] [MainThread]: [32mCompleted successfully[0m
[0m20:22:49.966724 [info ] [MainThread]: 
[0m20:22:49.967296 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m20:22:49.968110 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 9.891236, "process_user_time": 5.069089, "process_kernel_time": 0.841991, "process_mem_max_rss": "226533376", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:22:49.969012 [debug] [MainThread]: Command `dbt run` succeeded at 20:22:49.968858 after 9.89 seconds
[0m20:22:49.969630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ac882f5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ac8d832b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ad0c155b0>]}
[0m20:22:49.970226 [debug] [MainThread]: Flushing usage events
[0m21:13:31.450754 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0ee261520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f0269a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f0269340>]}


============================== 21:13:31.456596 | 13e42f03-64b7-45d0-9f83-8fc55cbb609a ==============================
[0m21:13:31.456596 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:13:31.457927 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'empty': 'False', 'use_colors': 'True', 'no_print': 'None', 'quiet': 'False', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/Users/david/.dbt', 'version_check': 'True', 'printer_width': '80', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'debug': 'False', 'invocation_command': 'dbt run --select +accounts_history_beginner', 'use_experimental_parser': 'False', 'target_path': 'None', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'introspect': 'True', 'cache_selected_only': 'False', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'write_json': 'True', 'warn_error': 'None', 'static_parser': 'True'}
[0m21:13:36.497265 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f0243e20>]}
[0m21:13:36.584122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f3bcbfa0>]}
[0m21:13:36.585189 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:13:36.629665 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:13:37.040385 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:13:37.041259 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:13:37.135645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f486dfd0>]}
[0m21:13:37.341890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f4878400>]}
[0m21:13:37.342747 [info ] [MainThread]: Found 7 models, 2 seeds, 4 data tests, 479 macros
[0m21:13:37.343334 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f4837250>]}
[0m21:13:37.345326 [info ] [MainThread]: 
[0m21:13:37.346354 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:13:37.354046 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:13:37.356122 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:13:40.915389 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:13:40.917758 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:13:41.523802 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f00ffa60>]}
[0m21:13:41.524822 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:13:41.525379 [info ] [MainThread]: 
[0m21:13:41.529677 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m21:13:41.530668 [info ] [Thread-1  ]: 1 of 4 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m21:13:41.531944 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m21:13:41.532664 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m21:13:41.549399 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m21:13:41.551297 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m21:13:41.598720 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m21:13:41.600103 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:13:41.600986 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)     as registration_date, 
  CAST(unlock_price                 AS FLOAT64)       as unlock_price, 
  CAST(down_payment                 AS FLOAT64)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT64)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT64)       as daily_rate, 
FROM accounts;


[0m21:13:42.386486 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:a9fe0d47-5bb2-4205-800f-58720bd31d86&page=queryresults
[0m21:13:43.077162 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f44db610>]}
[0m21:13:43.078423 [info ] [Thread-1  ]: 1 of 4 OK created sql view model oscreditrisk.cleaned_accounts ................. [[32mCREATE VIEW (0 processed)[0m in 1.54s]
[0m21:13:43.079420 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m21:13:43.080147 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_payments
[0m21:13:43.081221 [info ] [Thread-1  ]: 2 of 4 START sql view model oscreditrisk.cleaned_payments ...................... [RUN]
[0m21:13:43.081989 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_accounts, now model.creditrisk.cleaned_payments)
[0m21:13:43.082572 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_payments
[0m21:13:43.087368 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_payments"
[0m21:13:43.088469 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_payments
[0m21:13:43.098450 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_payments"
[0m21:13:43.099787 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:13:43.100824 [debug] [Thread-1  ]: On model.creditrisk.cleaned_payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_payments"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_payments`
)

SELECT 
  account_id,
  CAST(down_payment             AS BOOLEAN)     as down_payment,
  CAST(payment_effective_date   AS TIMESTAMP)   as payment_effective_date,
  CAST(amount                   AS FLOAT)       as amount,
FROM payments;


[0m21:13:43.913072 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:15c5baec-722c-4490-a651-1b9fa82d234e&page=queryresults
[0m21:13:44.224666 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Type not found: FLOAT at [19:36]; reason: invalidQuery, location: query, message: Type not found: FLOAT at [19:36]')
[0m21:13:45.103051 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:05693c9d-4365-4cdf-8125-16fa8506e387&page=queryresults
[0m21:13:45.399788 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:05693c9d-4365-4cdf-8125-16fa8506e387&page=queryresults
[0m21:13:45.415196 [debug] [Thread-1  ]: Database Error in model cleaned_payments (models/example/0_cleaning/cleaned_payments.sql)
  Type not found: FLOAT at [19:36]
  compiled code at target/run/creditrisk/models/example/0_cleaning/cleaned_payments.sql
[0m21:13:45.416716 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f51692e0>]}
[0m21:13:45.417717 [error] [Thread-1  ]: 2 of 4 ERROR creating sql view model oscreditrisk.cleaned_payments ............. [[31mERROR[0m in 2.33s]
[0m21:13:45.418664 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_payments
[0m21:13:45.419366 [debug] [Thread-1  ]: Began running node model.creditrisk.date_spine
[0m21:13:45.420282 [info ] [Thread-1  ]: 3 of 4 START sql view model oscreditrisk.date_spine ............................ [RUN]
[0m21:13:45.421094 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_payments, now model.creditrisk.date_spine)
[0m21:13:45.421683 [debug] [Thread-1  ]: Began compiling node model.creditrisk.date_spine
[0m21:13:45.432248 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.date_spine"
[0m21:13:45.433534 [debug] [Thread-1  ]: Began executing node model.creditrisk.date_spine
[0m21:13:45.438884 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.date_spine"
[0m21:13:45.440414 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:13:45.441282 [debug] [Thread-1  ]: On model.creditrisk.date_spine: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.date_spine"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`date_spine`
  OPTIONS()
  as /*
    This transformations is generating a dataset containing one row for each day betwee : 
    - The first day you opened an account
    - Today. With artificial data here we consider today being the day after we received the last payment.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

min_max_dates as (
    SELECT 
        CAST(MIN(payment_effective_date)            AS DATE)                    as min_date,
        DATE_ADD(CAST(MAX(payment_effective_date)   AS DATE), INTERVAL 1 DAY)   as max_date,
    FROM payments
)

SELECT
    TIMESTAMP_ADD(
        (SELECT min_date FROM min_max_dates), 
        INTERVAL n DAY
    ) AS reporting_date,
FROM 
  UNNEST(
    GENERATE_ARRAY(
        0, 
        DATE_DIFF(
            (SELECT max_date FROM min_max_dates),
            (SELECT min_date FROM min_max_dates),
            DAY
        )
    )
) AS n;


[0m21:13:46.182344 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:69bbdbb1-a4ef-4bec-b68f-a1413017418e&page=queryresults
[0m21:13:46.183240 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "payments" must be qualified with a dataset (e.g. dataset.table).; reason: invalid, location: payments, message: Table "payments" must be qualified with a dataset (e.g. dataset.table).')
[0m21:13:46.767470 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b6eceef4-7eb0-4c21-9fa9-73b4964ebb8f&page=queryresults
[0m21:13:46.774660 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b6eceef4-7eb0-4c21-9fa9-73b4964ebb8f&page=queryresults
[0m21:13:46.783277 [debug] [Thread-1  ]: Database Error in model date_spine (models/example/1_building_core_dataset/date_spine.sql)
  Table "payments" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/date_spine.sql
[0m21:13:46.784432 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '13e42f03-64b7-45d0-9f83-8fc55cbb609a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f515ba30>]}
[0m21:13:46.786143 [error] [Thread-1  ]: 3 of 4 ERROR creating sql view model oscreditrisk.date_spine ................... [[31mERROR[0m in 1.36s]
[0m21:13:46.789240 [debug] [Thread-1  ]: Finished running node model.creditrisk.date_spine
[0m21:13:46.790693 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m21:13:46.792810 [info ] [Thread-1  ]: 4 of 4 SKIP relation oscreditrisk.accounts_history_beginner .................... [[33mSKIP[0m]
[0m21:13:46.794101 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m21:13:46.806939 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:13:46.807885 [debug] [MainThread]: Connection 'model.creditrisk.date_spine' was properly closed.
[0m21:13:46.808892 [info ] [MainThread]: 
[0m21:13:46.809805 [info ] [MainThread]: Finished running 4 view models in 0 hours 0 minutes and 9.46 seconds (9.46s).
[0m21:13:46.812788 [debug] [MainThread]: Command end result
[0m21:13:46.878599 [info ] [MainThread]: 
[0m21:13:46.879739 [info ] [MainThread]: [31mCompleted with 2 errors and 0 warnings:[0m
[0m21:13:46.880549 [info ] [MainThread]: 
[0m21:13:46.881262 [error] [MainThread]:   Database Error in model cleaned_payments (models/example/0_cleaning/cleaned_payments.sql)
  Type not found: FLOAT at [19:36]
  compiled code at target/run/creditrisk/models/example/0_cleaning/cleaned_payments.sql
[0m21:13:46.881787 [info ] [MainThread]: 
[0m21:13:46.882404 [error] [MainThread]:   Database Error in model date_spine (models/example/1_building_core_dataset/date_spine.sql)
  Table "payments" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/date_spine.sql
[0m21:13:46.883041 [info ] [MainThread]: 
[0m21:13:46.883817 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=2 SKIP=1 TOTAL=4
[0m21:13:46.885873 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 15.567249, "process_user_time": 6.101297, "process_kernel_time": 1.24545, "process_mem_max_rss": "226893824", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:13:46.887059 [debug] [MainThread]: Command `dbt run` failed at 21:13:46.886737 after 15.57 seconds
[0m21:13:46.887732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0ee261520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0ee686670>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff0f44c4250>]}
[0m21:13:46.888333 [debug] [MainThread]: Flushing usage events
[0m21:14:24.305677 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9361a2f5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9364270d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93642703d0>]}


============================== 21:14:24.310211 | 1dac4ae7-22c2-4aa6-b337-f4582cc0154e ==============================
[0m21:14:24.310211 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:14:24.311169 [debug] [MainThread]: running dbt with arguments {'introspect': 'True', 'static_parser': 'True', 'no_print': 'None', 'use_experimental_parser': 'False', 'profiles_dir': '/Users/david/.dbt', 'log_format': 'default', 'target_path': 'None', 'write_json': 'True', 'quiet': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'invocation_command': 'dbt run --select +accounts_history_beginner', 'printer_width': '80', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'cache_selected_only': 'False', 'warn_error': 'None', 'use_colors': 'True', 'log_cache_events': 'False', 'empty': 'False', 'version_check': 'True', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True'}
[0m21:14:28.158397 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9367dc1eb0>]}
[0m21:14:28.230919 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93683fa7c0>]}
[0m21:14:28.231874 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:14:28.263835 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:14:28.604125 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:14:28.604692 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:14:28.686557 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f936896deb0>]}
[0m21:14:28.877680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9368995790>]}
[0m21:14:28.878522 [info ] [MainThread]: Found 7 models, 2 seeds, 4 data tests, 479 macros
[0m21:14:28.879084 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9368933e20>]}
[0m21:14:28.881457 [info ] [MainThread]: 
[0m21:14:28.882763 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:14:28.889654 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:14:28.890337 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:14:31.738194 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:14:31.739178 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:14:32.449957 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9367e09610>]}
[0m21:14:32.451130 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:14:32.451780 [info ] [MainThread]: 
[0m21:14:32.455679 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m21:14:32.456507 [info ] [Thread-1  ]: 1 of 4 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m21:14:32.457321 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m21:14:32.457993 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m21:14:32.479059 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m21:14:32.480569 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m21:14:32.527176 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m21:14:32.528323 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:14:32.529079 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)     as registration_date, 
  CAST(unlock_price                 AS FLOAT64)       as unlock_price, 
  CAST(down_payment                 AS FLOAT64)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT64)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT64)       as daily_rate, 
FROM accounts;


[0m21:14:33.372815 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:939a4b6e-3855-4b5c-bbfc-bd57d521116a&page=queryresults
[0m21:14:34.073585 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93689770a0>]}
[0m21:14:34.074713 [info ] [Thread-1  ]: 1 of 4 OK created sql view model oscreditrisk.cleaned_accounts ................. [[32mCREATE VIEW (0 processed)[0m in 1.61s]
[0m21:14:34.075762 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m21:14:34.076515 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_payments
[0m21:14:34.077284 [info ] [Thread-1  ]: 2 of 4 START sql view model oscreditrisk.cleaned_payments ...................... [RUN]
[0m21:14:34.078206 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_accounts, now model.creditrisk.cleaned_payments)
[0m21:14:34.078938 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_payments
[0m21:14:34.084378 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_payments"
[0m21:14:34.085557 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_payments
[0m21:14:34.097653 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_payments"
[0m21:14:34.098994 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:14:34.099777 [debug] [Thread-1  ]: On model.creditrisk.cleaned_payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_payments"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_payments`
)

SELECT 
  account_id,
  CAST(down_payment             AS BOOLEAN)         as down_payment,
  CAST(payment_effective_date   AS TIMESTAMP)       as payment_effective_date,
  CAST(amount                   AS FLOAT64)         as amount,
FROM payments;


[0m21:14:35.081319 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:79c2c211-b250-4fd7-8efc-0e24947e5b1d&page=queryresults
[0m21:14:35.724479 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f936898db20>]}
[0m21:14:35.725445 [info ] [Thread-1  ]: 2 of 4 OK created sql view model oscreditrisk.cleaned_payments ................. [[32mCREATE VIEW (0 processed)[0m in 1.65s]
[0m21:14:35.726480 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_payments
[0m21:14:35.727200 [debug] [Thread-1  ]: Began running node model.creditrisk.date_spine
[0m21:14:35.728065 [info ] [Thread-1  ]: 3 of 4 START sql view model oscreditrisk.date_spine ............................ [RUN]
[0m21:14:35.728786 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_payments, now model.creditrisk.date_spine)
[0m21:14:35.729357 [debug] [Thread-1  ]: Began compiling node model.creditrisk.date_spine
[0m21:14:35.735882 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.date_spine"
[0m21:14:35.737512 [debug] [Thread-1  ]: Began executing node model.creditrisk.date_spine
[0m21:14:35.742897 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.date_spine"
[0m21:14:35.744317 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:14:35.745227 [debug] [Thread-1  ]: On model.creditrisk.date_spine: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.date_spine"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`date_spine`
  OPTIONS()
  as /*
    This transformations is generating a dataset containing one row for each day betwee : 
    - The first day you opened an account
    - Today. With artificial data here we consider today being the day after we received the last payment.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

min_max_dates as (
    SELECT 
        CAST(MIN(payment_effective_date)            AS DATE)                    as min_date,
        DATE_ADD(CAST(MAX(payment_effective_date)   AS DATE), INTERVAL 1 DAY)   as max_date,
    FROM payments
)

SELECT
    TIMESTAMP_ADD(
        (SELECT min_date FROM min_max_dates), 
        INTERVAL n DAY
    ) AS reporting_date,
FROM 
  UNNEST(
    GENERATE_ARRAY(
        0, 
        DATE_DIFF(
            (SELECT max_date FROM min_max_dates),
            (SELECT min_date FROM min_max_dates),
            DAY
        )
    )
) AS n;


[0m21:14:36.347554 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b6b5d862-b1a3-42fe-9ff0-d515e3a6258f&page=queryresults
[0m21:14:36.348464 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "payments" must be qualified with a dataset (e.g. dataset.table).; reason: invalid, location: payments, message: Table "payments" must be qualified with a dataset (e.g. dataset.table).')
[0m21:14:37.630818 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:ce03c73d-a276-4e74-9cd8-3783e963c647&page=queryresults
[0m21:14:37.631732 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:ce03c73d-a276-4e74-9cd8-3783e963c647&page=queryresults
[0m21:14:37.645483 [debug] [Thread-1  ]: Database Error in model date_spine (models/example/1_building_core_dataset/date_spine.sql)
  Table "payments" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/date_spine.sql
[0m21:14:37.646400 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '1dac4ae7-22c2-4aa6-b337-f4582cc0154e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f936898da30>]}
[0m21:14:37.647437 [error] [Thread-1  ]: 3 of 4 ERROR creating sql view model oscreditrisk.date_spine ................... [[31mERROR[0m in 1.92s]
[0m21:14:37.648504 [debug] [Thread-1  ]: Finished running node model.creditrisk.date_spine
[0m21:14:37.649938 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m21:14:37.650757 [info ] [Thread-1  ]: 4 of 4 SKIP relation oscreditrisk.accounts_history_beginner .................... [[33mSKIP[0m]
[0m21:14:37.651628 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m21:14:37.653565 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:14:37.654188 [debug] [MainThread]: Connection 'model.creditrisk.date_spine' was properly closed.
[0m21:14:37.654953 [info ] [MainThread]: 
[0m21:14:37.655612 [info ] [MainThread]: Finished running 4 view models in 0 hours 0 minutes and 8.77 seconds (8.77s).
[0m21:14:37.657245 [debug] [MainThread]: Command end result
[0m21:14:37.714811 [info ] [MainThread]: 
[0m21:14:37.715772 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:14:37.716678 [info ] [MainThread]: 
[0m21:14:37.717567 [error] [MainThread]:   Database Error in model date_spine (models/example/1_building_core_dataset/date_spine.sql)
  Table "payments" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/date_spine.sql
[0m21:14:37.718179 [info ] [MainThread]: 
[0m21:14:37.718779 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=1 TOTAL=4
[0m21:14:37.719669 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 13.505355, "process_user_time": 5.627665, "process_kernel_time": 0.943223, "process_mem_max_rss": "228356096", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:14:37.720872 [debug] [MainThread]: Command `dbt run` failed at 21:14:37.720553 after 13.51 seconds
[0m21:14:37.721722 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9361a2f5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9361d5b8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f93683fa7c0>]}
[0m21:14:37.722490 [debug] [MainThread]: Flushing usage events
[0m21:14:58.873009 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabea260550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabec271d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabec271400>]}


============================== 21:14:58.878071 | 6f84cee4-8c8a-4586-bba9-3ceee2d62edc ==============================
[0m21:14:58.878071 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:14:58.879159 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'cache_selected_only': 'False', 'printer_width': '80', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run --select +accounts_history_beginner', 'profiles_dir': '/Users/david/.dbt', 'version_check': 'True', 'log_cache_events': 'False', 'target_path': 'None', 'no_print': 'None', 'introspect': 'True', 'debug': 'False', 'use_colors': 'True', 'log_format': 'default', 'static_parser': 'True', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'empty': 'False', 'partial_parse': 'True', 'quiet': 'False', 'warn_error': 'None', 'indirect_selection': 'eager'}
[0m21:15:02.904811 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabefccca90>]}
[0m21:15:03.001396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf059d250>]}
[0m21:15:03.002370 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:15:03.038856 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:15:03.413332 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:15:03.413941 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:15:03.505456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf096dee0>]}
[0m21:15:03.711186 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf096ea30>]}
[0m21:15:03.712037 [info ] [MainThread]: Found 7 models, 2 seeds, 4 data tests, 479 macros
[0m21:15:03.713012 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf091a5b0>]}
[0m21:15:03.717568 [info ] [MainThread]: 
[0m21:15:03.719058 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:15:03.728572 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:15:03.729492 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:15:06.988416 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:15:06.990159 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:15:07.672636 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf05d1c10>]}
[0m21:15:07.673766 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:15:07.674451 [info ] [MainThread]: 
[0m21:15:07.679576 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m21:15:07.680561 [info ] [Thread-1  ]: 1 of 4 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m21:15:07.681496 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m21:15:07.682190 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m21:15:07.701711 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m21:15:07.703041 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m21:15:07.749726 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m21:15:07.751023 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:15:07.751893 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)     as registration_date, 
  CAST(unlock_price                 AS FLOAT64)       as unlock_price, 
  CAST(down_payment                 AS FLOAT64)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT64)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT64)       as daily_rate, 
FROM accounts;


[0m21:15:08.455237 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:0738fc85-ee8b-449d-a063-027ea846ec0e&page=queryresults
[0m21:15:09.078965 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf096ecd0>]}
[0m21:15:09.080039 [info ] [Thread-1  ]: 1 of 4 OK created sql view model oscreditrisk.cleaned_accounts ................. [[32mCREATE VIEW (0 processed)[0m in 1.40s]
[0m21:15:09.081140 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m21:15:09.081905 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_payments
[0m21:15:09.082803 [info ] [Thread-1  ]: 2 of 4 START sql view model oscreditrisk.cleaned_payments ...................... [RUN]
[0m21:15:09.083548 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_accounts, now model.creditrisk.cleaned_payments)
[0m21:15:09.084129 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_payments
[0m21:15:09.089421 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_payments"
[0m21:15:09.090645 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_payments
[0m21:15:09.101735 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_payments"
[0m21:15:09.102827 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:15:09.103543 [debug] [Thread-1  ]: On model.creditrisk.cleaned_payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_payments"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_payments`
)

SELECT 
  account_id,
  CAST(down_payment             AS BOOLEAN)         as down_payment,
  CAST(payment_effective_date   AS TIMESTAMP)       as payment_effective_date,
  CAST(amount                   AS FLOAT64)         as amount,
FROM payments;


[0m21:15:09.927593 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:f65eb667-e4a5-4d37-a02a-742baf68bb39&page=queryresults
[0m21:15:10.605885 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf122c760>]}
[0m21:15:10.606815 [info ] [Thread-1  ]: 2 of 4 OK created sql view model oscreditrisk.cleaned_payments ................. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m21:15:10.607779 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_payments
[0m21:15:10.608958 [debug] [Thread-1  ]: Began running node model.creditrisk.date_spine
[0m21:15:10.609799 [info ] [Thread-1  ]: 3 of 4 START sql view model oscreditrisk.date_spine ............................ [RUN]
[0m21:15:10.610505 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_payments, now model.creditrisk.date_spine)
[0m21:15:10.611147 [debug] [Thread-1  ]: Began compiling node model.creditrisk.date_spine
[0m21:15:10.617452 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.date_spine"
[0m21:15:10.618940 [debug] [Thread-1  ]: Began executing node model.creditrisk.date_spine
[0m21:15:10.623877 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.date_spine"
[0m21:15:10.624983 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:15:10.625726 [debug] [Thread-1  ]: On model.creditrisk.date_spine: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.date_spine"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`date_spine`
  OPTIONS()
  as /*
    This transformations is generating a dataset containing one row for each day betwee : 
    - The first day you opened an account
    - Today. With artificial data here we consider today being the day after we received the last payment.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

min_max_dates as (
    SELECT 
        CAST(MIN(payment_effective_date)            AS DATE)                    as min_date,
        DATE_ADD(CAST(MAX(payment_effective_date)   AS DATE), INTERVAL 1 DAY)   as max_date,
    FROM payments
)

SELECT
    TIMESTAMP_ADD(
        (SELECT min_date FROM min_max_dates), 
        INTERVAL n DAY
    ) AS reporting_date,
FROM 
  UNNEST(
    GENERATE_ARRAY(
        0, 
        DATE_DIFF(
            (SELECT max_date FROM min_max_dates),
            (SELECT min_date FROM min_max_dates),
            DAY
        )
    )
) AS n;


[0m21:15:11.564193 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:47b9c2cb-5228-49d2-b9cc-bd0d433126e1&page=queryresults
[0m21:15:12.386299 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf1261760>]}
[0m21:15:12.387466 [info ] [Thread-1  ]: 3 of 4 OK created sql view model oscreditrisk.date_spine ....................... [[32mCREATE VIEW (0 processed)[0m in 1.78s]
[0m21:15:12.388537 [debug] [Thread-1  ]: Finished running node model.creditrisk.date_spine
[0m21:15:12.389728 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m21:15:12.390638 [info ] [Thread-1  ]: 4 of 4 START sql view model oscreditrisk.accounts_history_beginner ............. [RUN]
[0m21:15:12.391497 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.date_spine, now model.creditrisk.accounts_history_beginner)
[0m21:15:12.392113 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_beginner
[0m21:15:12.401655 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_beginner"
[0m21:15:12.402816 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_beginner
[0m21:15:12.408236 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_beginner"
[0m21:15:12.409406 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:15:12.411086 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_beginner"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
  OPTIONS()
  as /*
    This transformations is generating the first version of the core dataset (beginner version). 
    It is essentially : 
    - Joining the accounts dataset with a date spine for the target granuarity
    - Grouping the payment by day, and joining them to the accounts history
    - Calculating cumulated sums to describe the cumulated amount paid, and a few other useful fields
*/

WITH accounts as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

payments as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

date_spine as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`date_spine`
),

accounts_with_spine as (
  SELECT 
    *,
    TIMESTAMP_DIFF(reporting_date, registration_date, DAY) + 1 as reporting_day,
  FROM accounts
  LEFT JOIN date_spine
  ON accounts.registration_date <= date_spine.reporting_date
),

payments_grouped_by_day as (
  SELECT 
    account_id,
    
    DATE_ADD(
      DATE_TRUNC(payment_effective_date, DAY), 
      INTERVAL 1 DAY
    ) as reporting_date,

    SUM(amount) as amount,
    SUM(
      IF(not down_payment, amount, 0)
    ) as amount_excl_dp,

  FROM payments
  GROUP BY ALL
),

joint as (
  SELECT 
    * EXCEPT(amount, amount_excl_dp),
    COALESCE(amount,          0) as amount,
    COALESCE(amount_excl_dp,  0) as amount_excl_dp,
  FROM accounts_with_spine 
  LEFT JOIN payments_grouped_by_day 
  USING(account_id, reporting_date)
),

calc_paid_total as (
  SELECT 
    *,
    SUM(amount)         OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total,
    SUM(amount_excl_dp) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_excl_dp,
    
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate) + down_payment_days_included as nominal_term,
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate)                              as nominal_term_excl_dp,
  FROM joint
)

SELECT * FROM calc_paid_total;


[0m21:15:13.409403 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:d1a97aa5-8dfa-4b98-bc83-14cc3a1fe767&page=queryresults
[0m21:15:13.820896 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('No matching signature for operator <= for argument types: TIMESTAMP, DATETIME\n  Signature: T1 <= T1\n    Unable to find common supertype for templated argument <T1>\n      Input types for <T1>: {TIMESTAMP, DATETIME} at [32:6]; reason: invalidQuery, location: query, message: No matching signature for operator <= for argument types: TIMESTAMP, DATETIME\n  Signature: T1 <= T1\n    Unable to find common supertype for templated argument <T1>\n      Input types for <T1>: {TIMESTAMP, DATETIME} at [32:6]')
[0m21:15:14.943651 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:6bebf356-59d0-4855-8382-cf9b9673856f&page=queryresults
[0m21:15:15.359242 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:6bebf356-59d0-4855-8382-cf9b9673856f&page=queryresults
[0m21:15:15.375075 [debug] [Thread-1  ]: Database Error in model accounts_history_beginner (models/example/1_building_core_dataset/accounts_history_beginner.sql)
  No matching signature for operator <= for argument types: TIMESTAMP, DATETIME
    Signature: T1 <= T1
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {TIMESTAMP, DATETIME} at [32:6]
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/accounts_history_beginner.sql
[0m21:15:15.375944 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6f84cee4-8c8a-4586-bba9-3ceee2d62edc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabf12d6d30>]}
[0m21:15:15.377061 [error] [Thread-1  ]: 4 of 4 ERROR creating sql view model oscreditrisk.accounts_history_beginner .... [[31mERROR[0m in 2.98s]
[0m21:15:15.378116 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m21:15:15.380151 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:15:15.380702 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_beginner' was properly closed.
[0m21:15:15.381406 [info ] [MainThread]: 
[0m21:15:15.382022 [info ] [MainThread]: Finished running 4 view models in 0 hours 0 minutes and 11.66 seconds (11.66s).
[0m21:15:15.384496 [debug] [MainThread]: Command end result
[0m21:15:15.441533 [info ] [MainThread]: 
[0m21:15:15.442316 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:15:15.442844 [info ] [MainThread]: 
[0m21:15:15.443640 [error] [MainThread]:   Database Error in model accounts_history_beginner (models/example/1_building_core_dataset/accounts_history_beginner.sql)
  No matching signature for operator <= for argument types: TIMESTAMP, DATETIME
    Signature: T1 <= T1
      Unable to find common supertype for templated argument <T1>
        Input types for <T1>: {TIMESTAMP, DATETIME} at [32:6]
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/accounts_history_beginner.sql
[0m21:15:15.444374 [info ] [MainThread]: 
[0m21:15:15.445138 [info ] [MainThread]: Done. PASS=3 WARN=0 ERROR=1 SKIP=0 TOTAL=4
[0m21:15:15.446005 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 16.677156, "process_user_time": 5.992553, "process_kernel_time": 1.042533, "process_mem_max_rss": "228065280", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:15:15.446933 [debug] [MainThread]: Command `dbt run` failed at 21:15:15.446758 after 16.68 seconds
[0m21:15:15.447570 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabea260550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabec1fa8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fabea47e4c0>]}
[0m21:15:15.448241 [debug] [MainThread]: Flushing usage events
[0m21:16:01.664271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb5362634f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53820bd00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53820b100>]}


============================== 21:16:01.670615 | 6c3065b7-4325-4932-aef7-1752f7a56a00 ==============================
[0m21:16:01.670615 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:16:01.672221 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'use_colors': 'True', 'fail_fast': 'False', 'version_check': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'quiet': 'False', 'partial_parse': 'True', 'empty': 'False', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'printer_width': '80', 'warn_error': 'None', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'no_print': 'None', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'profiles_dir': '/Users/david/.dbt', 'invocation_command': 'dbt run --select 1+accounts_history_beginner', 'introspect': 'True', 'log_format': 'default'}
[0m21:16:05.542271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb536429dc0>]}
[0m21:16:05.619901 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb5381da460>]}
[0m21:16:05.620971 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:16:05.653765 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:16:06.046905 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:16:06.047499 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:16:06.134316 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53c72deb0>]}
[0m21:16:06.335771 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53c755a00>]}
[0m21:16:06.336822 [info ] [MainThread]: Found 7 models, 2 seeds, 4 data tests, 479 macros
[0m21:16:06.337413 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53c6da310>]}
[0m21:16:06.339300 [info ] [MainThread]: 
[0m21:16:06.340181 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:16:06.348273 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:16:06.349022 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:16:09.324209 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:16:09.324963 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:16:09.901643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53c505c10>]}
[0m21:16:09.902513 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:16:09.902998 [info ] [MainThread]: 
[0m21:16:09.905781 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m21:16:09.906477 [info ] [Thread-1  ]: 1 of 4 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m21:16:09.907055 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m21:16:09.907506 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m21:16:09.921661 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m21:16:09.922590 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m21:16:09.958411 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m21:16:09.959417 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:16:09.960041 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)     as registration_date, 
  CAST(unlock_price                 AS FLOAT64)       as unlock_price, 
  CAST(down_payment                 AS FLOAT64)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT64)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT64)       as daily_rate, 
FROM accounts;


[0m21:16:10.709815 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:24e1f89f-09f8-4ad0-bcae-ad232fded982&page=queryresults
[0m21:16:11.706716 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53c755dc0>]}
[0m21:16:11.708137 [info ] [Thread-1  ]: 1 of 4 OK created sql view model oscreditrisk.cleaned_accounts ................. [[32mCREATE VIEW (0 processed)[0m in 1.80s]
[0m21:16:11.709531 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m21:16:11.710511 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_payments
[0m21:16:11.712675 [info ] [Thread-1  ]: 2 of 4 START sql view model oscreditrisk.cleaned_payments ...................... [RUN]
[0m21:16:11.715753 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_accounts, now model.creditrisk.cleaned_payments)
[0m21:16:11.716524 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_payments
[0m21:16:11.723226 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_payments"
[0m21:16:11.724499 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_payments
[0m21:16:11.739166 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_payments"
[0m21:16:11.740741 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:16:11.741613 [debug] [Thread-1  ]: On model.creditrisk.cleaned_payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_payments"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_payments`
)

SELECT 
  account_id,
  CAST(down_payment             AS BOOLEAN)         as down_payment,
  CAST(payment_effective_date   AS TIMESTAMP)       as payment_effective_date,
  CAST(amount                   AS FLOAT64)         as amount,
FROM payments;


[0m21:16:12.451861 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:e79236c9-289d-4889-b588-34fd5bab88d9&page=queryresults
[0m21:16:13.015951 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53c7563a0>]}
[0m21:16:13.016914 [info ] [Thread-1  ]: 2 of 4 OK created sql view model oscreditrisk.cleaned_payments ................. [[32mCREATE VIEW (0 processed)[0m in 1.30s]
[0m21:16:13.017880 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_payments
[0m21:16:13.019022 [debug] [Thread-1  ]: Began running node model.creditrisk.date_spine
[0m21:16:13.019821 [info ] [Thread-1  ]: 3 of 4 START sql view model oscreditrisk.date_spine ............................ [RUN]
[0m21:16:13.020764 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_payments, now model.creditrisk.date_spine)
[0m21:16:13.021354 [debug] [Thread-1  ]: Began compiling node model.creditrisk.date_spine
[0m21:16:13.028067 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.date_spine"
[0m21:16:13.029545 [debug] [Thread-1  ]: Began executing node model.creditrisk.date_spine
[0m21:16:13.034640 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.date_spine"
[0m21:16:13.036003 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:16:13.036928 [debug] [Thread-1  ]: On model.creditrisk.date_spine: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.date_spine"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`date_spine`
  OPTIONS()
  as /*
    This transformations is generating a dataset containing one row for each day betwee : 
    - The first day you opened an account
    - Today. With artificial data here we consider today being the day after we received the last payment.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

min_max_dates as (
    SELECT 
        CAST(MIN(payment_effective_date)            AS DATE)                    as min_date,
        DATE_ADD(CAST(MAX(payment_effective_date)   AS DATE), INTERVAL 1 DAY)   as max_date,
    FROM payments
)

SELECT
    CAST(
        TIMESTAMP_ADD(
            (SELECT min_date FROM min_max_dates), 
            INTERVAL n DAY
        ) 
    ) AS TIMESTAMP) AS reporting_date,
FROM 
  UNNEST(
    GENERATE_ARRAY(
        0, 
        DATE_DIFF(
            (SELECT max_date FROM min_max_dates),
            (SELECT min_date FROM min_max_dates),
            DAY
        )
    )
) AS n;


[0m21:16:13.721095 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b849c29e-045c-40af-aaca-f2db0e169978&page=queryresults
[0m21:16:13.722006 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected keyword AS but got ")" at [29:5]; reason: invalidQuery, location: query, message: Syntax error: Expected keyword AS but got ")" at [29:5]')
[0m21:16:14.729857 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:d3a72700-e7cc-4b64-ad3f-d5b4634f51f6&page=queryresults
[0m21:16:14.734815 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:d3a72700-e7cc-4b64-ad3f-d5b4634f51f6&page=queryresults
[0m21:16:14.769279 [debug] [Thread-1  ]: Database Error in model date_spine (models/example/1_building_core_dataset/date_spine.sql)
  Syntax error: Expected keyword AS but got ")" at [29:5]
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/date_spine.sql
[0m21:16:14.774094 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6c3065b7-4325-4932-aef7-1752f7a56a00', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53cd79df0>]}
[0m21:16:14.775183 [error] [Thread-1  ]: 3 of 4 ERROR creating sql view model oscreditrisk.date_spine ................... [[31mERROR[0m in 1.75s]
[0m21:16:14.776127 [debug] [Thread-1  ]: Finished running node model.creditrisk.date_spine
[0m21:16:14.777329 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m21:16:14.779282 [info ] [Thread-1  ]: 4 of 4 SKIP relation oscreditrisk.accounts_history_beginner .................... [[33mSKIP[0m]
[0m21:16:14.780840 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m21:16:14.782688 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:16:14.783331 [debug] [MainThread]: Connection 'model.creditrisk.date_spine' was properly closed.
[0m21:16:14.784043 [info ] [MainThread]: 
[0m21:16:14.784711 [info ] [MainThread]: Finished running 4 view models in 0 hours 0 minutes and 8.44 seconds (8.44s).
[0m21:16:14.786791 [debug] [MainThread]: Command end result
[0m21:16:14.848530 [info ] [MainThread]: 
[0m21:16:14.849290 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:16:14.849822 [info ] [MainThread]: 
[0m21:16:14.850483 [error] [MainThread]:   Database Error in model date_spine (models/example/1_building_core_dataset/date_spine.sql)
  Syntax error: Expected keyword AS but got ")" at [29:5]
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/date_spine.sql
[0m21:16:14.851006 [info ] [MainThread]: 
[0m21:16:14.851561 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=1 SKIP=1 TOTAL=4
[0m21:16:14.852490 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 13.287373, "process_user_time": 5.920819, "process_kernel_time": 1.012876, "process_mem_max_rss": "228106240", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:16:14.853522 [debug] [MainThread]: Command `dbt run` failed at 21:16:14.853345 after 13.29 seconds
[0m21:16:14.854169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb5362634f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53bae6ac0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fb53c755ac0>]}
[0m21:16:14.854766 [debug] [MainThread]: Flushing usage events
[0m21:16:35.113778 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f814f260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8151269be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8151269190>]}


============================== 21:16:35.118657 | b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9 ==============================
[0m21:16:35.118657 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:16:35.119761 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'printer_width': '80', 'fail_fast': 'False', 'invocation_command': 'dbt run --select 1+accounts_history_beginner', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'introspect': 'True', 'target_path': 'None', 'warn_error': 'None', 'empty': 'False', 'indirect_selection': 'eager', 'no_print': 'None', 'profiles_dir': '/Users/david/.dbt', 'write_json': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'debug': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'quiet': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])'}
[0m21:16:38.509496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f815551f4f0>]}
[0m21:16:38.586810 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f81554d7ca0>]}
[0m21:16:38.587768 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:16:38.618816 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:16:38.954018 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:16:38.954598 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:16:39.033852 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8155a6deb0>]}
[0m21:16:39.198688 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8155a95b50>]}
[0m21:16:39.199458 [info ] [MainThread]: Found 7 models, 2 seeds, 4 data tests, 479 macros
[0m21:16:39.200056 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8155a1a190>]}
[0m21:16:39.201893 [info ] [MainThread]: 
[0m21:16:39.202685 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:16:39.209418 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:16:39.210145 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:16:41.814326 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:16:41.815236 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:16:42.384320 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f814f5649a0>]}
[0m21:16:42.385375 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:16:42.385956 [info ] [MainThread]: 
[0m21:16:42.388997 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m21:16:42.389834 [info ] [Thread-1  ]: 1 of 4 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m21:16:42.390575 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m21:16:42.391171 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m21:16:42.408028 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m21:16:42.409189 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m21:16:42.455210 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m21:16:42.456374 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:16:42.457111 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)     as registration_date, 
  CAST(unlock_price                 AS FLOAT64)       as unlock_price, 
  CAST(down_payment                 AS FLOAT64)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT64)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT64)       as daily_rate, 
FROM accounts;


[0m21:16:43.316083 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:7220e4ba-bee0-4a9b-9473-3b1102021997&page=queryresults
[0m21:16:44.024541 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f815560a820>]}
[0m21:16:44.025578 [info ] [Thread-1  ]: 1 of 4 OK created sql view model oscreditrisk.cleaned_accounts ................. [[32mCREATE VIEW (0 processed)[0m in 1.63s]
[0m21:16:44.026583 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m21:16:44.027305 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_payments
[0m21:16:44.028168 [info ] [Thread-1  ]: 2 of 4 START sql view model oscreditrisk.cleaned_payments ...................... [RUN]
[0m21:16:44.028895 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_accounts, now model.creditrisk.cleaned_payments)
[0m21:16:44.029516 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_payments
[0m21:16:44.033994 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_payments"
[0m21:16:44.035162 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_payments
[0m21:16:44.045160 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_payments"
[0m21:16:44.046804 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:16:44.048283 [debug] [Thread-1  ]: On model.creditrisk.cleaned_payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_payments"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_payments`
)

SELECT 
  account_id,
  CAST(down_payment             AS BOOLEAN)         as down_payment,
  CAST(payment_effective_date   AS TIMESTAMP)       as payment_effective_date,
  CAST(amount                   AS FLOAT64)         as amount,
FROM payments;


[0m21:16:44.856663 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:102b5e24-b3d2-43f8-a8a7-2fc3414b5fc8&page=queryresults
[0m21:16:45.454657 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8155a8d1f0>]}
[0m21:16:45.455614 [info ] [Thread-1  ]: 2 of 4 OK created sql view model oscreditrisk.cleaned_payments ................. [[32mCREATE VIEW (0 processed)[0m in 1.43s]
[0m21:16:45.456570 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_payments
[0m21:16:45.457698 [debug] [Thread-1  ]: Began running node model.creditrisk.date_spine
[0m21:16:45.458504 [info ] [Thread-1  ]: 3 of 4 START sql view model oscreditrisk.date_spine ............................ [RUN]
[0m21:16:45.459353 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_payments, now model.creditrisk.date_spine)
[0m21:16:45.460110 [debug] [Thread-1  ]: Began compiling node model.creditrisk.date_spine
[0m21:16:45.467983 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.date_spine"
[0m21:16:45.469053 [debug] [Thread-1  ]: Began executing node model.creditrisk.date_spine
[0m21:16:45.473645 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.date_spine"
[0m21:16:45.474711 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:16:45.475448 [debug] [Thread-1  ]: On model.creditrisk.date_spine: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.date_spine"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`date_spine`
  OPTIONS()
  as /*
    This transformations is generating a dataset containing one row for each day betwee : 
    - The first day you opened an account
    - Today. With artificial data here we consider today being the day after we received the last payment.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

min_max_dates as (
    SELECT 
        CAST(MIN(payment_effective_date)            AS DATE)                    as min_date,
        DATE_ADD(CAST(MAX(payment_effective_date)   AS DATE), INTERVAL 1 DAY)   as max_date,
    FROM payments
)

SELECT
    CAST(
        TIMESTAMP_ADD(
            (SELECT min_date FROM min_max_dates), 
            INTERVAL n DAY
        ) AS TIMESTAMP
    ) AS reporting_date,
FROM 
  UNNEST(
    GENERATE_ARRAY(
        0, 
        DATE_DIFF(
            (SELECT max_date FROM min_max_dates),
            (SELECT min_date FROM min_max_dates),
            DAY
        )
    )
) AS n;


[0m21:16:46.442733 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:e9769b09-ce3e-47fd-83ef-865637b0c47f&page=queryresults
[0m21:16:47.106200 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8156354430>]}
[0m21:16:47.107139 [info ] [Thread-1  ]: 3 of 4 OK created sql view model oscreditrisk.date_spine ....................... [[32mCREATE VIEW (0 processed)[0m in 1.65s]
[0m21:16:47.108151 [debug] [Thread-1  ]: Finished running node model.creditrisk.date_spine
[0m21:16:47.109248 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m21:16:47.110055 [info ] [Thread-1  ]: 4 of 4 START sql view model oscreditrisk.accounts_history_beginner ............. [RUN]
[0m21:16:47.110745 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.date_spine, now model.creditrisk.accounts_history_beginner)
[0m21:16:47.111313 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_beginner
[0m21:16:47.118910 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_beginner"
[0m21:16:47.120724 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_beginner
[0m21:16:47.125416 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_beginner"
[0m21:16:47.126489 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:16:47.127273 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_beginner"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
  OPTIONS()
  as /*
    This transformations is generating the first version of the core dataset (beginner version). 
    It is essentially : 
    - Joining the accounts dataset with a date spine for the target granuarity
    - Grouping the payment by day, and joining them to the accounts history
    - Calculating cumulated sums to describe the cumulated amount paid, and a few other useful fields
*/

WITH accounts as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

payments as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

date_spine as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`date_spine`
),

accounts_with_spine as (
  SELECT 
    *,
    TIMESTAMP_DIFF(reporting_date, registration_date, DAY) + 1 as reporting_day,
  FROM accounts
  LEFT JOIN date_spine
  ON accounts.registration_date <= date_spine.reporting_date
),

payments_grouped_by_day as (
  SELECT 
    account_id,
    
    DATE_ADD(
      DATE_TRUNC(payment_effective_date, DAY), 
      INTERVAL 1 DAY
    ) as reporting_date,

    SUM(amount) as amount,
    SUM(
      IF(not down_payment, amount, 0)
    ) as amount_excl_dp,

  FROM payments
  GROUP BY ALL
),

joint as (
  SELECT 
    * EXCEPT(amount, amount_excl_dp),
    COALESCE(amount,          0) as amount,
    COALESCE(amount_excl_dp,  0) as amount_excl_dp,
  FROM accounts_with_spine 
  LEFT JOIN payments_grouped_by_day 
  USING(account_id, reporting_date)
),

calc_paid_total as (
  SELECT 
    *,
    SUM(amount)         OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total,
    SUM(amount_excl_dp) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_excl_dp,
    
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate) + down_payment_days_included as nominal_term,
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate)                              as nominal_term_excl_dp,
  FROM joint
)

SELECT * FROM calc_paid_total;


[0m21:16:48.129332 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:c9b1a1fa-0436-4394-a30e-fa020a5a1183&page=queryresults
[0m21:16:48.793201 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b105aa3f-b3b8-4d18-a4f4-f8681e7c68f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f81560b2670>]}
[0m21:16:48.794169 [info ] [Thread-1  ]: 4 of 4 OK created sql view model oscreditrisk.accounts_history_beginner ........ [[32mCREATE VIEW (0 processed)[0m in 1.68s]
[0m21:16:48.795206 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m21:16:48.796792 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:16:48.797397 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_beginner' was properly closed.
[0m21:16:48.798000 [info ] [MainThread]: 
[0m21:16:48.798562 [info ] [MainThread]: Finished running 4 view models in 0 hours 0 minutes and 9.60 seconds (9.60s).
[0m21:16:48.800364 [debug] [MainThread]: Command end result
[0m21:16:48.852820 [info ] [MainThread]: 
[0m21:16:48.853627 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:16:48.854243 [info ] [MainThread]: 
[0m21:16:48.854858 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=0 SKIP=0 TOTAL=4
[0m21:16:48.855709 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 13.84147, "process_user_time": 5.591899, "process_kernel_time": 0.900502, "process_mem_max_rss": "227733504", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:16:48.856622 [debug] [MainThread]: Command `dbt run` succeeded at 21:16:48.856461 after 13.84 seconds
[0m21:16:48.857248 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f814f260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8155a21f70>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f81554d7ca0>]}
[0m21:16:48.857834 [debug] [MainThread]: Flushing usage events
[0m21:19:07.263054 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa44e260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa450371be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa450371190>]}


============================== 21:19:07.267779 | 622df278-f7cb-44d2-93c7-cb6d711c9bb1 ==============================
[0m21:19:07.267779 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:19:07.268912 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'empty': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run --select accounts_history_advanced', 'write_json': 'True', 'fail_fast': 'False', 'static_parser': 'True', 'log_cache_events': 'False', 'printer_width': '80', 'indirect_selection': 'eager', 'profiles_dir': '/Users/david/.dbt', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'target_path': 'None', 'debug': 'False', 'partial_parse': 'True', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'no_print': 'None', 'log_format': 'default', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True'}
[0m21:19:11.553262 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '622df278-f7cb-44d2-93c7-cb6d711c9bb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa45451f4f0>]}
[0m21:19:11.630143 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '622df278-f7cb-44d2-93c7-cb6d711c9bb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa4544d7ca0>]}
[0m21:19:11.631072 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:19:11.664143 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:19:12.037294 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:19:12.037907 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:19:12.107157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '622df278-f7cb-44d2-93c7-cb6d711c9bb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa45484cee0>]}
[0m21:19:12.329355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '622df278-f7cb-44d2-93c7-cb6d711c9bb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa454879340>]}
[0m21:19:12.330145 [info ] [MainThread]: Found 5 models, 2 seeds, 480 macros
[0m21:19:12.330713 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '622df278-f7cb-44d2-93c7-cb6d711c9bb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa454867640>]}
[0m21:19:12.332436 [info ] [MainThread]: 
[0m21:19:12.333345 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:19:12.334639 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:19:12.335263 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:15.333741 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:19:15.335626 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:19:15.931585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '622df278-f7cb-44d2-93c7-cb6d711c9bb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa44e1eebe0>]}
[0m21:19:15.933267 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:19:15.933882 [info ] [MainThread]: 
[0m21:19:15.937987 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m21:19:15.938987 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.accounts_history_advanced ............. [RUN]
[0m21:19:15.940205 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_advanced)
[0m21:19:15.941036 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m21:19:16.037479 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m21:19:16.038836 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m21:19:16.084456 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m21:19:16.085660 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:19:16.086548 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
  OPTIONS()
  as /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

postponed_payments as (
    SELECT 
        *,
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.
        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses
    FROM calc_paid_total
),

prepared_for_udf as ( -- Preparing the data for the UDF (consuming arrays)
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM postponed_payments
    GROUP BY ALL
),

apply_udf AS (
  SELECT 
    *,
    oscreditrisk.payment_linearization(
      prepared_for_udf.payment_amounts, 
      prepared_for_udf.daily_rates, 
      prepared_for_udf.casted_reporting_dates
    ) as payment_amount_lin_excl_dp
  FROM prepared_for_udf
)

SELECT * FROM apply_udf;


[0m21:19:16.730922 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:4d39c020-2c28-4b9f-b1d8-4c320070b34b&page=queryresults
[0m21:19:16.732031 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "calc_paid_total" must be qualified with a dataset (e.g. dataset.table).; reason: invalid, location: calc_paid_total, message: Table "calc_paid_total" must be qualified with a dataset (e.g. dataset.table).')
[0m21:19:17.331607 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:1c3a33c1-dc12-4aa1-9f2c-40701df3bd58&page=queryresults
[0m21:19:17.332923 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:1c3a33c1-dc12-4aa1-9f2c-40701df3bd58&page=queryresults
[0m21:19:17.349244 [debug] [Thread-1  ]: Database Error in model accounts_history_advanced (models/example/1_building_core_dataset/accounts_history_advanced.sql)
  Table "calc_paid_total" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/accounts_history_advanced.sql
[0m21:19:17.352087 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '622df278-f7cb-44d2-93c7-cb6d711c9bb1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa45514cf40>]}
[0m21:19:17.353240 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.accounts_history_advanced .... [[31mERROR[0m in 1.41s]
[0m21:19:17.354341 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m21:19:17.356438 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:19:17.357124 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_advanced' was properly closed.
[0m21:19:17.357717 [info ] [MainThread]: 
[0m21:19:17.358299 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 5.02 seconds (5.02s).
[0m21:19:17.359949 [debug] [MainThread]: Command end result
[0m21:19:17.420696 [info ] [MainThread]: 
[0m21:19:17.421554 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:19:17.422108 [info ] [MainThread]: 
[0m21:19:17.422787 [error] [MainThread]:   Database Error in model accounts_history_advanced (models/example/1_building_core_dataset/accounts_history_advanced.sql)
  Table "calc_paid_total" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/accounts_history_advanced.sql
[0m21:19:17.423340 [info ] [MainThread]: 
[0m21:19:17.423930 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:19:17.424790 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 10.2735195, "process_user_time": 5.8993, "process_kernel_time": 1.113015, "process_mem_max_rss": "225308672", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:19:17.425705 [debug] [MainThread]: Command `dbt run` failed at 21:19:17.425550 after 10.27 seconds
[0m21:19:17.426350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa44e260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa44e4649a0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa44fc406a0>]}
[0m21:19:17.427228 [debug] [MainThread]: Flushing usage events
[0m21:19:31.736521 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca18a634f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1aa76250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1aa76fa0>]}


============================== 21:19:31.741377 | 0cb84f11-fc92-4143-a511-5f10456886ad ==============================
[0m21:19:31.741377 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:19:31.742544 [debug] [MainThread]: running dbt with arguments {'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'use_colors': 'True', 'log_cache_events': 'False', 'static_parser': 'True', 'debug': 'False', 'invocation_command': 'dbt run --select accounts_history_advanced', 'version_check': 'True', 'empty': 'False', 'partial_parse': 'True', 'write_json': 'True', 'quiet': 'False', 'cache_selected_only': 'False', 'warn_error': 'None', 'indirect_selection': 'eager', 'log_format': 'default', 'target_path': 'None', 'no_print': 'None', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/Users/david/.dbt', 'introspect': 'True', 'printer_width': '80', 'use_experimental_parser': 'False'}
[0m21:19:36.300345 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0cb84f11-fc92-4143-a511-5f10456886ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1eaf7430>]}
[0m21:19:36.375083 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0cb84f11-fc92-4143-a511-5f10456886ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1eaf7730>]}
[0m21:19:36.376044 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:19:36.410284 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:19:36.764166 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:19:36.764897 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:19:36.830038 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0cb84f11-fc92-4143-a511-5f10456886ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1ef4cee0>]}
[0m21:19:37.053583 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0cb84f11-fc92-4143-a511-5f10456886ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1ef7d070>]}
[0m21:19:37.054393 [info ] [MainThread]: Found 5 models, 2 seeds, 480 macros
[0m21:19:37.054940 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0cb84f11-fc92-4143-a511-5f10456886ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca18d63ee0>]}
[0m21:19:37.056599 [info ] [MainThread]: 
[0m21:19:37.057480 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:19:37.058817 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:19:37.059428 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:39.969608 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:19:39.970642 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:19:40.556230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0cb84f11-fc92-4143-a511-5f10456886ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1ef94460>]}
[0m21:19:40.557337 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:19:40.557944 [info ] [MainThread]: 
[0m21:19:40.561974 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m21:19:40.562840 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.accounts_history_advanced ............. [RUN]
[0m21:19:40.563681 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_advanced)
[0m21:19:40.564330 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m21:19:40.590039 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m21:19:40.591271 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m21:19:40.647304 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m21:19:40.649967 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:19:40.651168 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
  OPTIONS()
  as /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

postponed_payments as (
    SELECT 
        *,
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.
        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses
    FROM accounts_history
),

prepared_for_udf as ( -- Preparing the data for the UDF (consuming arrays)
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM postponed_payments
    GROUP BY ALL
),

apply_udf AS (
  SELECT 
    *,
    oscreditrisk.payment_linearization(
      prepared_for_udf.payment_amounts, 
      prepared_for_udf.daily_rates, 
      prepared_for_udf.casted_reporting_dates
    ) as payment_amount_lin_excl_dp
  FROM prepared_for_udf
)

SELECT * FROM apply_udf;


[0m21:19:41.699437 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:19413375-5d48-4ffa-80c6-7ba48fbb7010&page=queryresults
[0m21:19:42.016221 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Function not found: oscreditrisk.payment_linearization at [44:5]; reason: invalidQuery, location: query, message: Function not found: oscreditrisk.payment_linearization at [44:5]')
[0m21:19:43.632619 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:174a131c-84f8-42f6-999f-d5e7f093354c&page=queryresults
[0m21:19:43.939362 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:174a131c-84f8-42f6-999f-d5e7f093354c&page=queryresults
[0m21:19:43.960751 [debug] [Thread-1  ]: Database Error in model accounts_history_advanced (models/example/1_building_core_dataset/accounts_history_advanced.sql)
  Function not found: oscreditrisk.payment_linearization at [44:5]
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/accounts_history_advanced.sql
[0m21:19:43.969251 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0cb84f11-fc92-4143-a511-5f10456886ad', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1f954a30>]}
[0m21:19:43.970322 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.accounts_history_advanced .... [[31mERROR[0m in 3.40s]
[0m21:19:43.971320 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m21:19:43.973055 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:19:43.973584 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_advanced' was properly closed.
[0m21:19:43.974109 [info ] [MainThread]: 
[0m21:19:43.975126 [info ] [MainThread]: Finished running 1 view model in 0 hours 0 minutes and 6.92 seconds (6.92s).
[0m21:19:43.976514 [debug] [MainThread]: Command end result
[0m21:19:44.087010 [info ] [MainThread]: 
[0m21:19:44.088167 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:19:44.088851 [info ] [MainThread]: 
[0m21:19:44.089614 [error] [MainThread]:   Database Error in model accounts_history_advanced (models/example/1_building_core_dataset/accounts_history_advanced.sql)
  Function not found: oscreditrisk.payment_linearization at [44:5]
  compiled code at target/run/creditrisk/models/example/1_building_core_dataset/accounts_history_advanced.sql
[0m21:19:44.090274 [info ] [MainThread]: 
[0m21:19:44.090928 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:19:44.091811 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 12.4651985, "process_user_time": 6.043438, "process_kernel_time": 1.106305, "process_mem_max_rss": "226508800", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:19:44.093110 [debug] [MainThread]: Command `dbt run` failed at 21:19:44.092833 after 12.47 seconds
[0m21:19:44.094874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca18a634f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1eaf7430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fca1ef3dc10>]}
[0m21:19:44.095814 [debug] [MainThread]: Flushing usage events
[0m21:21:40.369633 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4022215b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4042b1d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4042b13d0>]}


============================== 21:21:40.375539 | d3912988-e758-40ea-8b18-17096717c061 ==============================
[0m21:21:40.375539 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:21:40.376556 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'use_colors': 'True', 'quiet': 'False', 'profiles_dir': '/Users/david/.dbt', 'no_print': 'None', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'indirect_selection': 'eager', 'fail_fast': 'False', 'static_parser': 'True', 'cache_selected_only': 'False', 'target_path': 'None', 'printer_width': '80', 'invocation_command': 'dbt run --select accounts_history_advanced', 'introspect': 'True', 'log_format': 'default', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'log_cache_events': 'False', 'use_experimental_parser': 'False'}
[0m21:21:44.913877 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd3912988-e758-40ea-8b18-17096717c061', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff404268dc0>]}
[0m21:21:45.073675 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd3912988-e758-40ea-8b18-17096717c061', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff404147af0>]}
[0m21:21:45.074663 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:21:45.108028 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:21:45.701170 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:21:45.703064 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:21:45.837031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd3912988-e758-40ea-8b18-17096717c061', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff408877130>]}
[0m21:21:46.071217 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd3912988-e758-40ea-8b18-17096717c061', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff40889c520>]}
[0m21:21:46.072218 [info ] [MainThread]: Found 5 models, 2 seeds, 1 operation, 480 macros
[0m21:21:46.072856 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3912988-e758-40ea-8b18-17096717c061', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff408877f10>]}
[0m21:21:46.074592 [info ] [MainThread]: 
[0m21:21:46.075547 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:21:46.077003 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:21:46.077813 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:21:49.371875 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:21:49.374267 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:21:50.214719 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd3912988-e758-40ea-8b18-17096717c061', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff408438730>]}
[0m21:21:50.215718 [info ] [MainThread]: 
[0m21:21:50.216348 [info ] [MainThread]: Running 1 on-run-start hook
[0m21:21:50.237561 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m21:21:50.247286 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m21:21:50.248446 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:21:50.249546 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m21:21:50.939637 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:5a439bac-10a7-4426-bf99-ef178213d411&page=queryresults
[0m21:21:52.375592 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.13s]
[0m21:21:52.376524 [info ] [MainThread]: 
[0m21:21:52.377503 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:21:52.378116 [info ] [MainThread]: 
[0m21:21:52.382116 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m21:21:52.383056 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.accounts_history_advanced ............. [RUN]
[0m21:21:52.383805 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_advanced)
[0m21:21:52.384417 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m21:21:52.390014 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m21:21:52.391766 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m21:21:52.443846 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m21:21:52.445130 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:21:52.446043 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
  OPTIONS()
  as /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

postponed_payments as (
    SELECT 
        *,
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.
        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses
    FROM accounts_history
),

-- Preparing the data for the UDF (consuming arrays)
prepared_for_udf as (
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM postponed_payments
    GROUP BY ALL
),

apply_udf AS (
  SELECT 
    *,
    oscreditrisk.payment_linearization(
      prepared_for_udf.payment_amounts, 
      prepared_for_udf.daily_rates, 
      prepared_for_udf.casted_reporting_dates
    ) as payment_amount_lin_excl_dp
  FROM prepared_for_udf
)

SELECT * FROM apply_udf;


[0m21:21:53.455119 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:8ca6236b-04f8-49c0-9c5a-97a3e29efdd6&page=queryresults
[0m21:21:54.204445 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd3912988-e758-40ea-8b18-17096717c061', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff40846f0a0>]}
[0m21:21:54.205518 [info ] [Thread-1  ]: 1 of 1 OK created sql view model oscreditrisk.accounts_history_advanced ........ [[32mCREATE VIEW (0 processed)[0m in 1.82s]
[0m21:21:54.206529 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m21:21:54.208502 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:21:54.209065 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_advanced' was properly closed.
[0m21:21:54.209646 [info ] [MainThread]: 
[0m21:21:54.210268 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 8.13 seconds (8.13s).
[0m21:21:54.211653 [debug] [MainThread]: Command end result
[0m21:21:54.271163 [info ] [MainThread]: 
[0m21:21:54.272341 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:21:54.272918 [info ] [MainThread]: 
[0m21:21:54.273695 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:21:54.274659 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 14.00593, "process_user_time": 6.30393, "process_kernel_time": 1.159155, "process_mem_max_rss": "227614720", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:21:54.275730 [debug] [MainThread]: Command `dbt run` succeeded at 21:21:54.275484 after 14.01 seconds
[0m21:21:54.276410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff4022215b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff403a4a8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff404147af0>]}
[0m21:21:54.277016 [debug] [MainThread]: Flushing usage events
[0m21:26:19.579867 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbaaa32580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbac939be0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbac939190>]}


============================== 21:26:19.584968 | 8dda4fed-3c33-459e-858e-785da5481fc8 ==============================
[0m21:26:19.584968 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:26:19.586000 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'send_anonymous_usage_stats': 'True', 'printer_width': '80', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'quiet': 'False', 'introspect': 'True', 'target_path': 'None', 'cache_selected_only': 'False', 'use_experimental_parser': 'False', 'empty': 'False', 'debug': 'False', 'indirect_selection': 'eager', 'write_json': 'True', 'warn_error': 'None', 'profiles_dir': '/Users/david/.dbt', 'static_parser': 'True', 'invocation_command': 'dbt run --select accounts_history_advanced', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'partial_parse': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'no_print': 'None', 'fail_fast': 'False', 'log_format': 'default'}
[0m21:26:24.268931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '8dda4fed-3c33-459e-858e-785da5481fc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb0c1fa30>]}
[0m21:26:24.342312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '8dda4fed-3c33-459e-858e-785da5481fc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb0bd7ca0>]}
[0m21:26:24.343232 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:26:24.374176 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:26:24.731783 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:26:24.732350 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:26:24.814238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '8dda4fed-3c33-459e-858e-785da5481fc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb1041ee0>]}
[0m21:26:25.108149 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '8dda4fed-3c33-459e-858e-785da5481fc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb1042c70>]}
[0m21:26:25.110263 [info ] [MainThread]: Found 5 models, 2 seeds, 1 operation, 480 macros
[0m21:26:25.115405 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8dda4fed-3c33-459e-858e-785da5481fc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb10735b0>]}
[0m21:26:25.119700 [info ] [MainThread]: 
[0m21:26:25.121981 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:26:25.124972 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:26:25.127356 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:26:28.645609 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:26:28.647218 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:26:29.254322 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '8dda4fed-3c33-459e-858e-785da5481fc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb0516c70>]}
[0m21:26:29.255290 [info ] [MainThread]: 
[0m21:26:29.255900 [info ] [MainThread]: Running 1 on-run-start hook
[0m21:26:29.275587 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m21:26:29.283068 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m21:26:29.283900 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:26:29.284649 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m21:26:29.974793 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:957509e5-e37d-42ae-a558-2439e7837741&page=queryresults
[0m21:26:31.672535 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.39s]
[0m21:26:31.674784 [info ] [MainThread]: 
[0m21:26:31.675997 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:26:31.678909 [info ] [MainThread]: 
[0m21:26:31.684054 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m21:26:31.685219 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.accounts_history_advanced ............. [RUN]
[0m21:26:31.687558 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_advanced)
[0m21:26:31.688829 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m21:26:31.701963 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m21:26:31.704847 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m21:26:31.772949 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m21:26:31.774749 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:26:31.775739 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
  OPTIONS()
  as /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

postponed_payments as (
    SELECT 
        *,
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.
        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses
    FROM accounts_history
),

-- Preparing the data for the UDF (consuming arrays)
prepared_for_udf as (
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM postponed_payments
    GROUP BY ALL
),

-- applying the UDF on prepared data format
apply_udf AS (
    SELECT 
        *,
        oscreditrisk.payment_linearization(
        prepared_for_udf.payment_amounts, 
        prepared_for_udf.daily_rates, 
        prepared_for_udf.casted_reporting_dates
        ) as payment_amount_lin_excl_dp
    FROM prepared_for_udf
),

-- Expanding the results before joining them back
expand_udf_result AS (
    SELECT
        account_id,
        CAST(reporting_date AS TIMESTAMP) as reporting_date,
        amount_lin
    FROM
        apply_udf,
        UNNEST(apply_udf.casted_reporting_dates)            AS reporting_date   WITH OFFSET AS pos
    JOIN UNNEST(apply_udf.payment_amount_lin_excl_dp)     AS amount_lin       WITH OFFSET AS val_pos
    ON pos = val_pos
),

join_back_on_dataset as (
    SELECT 
        *,
        SUM(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_lin,
    FROM postponed_payments 
    LEFT JOIN expand_udf_result USING(account_id, reporting_date)
)

SELECT * FROM join_back_on_dataset;


[0m21:26:32.900367 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:7954d77d-e850-4e3c-8a30-3643ed85256d&page=queryresults
[0m21:26:33.602902 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '8dda4fed-3c33-459e-858e-785da5481fc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb1a08610>]}
[0m21:26:33.604178 [info ] [Thread-1  ]: 1 of 1 OK created sql view model oscreditrisk.accounts_history_advanced ........ [[32mCREATE VIEW (0 processed)[0m in 1.91s]
[0m21:26:33.605510 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m21:26:33.607349 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:26:33.607848 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_advanced' was properly closed.
[0m21:26:33.608349 [info ] [MainThread]: 
[0m21:26:33.608901 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 8.49 seconds (8.49s).
[0m21:26:33.610549 [debug] [MainThread]: Command end result
[0m21:26:33.687499 [info ] [MainThread]: 
[0m21:26:33.688502 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:26:33.689328 [info ] [MainThread]: 
[0m21:26:33.690478 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:26:33.692051 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 14.233911, "process_user_time": 6.27683, "process_kernel_time": 1.243824, "process_mem_max_rss": "227418112", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:26:33.693135 [debug] [MainThread]: Command `dbt run` succeeded at 21:26:33.692959 after 14.24 seconds
[0m21:26:33.694071 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbaaa32580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb0c49250>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdbb0bd7ca0>]}
[0m21:26:33.695463 [debug] [MainThread]: Flushing usage events
[0m21:28:13.440838 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa201a2f5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa2039f1d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa2039f13d0>]}


============================== 21:28:13.446550 | a9cd153e-3ee9-4e28-bddb-9023f5053bf1 ==============================
[0m21:28:13.446550 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:28:13.447615 [debug] [MainThread]: running dbt with arguments {'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'warn_error': 'None', 'partial_parse': 'True', 'indirect_selection': 'eager', 'invocation_command': 'dbt run --select accounts_history_advanced', 'target_path': 'None', 'log_cache_events': 'False', 'write_json': 'True', 'static_parser': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'empty': 'False', 'printer_width': '80', 'log_format': 'default', 'cache_selected_only': 'False', 'no_print': 'None', 'use_experimental_parser': 'False', 'debug': 'False', 'introspect': 'True', 'profiles_dir': '/Users/david/.dbt', 'quiet': 'False', 'use_colors': 'True'}
[0m21:28:18.686176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a9cd153e-3ee9-4e28-bddb-9023f5053bf1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa2039a8b50>]}
[0m21:28:18.767601 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a9cd153e-3ee9-4e28-bddb-9023f5053bf1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa207d155b0>]}
[0m21:28:18.768541 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:28:18.804086 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:28:19.354648 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:28:19.357049 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:28:19.559960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a9cd153e-3ee9-4e28-bddb-9023f5053bf1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa208041ee0>]}
[0m21:28:19.989122 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a9cd153e-3ee9-4e28-bddb-9023f5053bf1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa208042fa0>]}
[0m21:28:19.989940 [info ] [MainThread]: Found 5 models, 2 seeds, 1 operation, 480 macros
[0m21:28:19.990506 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9cd153e-3ee9-4e28-bddb-9023f5053bf1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa207e45550>]}
[0m21:28:19.992415 [info ] [MainThread]: 
[0m21:28:19.994368 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:28:19.997179 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:28:19.998520 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:28:23.743796 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:28:23.744891 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:28:24.523744 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9cd153e-3ee9-4e28-bddb-9023f5053bf1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa2075f4040>]}
[0m21:28:24.524816 [info ] [MainThread]: 
[0m21:28:24.525506 [info ] [MainThread]: Running 1 on-run-start hook
[0m21:28:24.560368 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m21:28:24.578385 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m21:28:24.581748 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:28:24.583353 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m21:28:25.235125 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:40373320-6d37-4c59-93d9-93459a57024d&page=queryresults
[0m21:28:26.917506 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.34s]
[0m21:28:26.918563 [info ] [MainThread]: 
[0m21:28:26.919359 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:28:26.919860 [info ] [MainThread]: 
[0m21:28:26.924288 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m21:28:26.925376 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.accounts_history_advanced ............. [RUN]
[0m21:28:26.926200 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_advanced)
[0m21:28:26.926836 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m21:28:26.932776 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m21:28:26.934055 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m21:28:26.983644 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m21:28:26.984887 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:28:26.985746 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
  OPTIONS()
  as /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

additional_kpis as (
    SELECT 
        *,
        
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.

        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses

        GREATEST(
            0,
            MAX(reporting_day - down_payment_days_included) OVER(PARTITION BY account_id)
         ) as account_age_excl_dp_in_days,

    FROM accounts_history
),

-- Preparing the data for the UDF (consuming arrays)
prepared_for_udf as (
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM additional_kpis
    GROUP BY ALL
),

-- applying the UDF on prepared data format
apply_udf AS (
    SELECT 
        *,
        oscreditrisk.payment_linearization(
        prepared_for_udf.payment_amounts, 
        prepared_for_udf.daily_rates, 
        prepared_for_udf.casted_reporting_dates
        ) as payment_amount_lin_excl_dp
    FROM prepared_for_udf
),

-- Expanding the results before joining them back
expand_udf_result AS (
    SELECT
        account_id,
        CAST(reporting_date AS TIMESTAMP) as reporting_date,
        amount_lin
    FROM
        apply_udf,
        UNNEST(apply_udf.casted_reporting_dates)            AS reporting_date   WITH OFFSET AS pos
    JOIN UNNEST(apply_udf.payment_amount_lin_excl_dp)     AS amount_lin       WITH OFFSET AS val_pos
    ON pos = val_pos
),

join_back_on_dataset as (
    SELECT 
        *,
        SUM(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_lin,
    FROM additional_kpis 
    LEFT JOIN expand_udf_result USING(account_id, reporting_date)
)

SELECT * FROM join_back_on_dataset;


[0m21:28:28.060488 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:2f386228-8dfb-4433-9236-11ced388f913&page=queryresults
[0m21:28:28.845250 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a9cd153e-3ee9-4e28-bddb-9023f5053bf1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa208908220>]}
[0m21:28:28.847003 [info ] [Thread-1  ]: 1 of 1 OK created sql view model oscreditrisk.accounts_history_advanced ........ [[32mCREATE VIEW (0 processed)[0m in 1.92s]
[0m21:28:28.849444 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m21:28:28.853047 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:28:28.853889 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_advanced' was properly closed.
[0m21:28:28.854752 [info ] [MainThread]: 
[0m21:28:28.856060 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 8.86 seconds (8.86s).
[0m21:28:28.857755 [debug] [MainThread]: Command end result
[0m21:28:28.982350 [info ] [MainThread]: 
[0m21:28:28.983647 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:28:28.984692 [info ] [MainThread]: 
[0m21:28:28.985619 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m21:28:28.986612 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 15.643644, "process_user_time": 6.376104, "process_kernel_time": 1.24981, "process_mem_max_rss": "227815424", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:28:28.987679 [debug] [MainThread]: Command `dbt run` succeeded at 21:28:28.987490 after 15.64 seconds
[0m21:28:28.988566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa201a2f5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa2031a4910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fa207d155b0>]}
[0m21:28:28.989850 [debug] [MainThread]: Flushing usage events
[0m21:45:59.157566 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd5d260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd5f26abe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd5f26a190>]}


============================== 21:45:59.162685 | a36f1de2-f19b-488f-9b03-0f03386e5e4b ==============================
[0m21:45:59.162685 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:45:59.163697 [debug] [MainThread]: running dbt with arguments {'use_colors': 'True', 'use_experimental_parser': 'False', 'version_check': 'True', 'log_format': 'default', 'empty': 'False', 'fail_fast': 'False', 'partial_parse': 'True', 'invocation_command': 'dbt run --select 1_building_core_dataset', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'static_parser': 'True', 'target_path': 'None', 'printer_width': '80', 'indirect_selection': 'eager', 'introspect': 'True', 'warn_error': 'None', 'profiles_dir': '/Users/david/.dbt', 'write_json': 'True', 'debug': 'False'}
[0m21:46:03.282287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a36f1de2-f19b-488f-9b03-0f03386e5e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd62c81ee0>]}
[0m21:46:03.356430 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a36f1de2-f19b-488f-9b03-0f03386e5e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd5e472460>]}
[0m21:46:03.357379 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:46:03.389485 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:46:03.813998 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:46:03.814688 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:46:03.905431 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a36f1de2-f19b-488f-9b03-0f03386e5e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd63874130>]}
[0m21:46:04.227789 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a36f1de2-f19b-488f-9b03-0f03386e5e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd63897130>]}
[0m21:46:04.228657 [info ] [MainThread]: Found 5 models, 2 seeds, 1 operation, 480 macros
[0m21:46:04.229233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a36f1de2-f19b-488f-9b03-0f03386e5e4b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd634b40d0>]}
[0m21:46:04.230217 [warn ] [MainThread]: The selection criterion '1_building_core_dataset' does not match any enabled nodes
[0m21:46:04.232024 [info ] [MainThread]: 
[0m21:46:04.232965 [warn ] [MainThread]: Nothing to do. Try checking your model configs and model specification args
[0m21:46:04.237132 [debug] [MainThread]: Command end result
[0m21:46:04.301779 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 5.241912, "process_user_time": 5.597503, "process_kernel_time": 0.994377, "process_mem_max_rss": "219832320", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:46:04.303483 [debug] [MainThread]: Command `dbt run` succeeded at 21:46:04.303186 after 5.24 seconds
[0m21:46:04.304206 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd5d260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd634aae50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fdd5e472460>]}
[0m21:46:04.304882 [debug] [MainThread]: Flushing usage events
[0m21:46:37.590699 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec2a354f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec4b70d00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec4b70100>]}


============================== 21:46:37.595530 | c5ecd43e-4a68-4ff9-8ea5-396cb019523a ==============================
[0m21:46:37.595530 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:46:37.596595 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'empty': 'False', 'warn_error': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'profiles_dir': '/Users/david/.dbt', 'fail_fast': 'False', 'quiet': 'False', 'printer_width': '80', 'cache_selected_only': 'False', 'version_check': 'True', 'log_cache_events': 'False', 'log_format': 'default', 'indirect_selection': 'eager', 'use_colors': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'write_json': 'True', 'no_print': 'None', 'introspect': 'True', 'static_parser': 'True', 'invocation_command': 'dbt run --select 1+accounts_history_advanced', 'target_path': 'None'}
[0m21:46:41.690793 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec8ad6220>]}
[0m21:46:41.782448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec84b5b50>]}
[0m21:46:41.783774 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:46:41.819810 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:46:42.224176 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:46:42.224804 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:46:42.312168 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec9874130>]}
[0m21:46:42.570989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec98975b0>]}
[0m21:46:42.571825 [info ] [MainThread]: Found 5 models, 2 seeds, 1 operation, 480 macros
[0m21:46:42.572486 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec98352e0>]}
[0m21:46:42.575038 [info ] [MainThread]: 
[0m21:46:42.576298 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:46:42.583752 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:46:42.584567 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:46:46.047261 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:46:46.048935 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:46:46.664277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec2f714f0>]}
[0m21:46:46.665165 [info ] [MainThread]: 
[0m21:46:46.665799 [info ] [MainThread]: Running 1 on-run-start hook
[0m21:46:46.685514 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m21:46:46.693665 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m21:46:46.694560 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:46:46.695317 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m21:46:47.403316 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:c9cd1639-2caa-4ad2-b715-bfcab9587b44&page=queryresults
[0m21:46:48.858367 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.16s]
[0m21:46:48.859043 [info ] [MainThread]: 
[0m21:46:48.859814 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:46:48.860353 [info ] [MainThread]: 
[0m21:46:48.863985 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m21:46:48.865017 [info ] [Thread-1  ]: 1 of 2 START sql table model oscreditrisk.accounts_history_beginner ............ [RUN]
[0m21:46:48.865876 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_beginner)
[0m21:46:48.866497 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_beginner
[0m21:46:48.875521 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_beginner"
[0m21:46:48.876958 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_beginner
[0m21:46:48.901194 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:46:49.869167 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_beginner"
[0m21:46:49.871668 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_beginner"} */

  
    

    create or replace table `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
      
    partition by timestamp_trunc(reporting_date, day)
    cluster by account_id

    OPTIONS()
    as (
      /*
    This transformations is generating the first version of the core dataset (beginner version). 
    It is essentially : 
    - Joining the accounts dataset with a date spine for the target granuarity
    - Grouping the payment by day, and joining them to the accounts history
    - Calculating cumulated sums to describe the cumulated amount paid, and a few other useful fields
*/



WITH accounts as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

payments as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

date_spine as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`date_spine`
),

accounts_with_spine as (
  SELECT 
    *,
    TIMESTAMP_DIFF(reporting_date, registration_date, DAY) + 1 as reporting_day,
  FROM accounts
  LEFT JOIN date_spine
  ON accounts.registration_date <= date_spine.reporting_date
),

payments_grouped_by_day as (
  SELECT 
    account_id,
    
    DATE_ADD(
      DATE_TRUNC(payment_effective_date, DAY), 
      INTERVAL 1 DAY
    ) as reporting_date,

    SUM(amount) as amount,
    SUM(
      IF(not down_payment, amount, 0)
    ) as amount_excl_dp,

  FROM payments
  GROUP BY ALL
),

joint as (
  SELECT 
    * EXCEPT(amount, amount_excl_dp),
    COALESCE(amount,          0) as amount,
    COALESCE(amount_excl_dp,  0) as amount_excl_dp,
  FROM accounts_with_spine 
  LEFT JOIN payments_grouped_by_day 
  USING(account_id, reporting_date)
),

calc_paid_total as (
  SELECT 
    *,
    SUM(amount)         OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total,
    SUM(amount_excl_dp) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_excl_dp,
    
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate) + down_payment_days_included as nominal_term,
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate)                              as nominal_term_excl_dp,
  FROM joint
)

SELECT * FROM calc_paid_total
    );
  
[0m21:46:50.529320 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:cd4c576c-35e4-4b6f-a62d-923dd7fd4460&page=queryresults
[0m21:47:25.700153 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec84c1670>]}
[0m21:47:25.702136 [info ] [Thread-1  ]: 1 of 2 OK created sql table model oscreditrisk.accounts_history_beginner ....... [[32mCREATE TABLE (3.4m rows, 6.2 MiB processed)[0m in 36.83s]
[0m21:47:25.703369 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m21:47:25.704564 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m21:47:25.705565 [info ] [Thread-1  ]: 2 of 2 START sql table model oscreditrisk.accounts_history_advanced ............ [RUN]
[0m21:47:25.706425 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.accounts_history_beginner, now model.creditrisk.accounts_history_advanced)
[0m21:47:25.707022 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m21:47:25.713819 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m21:47:25.715554 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m21:47:25.721882 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:47:26.808690 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m21:47:26.810128 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */

  
    

    create or replace table `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
      
    partition by timestamp_trunc(reporting_date, day)
    cluster by account_id

    OPTIONS()
    as (
      /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/



WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

additional_kpis as (
    SELECT 
        *,
        
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.

        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses

        GREATEST(
            0,
            MAX(reporting_day - down_payment_days_included) OVER(PARTITION BY account_id)
         ) as account_age_excl_dp_in_days,

    FROM accounts_history
),

-- Preparing the data for the UDF (consuming arrays)
prepared_for_udf as (
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM additional_kpis
    GROUP BY ALL
),

-- applying the UDF on prepared data format
apply_udf AS (
    SELECT 
        *,
        oscreditrisk.payment_linearization(
        prepared_for_udf.payment_amounts, 
        prepared_for_udf.daily_rates, 
        prepared_for_udf.casted_reporting_dates
        ) as payment_amount_lin_excl_dp
    FROM prepared_for_udf
),

-- Expanding the results before joining them back
expand_udf_result AS (
    SELECT
        account_id,
        CAST(reporting_date AS TIMESTAMP) as reporting_date,
        amount_lin
    FROM
        apply_udf,
        UNNEST(apply_udf.casted_reporting_dates)            AS reporting_date   WITH OFFSET AS pos
    JOIN UNNEST(apply_udf.payment_amount_lin_excl_dp)     AS amount_lin       WITH OFFSET AS val_pos
    ON pos = val_pos
),

join_back_on_dataset as (
    SELECT 
        *,
        SUM(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_lin,
        IF(
            amount_lin = 0 AND LAG(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day) > 0,
            reporting_date,
            Null
        ) as last_disablement,
    FROM additional_kpis 
    LEFT JOIN expand_udf_result USING(account_id, reporting_date)
),

final_kpis as (
  SELECT 
    *,
    CASE 
        WHEN reporting_day <= down_payment_days_included THEN 'ENABLED'
        WHEN paid_total >= unlock_price THEN 'UNLOCKED'
        WHEN amount_lin > 0   THEN 'ENABLED'
        WHEN amount_lin <= 0  THEN 'DISABLED'
    END as reporting_date_status,
    CASE 
        WHEN amount_lin = 0 
        THEN DATE_DIFF(
            reporting_date, 
            LAST_VALUE(last_disablement IGNORE NULLS) OVER(PARTITION BY account_id ORDER BY reporting_day),
            DAY
        ) 
    END as days_disabled,
  FROM join_back_on_dataset
)

SELECT * FROM final_kpis
    );
  
[0m21:47:27.417813 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:db13cf95-c856-4770-946c-07bc0ab08bf7&page=queryresults
[0m21:48:04.102255 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c5ecd43e-4a68-4ff9-8ea5-396cb019523a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9eca309220>]}
[0m21:48:04.103998 [info ] [Thread-1  ]: 2 of 2 OK created sql table model oscreditrisk.accounts_history_advanced ....... [[32mCREATE TABLE (3.4m rows, 358.0 MiB processed)[0m in 38.40s]
[0m21:48:04.104984 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m21:48:04.106493 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:48:04.106974 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_advanced' was properly closed.
[0m21:48:04.107566 [info ] [MainThread]: 
[0m21:48:04.108110 [info ] [MainThread]: Finished running 2 table models, 1 project hook in 0 hours 1 minutes and 21.53 seconds (81.53s).
[0m21:48:04.109394 [debug] [MainThread]: Command end result
[0m21:48:04.171903 [info ] [MainThread]: 
[0m21:48:04.172775 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:48:04.173339 [info ] [MainThread]: 
[0m21:48:04.173932 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m21:48:04.174782 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 86.674774, "process_user_time": 6.037291, "process_kernel_time": 1.004635, "process_mem_max_rss": "227942400", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:48:04.175730 [debug] [MainThread]: Command `dbt run` succeeded at 21:48:04.175571 after 86.68 seconds
[0m21:48:04.176364 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec2a354f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec9898e20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9ec2f64ee0>]}
[0m21:48:04.177187 [debug] [MainThread]: Flushing usage events
[0m21:56:04.542028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea2a32550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea4af1d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea4af1400>]}


============================== 21:56:04.547707 | 0777e40a-5848-4ba8-b5fb-d7e2fcceda3b ==============================
[0m21:56:04.547707 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:56:04.548713 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'write_json': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'target_path': 'None', 'invocation_command': 'dbt run --select 1+accounts_history_advanced', 'introspect': 'True', 'no_print': 'None', 'debug': 'False', 'version_check': 'True', 'printer_width': '80', 'static_parser': 'True', 'warn_error': 'None', 'use_colors': 'True', 'fail_fast': 'False', 'log_cache_events': 'False', 'empty': 'False', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'partial_parse': 'True', 'profiles_dir': '/Users/david/.dbt', 'cache_selected_only': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs'}
[0m21:56:09.366948 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea8bbc370>]}
[0m21:56:09.442518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea4975e80>]}
[0m21:56:09.443438 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:56:09.477038 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:56:09.843855 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:56:09.844480 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:56:09.922989 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea8f2cdc0>]}
[0m21:56:10.161596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea8c4c820>]}
[0m21:56:10.162492 [info ] [MainThread]: Found 6 models, 2 seeds, 1 operation, 480 macros
[0m21:56:10.163061 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea8bcf460>]}
[0m21:56:10.164850 [info ] [MainThread]: 
[0m21:56:10.165704 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:56:10.172650 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:56:10.173396 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:56:13.353375 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:56:13.355292 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:56:13.964943 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea4ac1220>]}
[0m21:56:13.965969 [info ] [MainThread]: 
[0m21:56:13.966622 [info ] [MainThread]: Running 1 on-run-start hook
[0m21:56:13.989017 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m21:56:13.998106 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m21:56:13.998950 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:56:13.999697 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m21:56:14.684531 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:e90873f5-2da8-461b-92a8-c473c211d9e7&page=queryresults
[0m21:56:16.217776 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.22s]
[0m21:56:16.218459 [info ] [MainThread]: 
[0m21:56:16.219194 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:56:16.219698 [info ] [MainThread]: 
[0m21:56:16.224665 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m21:56:16.225831 [info ] [Thread-1  ]: 1 of 2 START sql table model oscreditrisk.accounts_history_beginner ............ [RUN]
[0m21:56:16.226846 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_beginner)
[0m21:56:16.227480 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_beginner
[0m21:56:16.234317 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_beginner"
[0m21:56:16.235685 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_beginner
[0m21:56:16.349065 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:56:17.176807 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_beginner"
[0m21:56:17.179189 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_beginner"} */

  
    

    create or replace table `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
      
    partition by timestamp_trunc(reporting_date, day)
    cluster by account_id

    OPTIONS()
    as (
      /*
    This transformations is generating the first version of the core dataset (beginner version). 
    It is essentially : 
    - Joining the accounts dataset with a date spine for the target granuarity
    - Grouping the payment by day, and joining them to the accounts history
    - Calculating cumulated sums to describe the cumulated amount paid, and a few other useful fields
*/



WITH accounts as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

payments as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

date_spine as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`date_spine`
),

accounts_with_spine as (
  SELECT 
    *,
    TIMESTAMP_DIFF(reporting_date, registration_date, DAY) + 1 as reporting_day,
  FROM accounts
  LEFT JOIN date_spine
  ON accounts.registration_date <= date_spine.reporting_date
),

payments_grouped_by_day as (
  SELECT 
    account_id,
    
    DATE_ADD(
      DATE_TRUNC(payment_effective_date, DAY), 
      INTERVAL 1 DAY
    ) as reporting_date,

    SUM(amount) as amount,
    SUM(
      IF(not down_payment, amount, 0)
    ) as amount_excl_dp,

  FROM payments
  GROUP BY ALL
),

joint as (
  SELECT 
    * EXCEPT(amount, amount_excl_dp),
    COALESCE(amount,          0) as amount,
    COALESCE(amount_excl_dp,  0) as amount_excl_dp,
  FROM accounts_with_spine 
  LEFT JOIN payments_grouped_by_day 
  USING(account_id, reporting_date)
),

calc_paid_total as (
  SELECT 
    *,
    SUM(amount)         OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total,
    SUM(amount_excl_dp) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_excl_dp,
    
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate) + down_payment_days_included as nominal_term,
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate)                              as nominal_term_excl_dp,

    MAX(reporting_day) OVER(PARTITION BY account_id) as account_age_in_days,
    GREATEST(
            0,
            MAX(reporting_day - down_payment_days_included) OVER(PARTITION BY account_id)
    ) as account_age_excl_dp_in_days,

  FROM joint
)

SELECT * FROM calc_paid_total
    );
  
[0m21:56:18.066120 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:8fcf6c95-17cb-463a-843f-e958535caad0&page=queryresults
[0m21:56:45.747266 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea214e610>]}
[0m21:56:45.748425 [info ] [Thread-1  ]: 1 of 2 OK created sql table model oscreditrisk.accounts_history_beginner ....... [[32mCREATE TABLE (3.4m rows, 6.2 MiB processed)[0m in 29.52s]
[0m21:56:45.749521 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m21:56:45.750746 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m21:56:45.751582 [info ] [Thread-1  ]: 2 of 2 START sql table model oscreditrisk.accounts_history_advanced ............ [RUN]
[0m21:56:45.752303 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.accounts_history_beginner, now model.creditrisk.accounts_history_advanced)
[0m21:56:45.752883 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m21:56:45.759519 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m21:56:45.761383 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m21:56:45.765215 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:56:46.356907 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m21:56:46.359943 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */

  
    

    create or replace table `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
      
    partition by timestamp_trunc(reporting_date, day)
    cluster by account_id

    OPTIONS()
    as (
      /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/



WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

additional_kpis as (
    SELECT 
        *,
        
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.

        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses

    FROM accounts_history
),

-- Preparing the data for the UDF (consuming arrays)
prepared_for_udf as (
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM additional_kpis
    GROUP BY ALL
),

-- applying the UDF on prepared data format
apply_udf AS (
    SELECT 
        *,
        oscreditrisk.payment_linearization(
        prepared_for_udf.payment_amounts, 
        prepared_for_udf.daily_rates, 
        prepared_for_udf.casted_reporting_dates
        ) as payment_amount_lin_excl_dp
    FROM prepared_for_udf
),

-- Expanding the results before joining them back
expand_udf_result AS (
    SELECT
        account_id,
        CAST(reporting_date AS TIMESTAMP) as reporting_date,
        amount_lin
    FROM
        apply_udf,
        UNNEST(apply_udf.casted_reporting_dates)            AS reporting_date   WITH OFFSET AS pos
    JOIN UNNEST(apply_udf.payment_amount_lin_excl_dp)     AS amount_lin       WITH OFFSET AS val_pos
    ON pos = val_pos
),

join_back_on_dataset as (
    SELECT 
        *,
        SUM(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_lin,
        IF(
            amount_lin = 0 AND LAG(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day) > 0,
            reporting_date,
            Null
        ) as last_disablement,
    FROM additional_kpis 
    LEFT JOIN expand_udf_result USING(account_id, reporting_date)
),

-- As a last step, use this information to calculate useful fields: status and number of days disabled.
final_kpis as (
  SELECT 
    *,
    CASE 
        WHEN reporting_day <= down_payment_days_included THEN 'ENABLED'
        WHEN paid_total >= unlock_price THEN 'UNLOCKED'
        WHEN amount_lin > 0   THEN 'ENABLED'
        WHEN amount_lin <= 0  THEN 'DISABLED'
    END as reporting_date_status,
    CASE 
        WHEN amount_lin = 0 
        THEN DATE_DIFF(
            reporting_date, 
            LAST_VALUE(last_disablement IGNORE NULLS) OVER(PARTITION BY account_id ORDER BY reporting_day),
            DAY
        ) 
    END as days_disabled,
  FROM join_back_on_dataset
)

SELECT * FROM final_kpis
    );
  
[0m21:56:46.835736 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:1fa43142-49ea-4b64-babf-8785a0fab5aa&page=queryresults
[0m21:57:27.083605 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0777e40a-5848-4ba8-b5fb-d7e2fcceda3b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea9579790>]}
[0m21:57:27.085339 [info ] [Thread-1  ]: 2 of 2 OK created sql table model oscreditrisk.accounts_history_advanced ....... [[32mCREATE TABLE (3.4m rows, 409.2 MiB processed)[0m in 41.33s]
[0m21:57:27.086344 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m21:57:27.087930 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:57:27.088407 [debug] [MainThread]: Connection 'model.creditrisk.accounts_history_advanced' was properly closed.
[0m21:57:27.088988 [info ] [MainThread]: 
[0m21:57:27.089532 [info ] [MainThread]: Finished running 2 table models, 1 project hook in 0 hours 1 minutes and 16.92 seconds (76.92s).
[0m21:57:27.090918 [debug] [MainThread]: Command end result
[0m21:57:27.153535 [info ] [MainThread]: 
[0m21:57:27.154344 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:57:27.154891 [info ] [MainThread]: 
[0m21:57:27.155597 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m21:57:27.156639 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 82.7419, "process_user_time": 6.214898, "process_kernel_time": 1.23674, "process_mem_max_rss": "228462592", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:57:27.158277 [debug] [MainThread]: Command `dbt run` succeeded at 21:57:27.158059 after 82.74 seconds
[0m21:57:27.158988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea2a32550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea4295790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea4975e80>]}
[0m21:57:27.159603 [debug] [MainThread]: Flushing usage events
[0m21:58:28.984031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9954a275b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9956914700>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9956914520>]}


============================== 21:58:28.989926 | 822b9d7d-9f37-44ad-bb22-4839daa69898 ==============================
[0m21:58:28.989926 [info ] [MainThread]: Running with dbt=1.8.8
[0m21:58:28.990943 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'write_json': 'True', 'invocation_command': 'dbt run --select cohorts_beginner', 'introspect': 'True', 'use_colors': 'True', 'no_print': 'None', 'target_path': 'None', 'log_cache_events': 'False', 'printer_width': '80', 'debug': 'False', 'warn_error': 'None', 'static_parser': 'True', 'indirect_selection': 'eager', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True', 'log_format': 'default', 'empty': 'False', 'profiles_dir': '/Users/david/.dbt', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'fail_fast': 'False', 'quiet': 'False', 'send_anonymous_usage_stats': 'True'}
[0m21:58:33.688247 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '822b9d7d-9f37-44ad-bb22-4839daa69898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f995a4cf910>]}
[0m21:58:33.769223 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '822b9d7d-9f37-44ad-bb22-4839daa69898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9956738100>]}
[0m21:58:33.770609 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m21:58:33.805338 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m21:58:34.239643 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:58:34.240355 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:58:34.355424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '822b9d7d-9f37-44ad-bb22-4839daa69898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f995af40ee0>]}
[0m21:58:34.841104 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '822b9d7d-9f37-44ad-bb22-4839daa69898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f995af636d0>]}
[0m21:58:34.842092 [info ] [MainThread]: Found 6 models, 2 seeds, 1 operation, 480 macros
[0m21:58:34.843399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '822b9d7d-9f37-44ad-bb22-4839daa69898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f995af8c550>]}
[0m21:58:34.845622 [info ] [MainThread]: 
[0m21:58:34.846780 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m21:58:34.848408 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m21:58:34.850784 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:58:37.974974 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m21:58:37.976131 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:58:38.578510 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '822b9d7d-9f37-44ad-bb22-4839daa69898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f995ac389a0>]}
[0m21:58:38.579489 [info ] [MainThread]: 
[0m21:58:38.580144 [info ] [MainThread]: Running 1 on-run-start hook
[0m21:58:38.602022 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m21:58:38.610357 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m21:58:38.612296 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:58:38.613323 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m21:58:39.287975 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:e301fcd7-fe4b-428b-b6ec-fab4a14e22cb&page=queryresults
[0m21:58:40.667526 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.06s]
[0m21:58:40.668416 [info ] [MainThread]: 
[0m21:58:40.669359 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:58:40.670118 [info ] [MainThread]: 
[0m21:58:40.675026 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_beginner
[0m21:58:40.676306 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cohorts_beginner ...................... [RUN]
[0m21:58:40.677263 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cohorts_beginner)
[0m21:58:40.678144 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_beginner
[0m21:58:40.685955 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_beginner"
[0m21:58:40.687498 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_beginner
[0m21:58:40.752806 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_beginner"
[0m21:58:40.754206 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m21:58:40.755017 [debug] [Thread-1  ]: On model.creditrisk.cohorts_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_beginner"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_beginner`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the beginner core dataset, and produces information on raw payments only.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
)

WITH cohort_calc as (
    SELECT 
        *,
        DATE_TRUNC(registration_date, MONTH) as cohort, -- possible to change here to quarter or year
    FROM accounts_history
),

filtered as (
    SELECT 
        * 
    FROM cohort_calc
    WHERE  MOD(reporting_day, 30) = 1 -- optional : downsampling results to 1 point every 30 days. Often sufficient.
    QUALIFY reporting_day <= MIN(account_age_in_days) OVER(PARTITION BY cohort) -- removes the end of cohorts where calculation is not representative of the whole cohort
)

SELECT 
    cohort,
    reporting_day,
    SUM(paid_total) / SUM(unlock_price) as amount_paid_percent,
FROM filtered
GROUP BY ALL;


[0m21:58:41.359973 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b5910793-7400-4839-894a-061de7ecdd43&page=queryresults
[0m21:58:41.360966 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Syntax error: Expected keyword DEPTH but got identifier "cohort_calc" at [15:6]; reason: invalidQuery, location: query, message: Syntax error: Expected keyword DEPTH but got identifier "cohort_calc" at [15:6]')
[0m21:58:42.488786 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:ac3dd213-96ec-44fe-ade8-0b333d2a8aa6&page=queryresults
[0m21:58:42.489702 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:ac3dd213-96ec-44fe-ade8-0b333d2a8aa6&page=queryresults
[0m21:58:42.505726 [debug] [Thread-1  ]: Database Error in model cohorts_beginner (models/example/2_cohort_visualizations/cohorts_beginner.sql)
  Syntax error: Expected keyword DEPTH but got identifier "cohort_calc" at [15:6]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_beginner.sql
[0m21:58:42.508167 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '822b9d7d-9f37-44ad-bb22-4839daa69898', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f995b5c0fd0>]}
[0m21:58:42.509186 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.cohorts_beginner ............. [[31mERROR[0m in 1.83s]
[0m21:58:42.510445 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_beginner
[0m21:58:42.512647 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:58:42.513211 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_beginner' was properly closed.
[0m21:58:42.513738 [info ] [MainThread]: 
[0m21:58:42.515483 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 7.67 seconds (7.67s).
[0m21:58:42.518657 [debug] [MainThread]: Command end result
[0m21:58:42.591554 [info ] [MainThread]: 
[0m21:58:42.592516 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:58:42.593193 [info ] [MainThread]: 
[0m21:58:42.594349 [error] [MainThread]:   Database Error in model cohorts_beginner (models/example/2_cohort_visualizations/cohorts_beginner.sql)
  Syntax error: Expected keyword DEPTH but got identifier "cohort_calc" at [15:6]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_beginner.sql
[0m21:58:42.595417 [info ] [MainThread]: 
[0m21:58:42.596939 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m21:58:42.598328 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 13.72227, "process_user_time": 6.338119, "process_kernel_time": 1.231299, "process_mem_max_rss": "227721216", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:58:42.599480 [debug] [MainThread]: Command `dbt run` failed at 21:58:42.599272 after 13.72 seconds
[0m21:58:42.600211 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9954a275b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f9954d528e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f99560c97f0>]}
[0m21:58:42.600866 [debug] [MainThread]: Flushing usage events
[0m22:00:42.181836 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81422f5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd816272d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8162723d0>]}


============================== 22:00:42.186994 | f5a9283c-007e-4003-9f29-0d7e4fbfb5e7 ==============================
[0m22:00:42.186994 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:00:42.188122 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'printer_width': '80', 'introspect': 'True', 'static_parser': 'True', 'target_path': 'None', 'warn_error': 'None', 'debug': 'False', 'no_print': 'None', 'send_anonymous_usage_stats': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True', 'quiet': 'False', 'write_json': 'True', 'partial_parse': 'True', 'invocation_command': 'dbt run --select 2+cohorts_beginner', 'profiles_dir': '/Users/david/.dbt', 'use_colors': 'True', 'cache_selected_only': 'False', 'empty': 'False', 'fail_fast': 'False', 'log_cache_events': 'False', 'indirect_selection': 'eager'}
[0m22:00:47.593436 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8161f99a0>]}
[0m22:00:47.672980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81a416910>]}
[0m22:00:47.673950 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:00:47.711761 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:00:48.129106 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:00:48.129710 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:00:48.239092 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81a840ee0>]}
[0m22:00:48.542720 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81a862550>]}
[0m22:00:48.544448 [info ] [MainThread]: Found 6 models, 2 seeds, 1 operation, 480 macros
[0m22:00:48.545401 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81a88d7c0>]}
[0m22:00:48.548563 [info ] [MainThread]: 
[0m22:00:48.550121 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:00:48.560429 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:00:48.562288 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:00:52.311915 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:00:52.313638 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:00:52.910001 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81a4c6c40>]}
[0m22:00:52.911327 [info ] [MainThread]: 
[0m22:00:52.912105 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:00:52.932512 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:00:52.939459 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:00:52.940510 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:00:52.941911 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:00:53.561821 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:897fefa5-ffe6-4d3d-8415-4b5afa158cb7&page=queryresults
[0m22:00:55.031079 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.09s]
[0m22:00:55.032531 [info ] [MainThread]: 
[0m22:00:55.034210 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:00:55.035110 [info ] [MainThread]: 
[0m22:00:55.044876 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_accounts
[0m22:00:55.046815 [info ] [Thread-1  ]: 1 of 5 START sql view model oscreditrisk.cleaned_accounts ...................... [RUN]
[0m22:00:55.048235 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cleaned_accounts)
[0m22:00:55.049254 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_accounts
[0m22:00:55.057847 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_accounts"
[0m22:00:55.062339 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_accounts
[0m22:00:55.145865 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_accounts"
[0m22:00:55.147136 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:55.148146 [debug] [Thread-1  ]: On model.creditrisk.cleaned_accounts: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_accounts"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH accounts as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_accounts`
)

SELECT 
  account_id, 
  CAST(registration_date            AS TIMESTAMP)     as registration_date, 
  CAST(unlock_price                 AS FLOAT64)       as unlock_price, 
  CAST(down_payment                 AS FLOAT64)       as down_payment, 
  CAST(down_payment_days_included   AS FLOAT64)       as down_payment_days_included, 
  CAST(daily_rate                   AS FLOAT64)       as daily_rate, 
FROM accounts;


[0m22:00:55.952166 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:5413b627-6dd2-4dc2-b416-4bba26180719&page=queryresults
[0m22:00:56.620244 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd819d14610>]}
[0m22:00:56.621384 [info ] [Thread-1  ]: 1 of 5 OK created sql view model oscreditrisk.cleaned_accounts ................. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m22:00:56.622526 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_accounts
[0m22:00:56.623341 [debug] [Thread-1  ]: Began running node model.creditrisk.cleaned_payments
[0m22:00:56.624232 [info ] [Thread-1  ]: 2 of 5 START sql view model oscreditrisk.cleaned_payments ...................... [RUN]
[0m22:00:56.624962 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_accounts, now model.creditrisk.cleaned_payments)
[0m22:00:56.625547 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cleaned_payments
[0m22:00:56.635945 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cleaned_payments"
[0m22:00:56.637852 [debug] [Thread-1  ]: Began executing node model.creditrisk.cleaned_payments
[0m22:00:56.642619 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cleaned_payments"
[0m22:00:56.643879 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:56.644662 [debug] [Thread-1  ]: On model.creditrisk.cleaned_payments: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cleaned_payments"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
  OPTIONS()
  as /*
    This transformations is just casting fields in the right format. 
    In practice, you may add here filtering steps to reduce your data to relevant records.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`raw_payments`
)

SELECT 
  account_id,
  CAST(down_payment             AS BOOLEAN)         as down_payment,
  CAST(payment_effective_date   AS TIMESTAMP)       as payment_effective_date,
  CAST(amount                   AS FLOAT64)         as amount,
FROM payments;


[0m22:00:57.561308 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:efac34a0-117c-4276-940a-035305251da5&page=queryresults
[0m22:00:58.190425 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81b0461c0>]}
[0m22:00:58.192158 [info ] [Thread-1  ]: 2 of 5 OK created sql view model oscreditrisk.cleaned_payments ................. [[32mCREATE VIEW (0 processed)[0m in 1.57s]
[0m22:00:58.193737 [debug] [Thread-1  ]: Finished running node model.creditrisk.cleaned_payments
[0m22:00:58.195643 [debug] [Thread-1  ]: Began running node model.creditrisk.date_spine
[0m22:00:58.196998 [info ] [Thread-1  ]: 3 of 5 START sql view model oscreditrisk.date_spine ............................ [RUN]
[0m22:00:58.199608 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.cleaned_payments, now model.creditrisk.date_spine)
[0m22:00:58.202728 [debug] [Thread-1  ]: Began compiling node model.creditrisk.date_spine
[0m22:00:58.217724 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.date_spine"
[0m22:00:58.220173 [debug] [Thread-1  ]: Began executing node model.creditrisk.date_spine
[0m22:00:58.232799 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.date_spine"
[0m22:00:58.234426 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:00:58.235873 [debug] [Thread-1  ]: On model.creditrisk.date_spine: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.date_spine"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`date_spine`
  OPTIONS()
  as /*
    This transformations is generating a dataset containing one row for each day betwee : 
    - The first day you opened an account
    - Today. With artificial data here we consider today being the day after we received the last payment.
*/

WITH payments as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

min_max_dates as (
    SELECT 
        CAST(MIN(payment_effective_date)            AS DATE)                    as min_date,
        DATE_ADD(CAST(MAX(payment_effective_date)   AS DATE), INTERVAL 1 DAY)   as max_date,
    FROM payments
)

SELECT
    CAST(
        TIMESTAMP_ADD(
            (SELECT min_date FROM min_max_dates), 
            INTERVAL n DAY
        ) AS TIMESTAMP
    ) AS reporting_date,
FROM 
  UNNEST(
    GENERATE_ARRAY(
        0, 
        DATE_DIFF(
            (SELECT max_date FROM min_max_dates),
            (SELECT min_date FROM min_max_dates),
            DAY
        )
    )
) AS n;


[0m22:00:59.211889 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:b370ee4d-5333-4ea3-a2c6-4cb63d522163&page=queryresults
[0m22:00:59.826188 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81aeb83a0>]}
[0m22:00:59.827265 [info ] [Thread-1  ]: 3 of 5 OK created sql view model oscreditrisk.date_spine ....................... [[32mCREATE VIEW (0 processed)[0m in 1.63s]
[0m22:00:59.829146 [debug] [Thread-1  ]: Finished running node model.creditrisk.date_spine
[0m22:00:59.831638 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_beginner
[0m22:00:59.833976 [info ] [Thread-1  ]: 4 of 5 START sql table model oscreditrisk.accounts_history_beginner ............ [RUN]
[0m22:00:59.835508 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.date_spine, now model.creditrisk.accounts_history_beginner)
[0m22:00:59.836584 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_beginner
[0m22:00:59.851179 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_beginner"
[0m22:00:59.852503 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_beginner
[0m22:00:59.899646 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:01:00.604829 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_beginner"
[0m22:01:00.606220 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_beginner"} */

  
    

    create or replace table `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
      
    partition by timestamp_trunc(reporting_date, day)
    cluster by account_id

    OPTIONS()
    as (
      /*
    This transformations is generating the first version of the core dataset (beginner version). 
    It is essentially : 
    - Joining the accounts dataset with a date spine for the target granuarity
    - Grouping the payment by day, and joining them to the accounts history
    - Calculating cumulated sums to describe the cumulated amount paid, and a few other useful fields
*/



WITH accounts as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_accounts`
),

payments as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`cleaned_payments`
),

date_spine as (
  SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`date_spine`
),

accounts_with_spine as (
  SELECT 
    *,
    TIMESTAMP_DIFF(reporting_date, registration_date, DAY) + 1 as reporting_day,
  FROM accounts
  LEFT JOIN date_spine
  ON accounts.registration_date <= date_spine.reporting_date
),

payments_grouped_by_day as (
  SELECT 
    account_id,
    
    DATE_ADD(
      DATE_TRUNC(payment_effective_date, DAY), 
      INTERVAL 1 DAY
    ) as reporting_date,

    SUM(amount) as amount,
    SUM(
      IF(not down_payment, amount, 0)
    ) as amount_excl_dp,

  FROM payments
  GROUP BY ALL
),

joint as (
  SELECT 
    * EXCEPT(amount, amount_excl_dp),
    COALESCE(amount,          0) as amount,
    COALESCE(amount_excl_dp,  0) as amount_excl_dp,
  FROM accounts_with_spine 
  LEFT JOIN payments_grouped_by_day 
  USING(account_id, reporting_date)
),

calc_paid_total as (
  SELECT 
    *,
    SUM(amount)         OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total,
    SUM(amount_excl_dp) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_excl_dp,
    
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate) + down_payment_days_included as nominal_term,
    SAFE_DIVIDE(unlock_price - down_payment, daily_rate)                              as nominal_term_excl_dp,

    MAX(reporting_day) OVER(PARTITION BY account_id) as account_age_in_days,
    GREATEST(
            0,
            MAX(reporting_day - down_payment_days_included) OVER(PARTITION BY account_id)
    ) as account_age_excl_dp_in_days,

    DATE_TRUNC(registration_date, MONTH) as cohort_month,
    DATE_TRUNC(registration_date, QUARTER) as cohort_quarter,
    DATE_TRUNC(registration_date, YEAR) as cohort_year,

  FROM joint
)

SELECT * FROM calc_paid_total
    );
  
[0m22:01:01.305138 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:927294eb-71f1-4df2-bb6d-18bb55752efd&page=queryresults
[0m22:01:28.053349 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd819d14610>]}
[0m22:01:28.054796 [info ] [Thread-1  ]: 4 of 5 OK created sql table model oscreditrisk.accounts_history_beginner ....... [[32mCREATE TABLE (3.4m rows, 6.2 MiB processed)[0m in 28.22s]
[0m22:01:28.056916 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_beginner
[0m22:01:28.058993 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_beginner
[0m22:01:28.062143 [info ] [Thread-1  ]: 5 of 5 START sql view model oscreditrisk.cohorts_beginner ...................... [RUN]
[0m22:01:28.064695 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.accounts_history_beginner, now model.creditrisk.cohorts_beginner)
[0m22:01:28.066044 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_beginner
[0m22:01:28.119909 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_beginner"
[0m22:01:28.133957 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_beginner
[0m22:01:28.147567 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_beginner"
[0m22:01:28.150506 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:01:28.154504 [debug] [Thread-1  ]: On model.creditrisk.cohorts_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_beginner"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_beginner`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the beginner core dataset, and produces information on raw payments only.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

filtered as (
    SELECT 
        * 
    FROM cohort_calc
    -- optional : downsampling results to 1 point every 30 days. Often sufficient.
    WHERE  MOD(reporting_day, 30) = 1 
    -- removing the end of cohorts where calculation is not representative of the whole cohort
    QUALIFY reporting_day <= MIN(account_age_in_days) OVER(PARTITION BY cohort_month) 
)

-- Aggregating results on a cohort level
SELECT 
    cohort,
    reporting_day,
    SUM(paid_total) / SUM(unlock_price) as amount_paid_percent,
FROM filtered
GROUP BY ALL;


[0m22:01:29.034283 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:24220f32-9639-4207-8c91-82cb9bd49f29&page=queryresults
[0m22:01:29.082582 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Table "cohort_calc" must be qualified with a dataset (e.g. dataset.table).; reason: invalid, location: cohort_calc, message: Table "cohort_calc" must be qualified with a dataset (e.g. dataset.table).')
[0m22:01:30.040062 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:df58da3f-df47-4d5f-8cfc-b441da72ecdb&page=queryresults
[0m22:01:30.041284 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:df58da3f-df47-4d5f-8cfc-b441da72ecdb&page=queryresults
[0m22:01:30.057947 [debug] [Thread-1  ]: Database Error in model cohorts_beginner (models/example/2_cohort_visualizations/cohorts_beginner.sql)
  Table "cohort_calc" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_beginner.sql
[0m22:01:30.058838 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f5a9283c-007e-4003-9f29-0d7e4fbfb5e7', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81b0ed790>]}
[0m22:01:30.059897 [error] [Thread-1  ]: 5 of 5 ERROR creating sql view model oscreditrisk.cohorts_beginner ............. [[31mERROR[0m in 1.99s]
[0m22:01:30.061257 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_beginner
[0m22:01:30.063353 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:01:30.063947 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_beginner' was properly closed.
[0m22:01:30.064703 [info ] [MainThread]: 
[0m22:01:30.066331 [info ] [MainThread]: Finished running 4 view models, 1 table model, 1 project hook in 0 hours 0 minutes and 41.52 seconds (41.51s).
[0m22:01:30.070453 [debug] [MainThread]: Command end result
[0m22:01:30.148289 [info ] [MainThread]: 
[0m22:01:30.149099 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:01:30.149792 [info ] [MainThread]: 
[0m22:01:30.150501 [error] [MainThread]:   Database Error in model cohorts_beginner (models/example/2_cohort_visualizations/cohorts_beginner.sql)
  Table "cohort_calc" must be qualified with a dataset (e.g. dataset.table).
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_beginner.sql
[0m22:01:30.151058 [info ] [MainThread]: 
[0m22:01:30.151728 [info ] [MainThread]: Done. PASS=4 WARN=0 ERROR=1 SKIP=0 TOTAL=5
[0m22:01:30.152613 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 48.07829, "process_user_time": 6.868597, "process_kernel_time": 1.36377, "process_mem_max_rss": "229679104", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:01:30.153733 [debug] [MainThread]: Command `dbt run` failed at 22:01:30.153506 after 48.08 seconds
[0m22:01:30.154980 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81422f5b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd8145698e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd81a8e76a0>]}
[0m22:01:30.156159 [debug] [MainThread]: Flushing usage events
[0m22:01:52.177355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc746a32580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc748b7d430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc748b7de80>]}


============================== 22:01:52.183543 | a9efd601-3fb8-409d-9d44-e0c05c99021d ==============================
[0m22:01:52.183543 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:01:52.184850 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'invocation_command': 'dbt run --select cohorts_beginner', 'target_path': 'None', 'write_json': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'no_print': 'None', 'empty': 'False', 'partial_parse': 'True', 'printer_width': '80', 'use_colors': 'True', 'debug': 'False', 'introspect': 'True', 'warn_error': 'None', 'quiet': 'False', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'profiles_dir': '/Users/david/.dbt', 'fail_fast': 'False', 'log_format': 'default', 'indirect_selection': 'eager'}
[0m22:01:58.677595 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'a9efd601-3fb8-409d-9d44-e0c05c99021d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc74cc1fa30>]}
[0m22:01:58.760296 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'a9efd601-3fb8-409d-9d44-e0c05c99021d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc74cbd7ca0>]}
[0m22:01:58.761623 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:01:58.800019 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:01:59.195416 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:01:59.196064 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:01:59.283394 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'a9efd601-3fb8-409d-9d44-e0c05c99021d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc74cf79130>]}
[0m22:01:59.656164 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'a9efd601-3fb8-409d-9d44-e0c05c99021d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc74cd0ea30>]}
[0m22:01:59.656979 [info ] [MainThread]: Found 7 models, 2 seeds, 1 operation, 480 macros
[0m22:01:59.657552 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9efd601-3fb8-409d-9d44-e0c05c99021d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc746d2f550>]}
[0m22:01:59.659180 [info ] [MainThread]: 
[0m22:01:59.660175 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:01:59.661590 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:01:59.662183 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:02:02.816780 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:02:02.818619 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:02:03.515702 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'a9efd601-3fb8-409d-9d44-e0c05c99021d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc74ccb4070>]}
[0m22:02:03.516638 [info ] [MainThread]: 
[0m22:02:03.517287 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:02:03.538692 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:02:03.548399 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:02:03.549317 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:02:03.550094 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:02:04.189016 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:9a666937-5ba7-4f5f-948f-05e3b6c71a6d&page=queryresults
[0m22:02:05.901241 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.35s]
[0m22:02:05.902525 [info ] [MainThread]: 
[0m22:02:05.903590 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:02:05.904254 [info ] [MainThread]: 
[0m22:02:05.909423 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_beginner
[0m22:02:05.911164 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cohorts_beginner ...................... [RUN]
[0m22:02:05.913427 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cohorts_beginner)
[0m22:02:05.914627 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_beginner
[0m22:02:05.921965 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_beginner"
[0m22:02:05.923186 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_beginner
[0m22:02:05.988554 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_beginner"
[0m22:02:05.989788 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:02:05.990577 [debug] [Thread-1  ]: On model.creditrisk.cohorts_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_beginner"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_beginner`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the beginner core dataset, and produces information on raw payments only.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

filtered as (
    SELECT 
        * 
    FROM accounts_history
    -- optional : downsampling results to 1 point every 30 days. Often sufficient.
    WHERE  MOD(reporting_day, 30) = 1 
    -- removing the end of cohorts where calculation is not representative of the whole cohort
    QUALIFY reporting_day <= MIN(account_age_in_days) OVER(PARTITION BY cohort_month) 
)

-- Aggregating results on a cohort level
SELECT 
    cohort,
    reporting_day,
    SUM(paid_total) / SUM(unlock_price) as amount_paid_percent,
FROM filtered
GROUP BY ALL;


[0m22:02:06.752573 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:9877870e-9e3b-47ee-8418-07f2b83ab0d7&page=queryresults
[0m22:02:07.090855 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: cohort at [27:5]; reason: invalidQuery, location: query, message: Unrecognized name: cohort at [27:5]')
[0m22:02:07.652691 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:08249f77-ccb0-4b04-b97d-0c6bcacdac2e&page=queryresults
[0m22:02:07.953144 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:08249f77-ccb0-4b04-b97d-0c6bcacdac2e&page=queryresults
[0m22:02:07.971138 [debug] [Thread-1  ]: Database Error in model cohorts_beginner (models/example/2_cohort_visualizations/cohorts_beginner.sql)
  Unrecognized name: cohort at [27:5]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_beginner.sql
[0m22:02:07.973761 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'a9efd601-3fb8-409d-9d44-e0c05c99021d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc74d8386d0>]}
[0m22:02:07.974889 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.cohorts_beginner ............. [[31mERROR[0m in 2.06s]
[0m22:02:07.976030 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_beginner
[0m22:02:07.979003 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:02:07.980088 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_beginner' was properly closed.
[0m22:02:07.980684 [info ] [MainThread]: 
[0m22:02:07.981457 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 8.32 seconds (8.32s).
[0m22:02:07.982985 [debug] [MainThread]: Command end result
[0m22:02:08.073601 [info ] [MainThread]: 
[0m22:02:08.074885 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:02:08.076022 [info ] [MainThread]: 
[0m22:02:08.078345 [error] [MainThread]:   Database Error in model cohorts_beginner (models/example/2_cohort_visualizations/cohorts_beginner.sql)
  Unrecognized name: cohort at [27:5]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_beginner.sql
[0m22:02:08.080589 [info ] [MainThread]: 
[0m22:02:08.082641 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:02:08.084680 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 16.009256, "process_user_time": 6.999031, "process_kernel_time": 1.365149, "process_mem_max_rss": "228093952", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:02:08.085965 [debug] [MainThread]: Command `dbt run` failed at 22:02:08.085772 after 16.01 seconds
[0m22:02:08.086788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc746a32580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc746d00bb0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fc74cd51220>]}
[0m22:02:08.087472 [debug] [MainThread]: Flushing usage events
[0m22:04:53.202600 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb5e25d5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb60268d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb602683d0>]}


============================== 22:04:53.207236 | 87da9dbf-5932-4f32-b8ff-d34b9660be75 ==============================
[0m22:04:53.207236 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:04:53.208165 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'target_path': 'None', 'printer_width': '80', 'invocation_command': 'dbt run --select cohorts_beginner', 'fail_fast': 'False', 'quiet': 'False', 'introspect': 'True', 'version_check': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'use_colors': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'indirect_selection': 'eager', 'empty': 'False', 'profiles_dir': '/Users/david/.dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'warn_error': 'None', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'static_parser': 'True', 'log_format': 'default', 'write_json': 'True'}
[0m22:04:57.260588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '87da9dbf-5932-4f32-b8ff-d34b9660be75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb6451f670>]}
[0m22:04:57.339994 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '87da9dbf-5932-4f32-b8ff-d34b9660be75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb5fb392e0>]}
[0m22:04:57.340952 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:04:57.379146 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:04:57.761342 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:04:57.761961 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:04:57.844399 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '87da9dbf-5932-4f32-b8ff-d34b9660be75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb64a79130>]}
[0m22:04:58.107951 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '87da9dbf-5932-4f32-b8ff-d34b9660be75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb64a459d0>]}
[0m22:04:58.108742 [info ] [MainThread]: Found 7 models, 2 seeds, 1 operation, 480 macros
[0m22:04:58.109291 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87da9dbf-5932-4f32-b8ff-d34b9660be75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb64a8ab80>]}
[0m22:04:58.110897 [info ] [MainThread]: 
[0m22:04:58.111734 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:04:58.112952 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:04:58.113663 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:05:01.341317 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:05:01.342302 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:05:01.997680 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '87da9dbf-5932-4f32-b8ff-d34b9660be75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb64538a90>]}
[0m22:05:01.998562 [info ] [MainThread]: 
[0m22:05:01.999160 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:05:02.016899 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:05:02.024658 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:05:02.025513 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:05:02.026258 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:05:02.616979 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:97d8d908-e175-4af3-8f8e-db453d821e16&page=queryresults
[0m22:05:04.277464 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.25s]
[0m22:05:04.278132 [info ] [MainThread]: 
[0m22:05:04.278858 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:05:04.279359 [info ] [MainThread]: 
[0m22:05:04.283153 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_beginner
[0m22:05:04.284361 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cohorts_beginner ...................... [RUN]
[0m22:05:04.285251 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cohorts_beginner)
[0m22:05:04.285857 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_beginner
[0m22:05:04.290670 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_beginner"
[0m22:05:04.291906 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_beginner
[0m22:05:04.341104 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_beginner"
[0m22:05:04.343411 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:05:04.344405 [debug] [Thread-1  ]: On model.creditrisk.cohorts_beginner: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_beginner"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_beginner`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the beginner core dataset. 
    Produces information on raw payments only.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

filtered as (
    SELECT 
        * 
    FROM accounts_history
    -- optional : downsampling results to 1 point every 30 days. Often sufficient.
    WHERE  MOD(reporting_day, 30) = 1 
    -- removing the end of cohorts where calculation is not representative of the whole cohort
    QUALIFY reporting_day <= MIN(account_age_in_days) OVER(PARTITION BY cohort_month) 
)

-- Aggregating results on a cohort level
SELECT 
    cohort_month,
    reporting_day,
    SUM(paid_total) / SUM(unlock_price) as amount_paid_percent,
FROM filtered
GROUP BY ALL;


[0m22:05:05.081530 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:d0832c1c-2883-4dd1-b47c-ec6cd59948b7&page=queryresults
[0m22:05:05.808062 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '87da9dbf-5932-4f32-b8ff-d34b9660be75', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb65102820>]}
[0m22:05:05.809083 [info ] [Thread-1  ]: 1 of 1 OK created sql view model oscreditrisk.cohorts_beginner ................. [[32mCREATE VIEW (0 processed)[0m in 1.52s]
[0m22:05:05.810051 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_beginner
[0m22:05:05.811746 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:05:05.812229 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_beginner' was properly closed.
[0m22:05:05.812778 [info ] [MainThread]: 
[0m22:05:05.813344 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 7.70 seconds (7.70s).
[0m22:05:05.814368 [debug] [MainThread]: Command end result
[0m22:05:05.873310 [info ] [MainThread]: 
[0m22:05:05.874239 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:05:05.874912 [info ] [MainThread]: 
[0m22:05:05.875603 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:05:05.876520 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 12.763528, "process_user_time": 5.863736, "process_kernel_time": 1.025358, "process_mem_max_rss": "227291136", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:05:05.877460 [debug] [MainThread]: Command `dbt run` succeeded at 22:05:05.877293 after 12.76 seconds
[0m22:05:05.878085 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb5e25d5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb5e570940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fbb5fb3f910>]}
[0m22:05:05.878695 [debug] [MainThread]: Flushing usage events
[0m22:05:17.759268 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6ea260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6ec276430>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6ec276e80>]}


============================== 22:05:17.764714 | 22f3b36e-05b7-4f59-9483-769813b8b84e ==============================
[0m22:05:17.764714 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:05:17.765742 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'no_print': 'None', 'partial_parse': 'True', 'introspect': 'True', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'indirect_selection': 'eager', 'static_parser': 'True', 'debug': 'False', 'profiles_dir': '/Users/david/.dbt', 'target_path': 'None', 'quiet': 'False', 'invocation_command': 'dbt run --select cohorts_advanced', 'use_experimental_parser': 'False', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'version_check': 'True', 'empty': 'False', 'use_colors': 'True', 'log_cache_events': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'warn_error': 'None'}
[0m22:05:21.995010 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '22f3b36e-05b7-4f59-9483-769813b8b84e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6efd83ee0>]}
[0m22:05:22.083306 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '22f3b36e-05b7-4f59-9483-769813b8b84e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6efcd6d30>]}
[0m22:05:22.084401 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:05:22.124055 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:05:22.480684 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:05:22.481245 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:05:22.557178 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '22f3b36e-05b7-4f59-9483-769813b8b84e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6f0979130>]}
[0m22:05:22.805233 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '22f3b36e-05b7-4f59-9483-769813b8b84e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6f066c490>]}
[0m22:05:22.806030 [info ] [MainThread]: Found 7 models, 2 seeds, 1 operation, 480 macros
[0m22:05:22.806585 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '22f3b36e-05b7-4f59-9483-769813b8b84e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6ec05c640>]}
[0m22:05:22.808230 [info ] [MainThread]: 
[0m22:05:22.809043 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:05:22.810295 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:05:22.810907 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:05:25.967532 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:05:25.969270 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:05:26.578490 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '22f3b36e-05b7-4f59-9483-769813b8b84e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6f059edf0>]}
[0m22:05:26.579342 [info ] [MainThread]: 
[0m22:05:26.579942 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:05:26.597978 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:05:26.608411 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:05:26.609289 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:05:26.610048 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:05:27.264617 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:4d7e4cd7-d270-4605-b934-e9acb8edd12a&page=queryresults
[0m22:05:28.672041 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.06s]
[0m22:05:28.673200 [info ] [MainThread]: 
[0m22:05:28.674686 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:05:28.675676 [info ] [MainThread]: 
[0m22:05:28.681455 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_advanced
[0m22:05:28.682471 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cohorts_advanced ...................... [RUN]
[0m22:05:28.683934 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cohorts_advanced)
[0m22:05:28.684758 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_advanced
[0m22:05:28.692874 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_advanced"
[0m22:05:28.694863 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_advanced
[0m22:05:28.749810 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_advanced"
[0m22:05:28.751421 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:05:28.753006 [debug] [Thread-1  ]: On model.creditrisk.cohorts_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_advanced`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the advanced core dataset.
    Produces information on linearized payments and with a term elapsed in % excluding downpayment.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
),

perc_elapsed as (
  SELECT 
    *,
    SAFE_DIVIDE(reporting_day_excl_dp, nominal_term_excl_dp) as perc_term_elapsed,
  FROM accounts_history
),

approximating as (
  SELECT
    *,
    -- Flooring the perc paid to the next 5% (we could choose another grain)
    FLOOR(perc_term_elapsed * 20) * 5 as perc_term_elapsed_approx,
  FROM perc_elapsed
)

SELECT * FROM approximating
WHERE perc_term_elapsed_approx <= 200
QUALIFY ROW_NUMBER() OVER(PARTITION BY account_id, CAST(perc_term_elapsed_approx AS STRING) ORDER BY reporting_day_excl_dp) = 1;


[0m22:05:29.529597 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:01d31ae3-cadf-4f92-83dc-a7bf786ecaa2&page=queryresults
[0m22:05:30.168088 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22f3b36e-05b7-4f59-9483-769813b8b84e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6f1341880>]}
[0m22:05:30.169179 [info ] [Thread-1  ]: 1 of 1 OK created sql view model oscreditrisk.cohorts_advanced ................. [[32mCREATE VIEW (0 processed)[0m in 1.48s]
[0m22:05:30.170433 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_advanced
[0m22:05:30.172267 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:05:30.172889 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_advanced' was properly closed.
[0m22:05:30.173430 [info ] [MainThread]: 
[0m22:05:30.174021 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 7.36 seconds (7.36s).
[0m22:05:30.175144 [debug] [MainThread]: Command end result
[0m22:05:30.233283 [info ] [MainThread]: 
[0m22:05:30.234534 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:05:30.235310 [info ] [MainThread]: 
[0m22:05:30.236121 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=0 SKIP=0 TOTAL=1
[0m22:05:30.237136 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 12.60358, "process_user_time": 5.919085, "process_kernel_time": 1.035066, "process_mem_max_rss": "227225600", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:05:30.238216 [debug] [MainThread]: Command `dbt run` succeeded at 22:05:30.237984 after 12.60 seconds
[0m22:05:30.238902 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6ea260580>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6f03d7d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7fd6efcd6d30>]}
[0m22:05:30.239501 [debug] [MainThread]: Flushing usage events
[0m22:16:02.097525 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f83fd22f610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f83ff231dc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f83ff231400>]}


============================== 22:16:02.101829 | cb6c6659-9cda-4354-881b-6ff12fcf06c9 ==============================
[0m22:16:02.101829 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:16:02.102761 [debug] [MainThread]: running dbt with arguments {'empty': 'False', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'quiet': 'False', 'version_check': 'True', 'warn_error': 'None', 'write_json': 'True', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'indirect_selection': 'eager', 'introspect': 'True', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'no_print': 'None', 'invocation_command': 'dbt run --select cohorts_advanced', 'static_parser': 'True', 'profiles_dir': '/Users/david/.dbt', 'use_experimental_parser': 'False', 'printer_width': '80', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'debug': 'False', 'log_format': 'default', 'partial_parse': 'True'}
[0m22:16:05.759076 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'cb6c6659-9cda-4354-881b-6ff12fcf06c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8402ca8520>]}
[0m22:16:05.838508 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'cb6c6659-9cda-4354-881b-6ff12fcf06c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f83ff201160>]}
[0m22:16:05.839463 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:16:05.868916 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:16:06.320465 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:16:06.321104 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:16:06.415926 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'cb6c6659-9cda-4354-881b-6ff12fcf06c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f840373a130>]}
[0m22:16:06.693470 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'cb6c6659-9cda-4354-881b-6ff12fcf06c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f840373baf0>]}
[0m22:16:06.694334 [info ] [MainThread]: Found 7 models, 2 seeds, 1 operation, 480 macros
[0m22:16:06.694924 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cb6c6659-9cda-4354-881b-6ff12fcf06c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f840374ab20>]}
[0m22:16:06.696639 [info ] [MainThread]: 
[0m22:16:06.697657 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:16:06.700311 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:16:06.701618 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:16:09.812768 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:16:09.814082 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:16:10.417910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'cb6c6659-9cda-4354-881b-6ff12fcf06c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8403650070>]}
[0m22:16:10.418901 [info ] [MainThread]: 
[0m22:16:10.419599 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:16:10.438662 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:16:10.446271 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:16:10.447114 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:16:10.447857 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:16:11.073158 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:6544a183-4551-4330-87d6-1ba6a0400ecd&page=queryresults
[0m22:16:12.438154 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 1.99s]
[0m22:16:12.438821 [info ] [MainThread]: 
[0m22:16:12.439550 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:16:12.440064 [info ] [MainThread]: 
[0m22:16:12.443197 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_advanced
[0m22:16:12.444023 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cohorts_advanced ...................... [RUN]
[0m22:16:12.445422 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cohorts_advanced)
[0m22:16:12.446059 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_advanced
[0m22:16:12.450916 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_advanced"
[0m22:16:12.452754 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_advanced
[0m22:16:12.496940 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_advanced"
[0m22:16:12.498365 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:16:12.499166 [debug] [Thread-1  ]: On model.creditrisk.cohorts_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_advanced`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the advanced core dataset.
    Produces information on linearized payments and with a term elapsed in % excluding downpayment.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
),

perc_elapsed as (
    SELECT 
        *,
        SAFE_DIVIDE(reporting_day_excl_dp, nominal_term_excl_dp) as perc_term_elapsed,
    FROM accounts_history
),

approximating as (
    SELECT
        *,
        -- Flooring the perc paid to the next 5% (we could choose another grain)
        FLOOR(perc_term_elapsed * 20) * 5 as perc_term_elapsed_approx,
    FROM perc_elapsed
),

downsampling as (
    SELECT 
        * 
    FROM approximating
    -- Optional : limit the time horizon to 200% of contractual term. Often sufficient.
    WHERE perc_term_elapsed_approx <= 200
    -- Ensure the dataset ends up with only one row per grain on % of contractual term
    QUALIFY ROW_NUMBER() OVER(PARTITION BY account_id, CAST(perc_term_elapsed_approx AS STRING) ORDER BY reporting_day_excl_dp) = 1
),

counting_accounts as (
  SELECT 
    *,
    COUNT(account_id) OVER (PARTITION BY cohort, CAST(perc_term_elapsed_approx AS INT64)) as cnt_accounts,
  FROM downsampling
),

filtering as (
    SELECT 
        *,
    FROM counting_accounts
    -- optional - removes the end of cohorts where calculation is not representative of the whole cohort. 
    -- We take 98% and not 100% as otherwise only a few outliers might prevent us from showing the cohort.
    QUALIFY cnt_accounts >= 0.98 * MAX(cnt_accounts) OVER(PARTITION BY cohort_month) 
),

aggregating as (
    SELECT 
        cohort_month,
        perc_term_elapsed_approx,
        SUM(paid_total_lin) / SUM(unlock_price - downpayment) as amount_paid_percent,
    FROM filtering
    GROUP BY ALL 
)

SELECT * FROM aggregating;


[0m22:16:13.195113 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:26b6f6ce-c52d-486f-8cdf-1cbbd2abe21b&page=queryresults
[0m22:16:13.490918 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: cohort at [44:42]; reason: invalidQuery, location: query, message: Unrecognized name: cohort at [44:42]')
[0m22:16:14.348475 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:485a5b8e-053b-4874-8981-8451681742a2&page=queryresults
[0m22:16:14.622050 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:485a5b8e-053b-4874-8981-8451681742a2&page=queryresults
[0m22:16:14.639993 [debug] [Thread-1  ]: Database Error in model cohorts_advanced (models/example/2_cohort_visualizations/cohorts_advanced.sql)
  Unrecognized name: cohort at [44:42]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_advanced.sql
[0m22:16:14.642967 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'cb6c6659-9cda-4354-881b-6ff12fcf06c9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8403dbfb50>]}
[0m22:16:14.644370 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.cohorts_advanced ............. [[31mERROR[0m in 2.20s]
[0m22:16:14.645433 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_advanced
[0m22:16:14.647240 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:16:14.647754 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_advanced' was properly closed.
[0m22:16:14.648282 [info ] [MainThread]: 
[0m22:16:14.648941 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 7.95 seconds (7.95s).
[0m22:16:14.651128 [debug] [MainThread]: Command end result
[0m22:16:14.709403 [info ] [MainThread]: 
[0m22:16:14.710641 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:16:14.711207 [info ] [MainThread]: 
[0m22:16:14.711887 [error] [MainThread]:   Database Error in model cohorts_advanced (models/example/2_cohort_visualizations/cohorts_advanced.sql)
  Unrecognized name: cohort at [44:42]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_advanced.sql
[0m22:16:14.712427 [info ] [MainThread]: 
[0m22:16:14.713002 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:16:14.713854 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 12.7149515, "process_user_time": 5.272713, "process_kernel_time": 0.969184, "process_mem_max_rss": "228200448", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:16:14.714776 [debug] [MainThread]: Command `dbt run` failed at 22:16:14.714608 after 12.72 seconds
[0m22:16:14.715400 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f83fd22f610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f83ff201160>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f83fea008e0>]}
[0m22:16:14.715992 [debug] [MainThread]: Flushing usage events
[0m22:16:20.566511 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9a22f5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9c2f1d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9c2f13d0>]}


============================== 22:16:20.572970 | 2cc2c2e6-4b7c-4ffc-b340-532598a9d341 ==============================
[0m22:16:20.572970 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:16:20.574217 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'use_experimental_parser': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'cache_selected_only': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'partial_parse': 'True', 'version_check': 'True', 'write_json': 'True', 'no_print': 'None', 'invocation_command': 'dbt run --select cohorts_advanced', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'fail_fast': 'False', 'profiles_dir': '/Users/david/.dbt', 'use_colors': 'True', 'debug': 'False', 'log_format': 'default', 'printer_width': '80', 'indirect_selection': 'eager', 'warn_error': 'None', 'quiet': 'False', 'log_cache_events': 'False', 'empty': 'False', 'static_parser': 'True'}
[0m22:16:27.172991 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '2cc2c2e6-4b7c-4ffc-b340-532598a9d341', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9c2a7b50>]}
[0m22:16:27.285355 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '2cc2c2e6-4b7c-4ffc-b340-532598a9d341', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea02d55b0>]}
[0m22:16:27.286400 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:16:27.331265 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:16:27.849505 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:16:27.850204 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:16:27.949304 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '2cc2c2e6-4b7c-4ffc-b340-532598a9d341', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea083a130>]}
[0m22:16:28.233603 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '2cc2c2e6-4b7c-4ffc-b340-532598a9d341', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea0802a30>]}
[0m22:16:28.234416 [info ] [MainThread]: Found 7 models, 2 seeds, 1 operation, 480 macros
[0m22:16:28.235112 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cc2c2e6-4b7c-4ffc-b340-532598a9d341', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea084ab20>]}
[0m22:16:28.236986 [info ] [MainThread]: 
[0m22:16:28.238098 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:16:28.239566 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:16:28.240976 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:16:31.682343 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:16:31.684603 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:16:32.324465 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '2cc2c2e6-4b7c-4ffc-b340-532598a9d341', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9a56b940>]}
[0m22:16:32.325455 [info ] [MainThread]: 
[0m22:16:32.326432 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:16:32.351021 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:16:32.363678 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:16:32.365332 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:16:32.366299 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:16:33.021609 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:12696de5-07e6-4867-b608-374dfe507bec&page=queryresults
[0m22:16:34.172695 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 1.81s]
[0m22:16:34.173379 [info ] [MainThread]: 
[0m22:16:34.174178 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:16:34.175185 [info ] [MainThread]: 
[0m22:16:34.179380 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_advanced
[0m22:16:34.180393 [info ] [Thread-1  ]: 1 of 1 START sql view model oscreditrisk.cohorts_advanced ...................... [RUN]
[0m22:16:34.181176 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.cohorts_advanced)
[0m22:16:34.181792 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_advanced
[0m22:16:34.190276 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_advanced"
[0m22:16:34.192075 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_advanced
[0m22:16:34.253458 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_advanced"
[0m22:16:34.255620 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:16:34.256827 [debug] [Thread-1  ]: On model.creditrisk.cohorts_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_advanced`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the advanced core dataset.
    Produces information on linearized payments and with a term elapsed in % excluding downpayment.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
),

perc_elapsed as (
    SELECT 
        *,
        SAFE_DIVIDE(reporting_day_excl_dp, nominal_term_excl_dp) as perc_term_elapsed,
    FROM accounts_history
),

approximating as (
    SELECT
        *,
        -- Flooring the perc paid to the next 5% (we could choose another grain)
        FLOOR(perc_term_elapsed * 20) * 5 as perc_term_elapsed_approx,
    FROM perc_elapsed
),

downsampling as (
    SELECT 
        * 
    FROM approximating
    -- Optional : limit the time horizon to 200% of contractual term. Often sufficient.
    WHERE perc_term_elapsed_approx <= 200
    -- Ensure the dataset ends up with only one row per grain on % of contractual term
    QUALIFY ROW_NUMBER() OVER(PARTITION BY account_id, CAST(perc_term_elapsed_approx AS STRING) ORDER BY reporting_day_excl_dp) = 1
),

counting_accounts as (
  SELECT 
    *,
    COUNT(account_id) OVER (PARTITION BY cohort_month, CAST(perc_term_elapsed_approx AS INT64)) as cnt_accounts,
  FROM downsampling
),

filtering as (
    SELECT 
        *,
    FROM counting_accounts
    -- optional - removes the end of cohorts where calculation is not representative of the whole cohort. 
    -- We take 98% and not 100% as otherwise only a few outliers might prevent us from showing the cohort.
    QUALIFY cnt_accounts >= 0.98 * MAX(cnt_accounts) OVER(PARTITION BY cohort_month) 
),

aggregating as (
    SELECT 
        cohort_month,
        perc_term_elapsed_approx,
        SUM(paid_total_lin) / SUM(unlock_price - downpayment) as amount_paid_percent,
    FROM filtering
    GROUP BY ALL 
)

SELECT * FROM aggregating;


[0m22:16:34.992813 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:ce2d841a-5180-4137-a26d-5480c1dfe05b&page=queryresults
[0m22:16:35.280785 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: cohort_month at [44:42]; reason: invalidQuery, location: query, message: Unrecognized name: cohort_month at [44:42]')
[0m22:16:35.786079 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:e57bba74-0fb5-40a0-a107-016d23dc2a4a&page=queryresults
[0m22:16:36.068907 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:e57bba74-0fb5-40a0-a107-016d23dc2a4a&page=queryresults
[0m22:16:36.081849 [debug] [Thread-1  ]: Database Error in model cohorts_advanced (models/example/2_cohort_visualizations/cohorts_advanced.sql)
  Unrecognized name: cohort_month at [44:42]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_advanced.sql
[0m22:16:36.084602 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2cc2c2e6-4b7c-4ffc-b340-532598a9d341', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8ea0fa8d60>]}
[0m22:16:36.086176 [error] [Thread-1  ]: 1 of 1 ERROR creating sql view model oscreditrisk.cohorts_advanced ............. [[31mERROR[0m in 1.90s]
[0m22:16:36.087865 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_advanced
[0m22:16:36.089609 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:16:36.090374 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_advanced' was properly closed.
[0m22:16:36.090855 [info ] [MainThread]: 
[0m22:16:36.091398 [info ] [MainThread]: Finished running 1 view model, 1 project hook in 0 hours 0 minutes and 7.85 seconds (7.85s).
[0m22:16:36.092708 [debug] [MainThread]: Command end result
[0m22:16:36.144335 [info ] [MainThread]: 
[0m22:16:36.144979 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:16:36.145373 [info ] [MainThread]: 
[0m22:16:36.145900 [error] [MainThread]:   Database Error in model cohorts_advanced (models/example/2_cohort_visualizations/cohorts_advanced.sql)
  Unrecognized name: cohort_month at [44:42]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_advanced.sql
[0m22:16:36.146347 [info ] [MainThread]: 
[0m22:16:36.146773 [info ] [MainThread]: Done. PASS=0 WARN=0 ERROR=1 SKIP=0 TOTAL=1
[0m22:16:36.147401 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 15.718016, "process_user_time": 7.21954, "process_kernel_time": 1.519632, "process_mem_max_rss": "228024320", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:16:36.148081 [debug] [MainThread]: Command `dbt run` failed at 22:16:36.147962 after 15.72 seconds
[0m22:16:36.148550 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9a22f5e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9a532550>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8e9ba94940>]}
[0m22:16:36.148985 [debug] [MainThread]: Flushing usage events
[0m22:17:10.138451 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89142215b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89161f9d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89161f93d0>]}


============================== 22:17:10.143626 | c5d8d364-9dac-4596-bed0-bb7ee32dfc1f ==============================
[0m22:17:10.143626 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:17:10.144804 [debug] [MainThread]: running dbt with arguments {'version_check': 'True', 'quiet': 'False', 'write_json': 'True', 'invocation_command': 'dbt run --select 1+cohorts_advanced', 'use_experimental_parser': 'False', 'introspect': 'True', 'target_path': 'None', 'fail_fast': 'False', 'log_cache_events': 'False', 'use_colors': 'True', 'static_parser': 'True', 'printer_width': '80', 'log_format': 'default', 'debug': 'False', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'empty': 'False', 'no_print': 'None', 'partial_parse': 'True', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/Users/david/.dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])'}
[0m22:17:14.036111 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8919d6ae80>]}
[0m22:17:14.093238 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89161deeb0>]}
[0m22:17:14.094029 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:17:14.118805 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:17:14.396918 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:17:14.397401 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:17:14.458797 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f891a87a130>]}
[0m22:17:14.624709 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f891a8418e0>]}
[0m22:17:14.625329 [info ] [MainThread]: Found 7 models, 2 seeds, 1 operation, 480 macros
[0m22:17:14.625996 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f891a88ab20>]}
[0m22:17:14.627428 [info ] [MainThread]: 
[0m22:17:14.628104 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:17:14.633235 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:17:14.633886 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:17:17.117928 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:17:17.118924 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:17:17.753920 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f891a5cea00>]}
[0m22:17:17.754903 [info ] [MainThread]: 
[0m22:17:17.755598 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:17:17.775115 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:17:17.782527 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:17:17.783538 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:17:17.784354 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:17:18.516362 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:439d3e98-0f2d-47a6-98ed-345ba5be709f&page=queryresults
[0m22:17:19.923423 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.14s]
[0m22:17:19.924597 [info ] [MainThread]: 
[0m22:17:19.925928 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:17:19.926863 [info ] [MainThread]: 
[0m22:17:19.931767 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m22:17:19.932867 [info ] [Thread-1  ]: 1 of 2 START sql table model oscreditrisk.accounts_history_advanced ............ [RUN]
[0m22:17:19.933988 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_advanced)
[0m22:17:19.934908 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m22:17:19.943552 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m22:17:19.946097 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m22:17:19.988584 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:17:20.689565 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m22:17:20.691327 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */

  
    

    create or replace table `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
      
    partition by timestamp_trunc(reporting_date, day)
    cluster by account_id

    OPTIONS()
    as (
      /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/



WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

additional_kpis as (
    SELECT 
        *,
        
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.

        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses

    FROM accounts_history
),

-- Preparing the data for the UDF (consuming arrays)
prepared_for_udf as (
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM additional_kpis
    GROUP BY ALL
),

-- applying the UDF on prepared data format
apply_udf AS (
    SELECT 
        *,
        oscreditrisk.payment_linearization(
        prepared_for_udf.payment_amounts, 
        prepared_for_udf.daily_rates, 
        prepared_for_udf.casted_reporting_dates
        ) as payment_amount_lin_excl_dp
    FROM prepared_for_udf
),

-- Expanding the results before joining them back
expand_udf_result AS (
    SELECT
        account_id,
        CAST(reporting_date AS TIMESTAMP) as reporting_date,
        amount_lin
    FROM
        apply_udf,
        UNNEST(apply_udf.casted_reporting_dates)            AS reporting_date   WITH OFFSET AS pos
    JOIN UNNEST(apply_udf.payment_amount_lin_excl_dp)     AS amount_lin       WITH OFFSET AS val_pos
    ON pos = val_pos
),

join_back_on_dataset as (
    SELECT 
        *,
        SUM(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_lin,
        IF(
            amount_lin = 0 AND LAG(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day) > 0,
            reporting_date,
            Null
        ) as last_disablement,
    FROM additional_kpis 
    LEFT JOIN expand_udf_result USING(account_id, reporting_date)
),

-- As a last step, use this information to calculate useful fields: status and number of days disabled.
final_kpis as (
  SELECT 
    *,
    CASE 
        WHEN reporting_day <= down_payment_days_included THEN 'ENABLED'
        WHEN paid_total >= unlock_price THEN 'UNLOCKED'
        WHEN amount_lin > 0   THEN 'ENABLED'
        WHEN amount_lin <= 0  THEN 'DISABLED'
    END as reporting_date_status,
    CASE 
        WHEN amount_lin = 0 
        THEN DATE_DIFF(
            reporting_date, 
            LAST_VALUE(last_disablement IGNORE NULLS) OVER(PARTITION BY account_id ORDER BY reporting_day),
            DAY
        ) 
    END as days_disabled,
  FROM join_back_on_dataset
)

SELECT * FROM final_kpis
    );
  
[0m22:17:21.174488 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:ca0287c8-17f0-4b76-ae63-2d78a49c041f&page=queryresults
[0m22:18:01.581404 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8919cba730>]}
[0m22:18:01.583217 [info ] [Thread-1  ]: 1 of 2 OK created sql table model oscreditrisk.accounts_history_advanced ....... [[32mCREATE TABLE (3.4m rows, 485.9 MiB processed)[0m in 41.65s]
[0m22:18:01.584229 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m22:18:01.585421 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_advanced
[0m22:18:01.586192 [info ] [Thread-1  ]: 2 of 2 START sql view model oscreditrisk.cohorts_advanced ...................... [RUN]
[0m22:18:01.586893 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.accounts_history_advanced, now model.creditrisk.cohorts_advanced)
[0m22:18:01.587482 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_advanced
[0m22:18:01.592770 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_advanced"
[0m22:18:01.593872 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_advanced
[0m22:18:01.625835 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_advanced"
[0m22:18:01.627217 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:18:01.628719 [debug] [Thread-1  ]: On model.creditrisk.cohorts_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_advanced`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the advanced core dataset.
    Produces information on linearized payments and with a term elapsed in % excluding downpayment.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
),

perc_elapsed as (
    SELECT 
        *,
        SAFE_DIVIDE(reporting_day_excl_dp, nominal_term_excl_dp) as perc_term_elapsed,
    FROM accounts_history
),

approximating as (
    SELECT
        *,
        -- Flooring the perc paid to the next 5% (we could choose another grain)
        FLOOR(perc_term_elapsed * 20) * 5 as perc_term_elapsed_approx,
    FROM perc_elapsed
),

downsampling as (
    SELECT 
        * 
    FROM approximating
    -- Optional : limit the time horizon to 200% of contractual term. Often sufficient.
    WHERE perc_term_elapsed_approx <= 200
    -- Ensure the dataset ends up with only one row per grain on % of contractual term
    QUALIFY ROW_NUMBER() OVER(PARTITION BY account_id, CAST(perc_term_elapsed_approx AS STRING) ORDER BY reporting_day_excl_dp) = 1
),

counting_accounts as (
  SELECT 
    *,
    COUNT(account_id) OVER (PARTITION BY cohort_month, CAST(perc_term_elapsed_approx AS INT64)) as cnt_accounts,
  FROM downsampling
),

filtering as (
    SELECT 
        *,
    FROM counting_accounts
    -- optional - removes the end of cohorts where calculation is not representative of the whole cohort. 
    -- We take 98% and not 100% as otherwise only a few outliers might prevent us from showing the cohort.
    QUALIFY cnt_accounts >= 0.98 * MAX(cnt_accounts) OVER(PARTITION BY cohort_month) 
),

aggregating as (
    SELECT 
        cohort_month,
        perc_term_elapsed_approx,
        SUM(paid_total_lin) / SUM(unlock_price - downpayment) as amount_paid_percent,
    FROM filtering
    GROUP BY ALL 
)

SELECT * FROM aggregating;


[0m22:18:02.443497 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:1cd42996-e473-46aa-9bac-43a52aa703fe&page=queryresults
[0m22:18:02.735915 [debug] [Thread-1  ]: BigQuery adapter: Retry attempt 1 of 1 after error: BadRequest('Unrecognized name: downpayment; Did you mean down_payment? at [61:50]; reason: invalidQuery, location: query, message: Unrecognized name: downpayment; Did you mean down_payment? at [61:50]')
[0m22:18:04.071935 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:bc836f1d-4e07-4f66-905b-e59b65910530&page=queryresults
[0m22:18:04.373862 [error] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:bc836f1d-4e07-4f66-905b-e59b65910530&page=queryresults
[0m22:18:04.389375 [debug] [Thread-1  ]: Database Error in model cohorts_advanced (models/example/2_cohort_visualizations/cohorts_advanced.sql)
  Unrecognized name: downpayment; Did you mean down_payment? at [61:50]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_advanced.sql
[0m22:18:04.390729 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c5d8d364-9dac-4596-bed0-bb7ee32dfc1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f891b29e790>]}
[0m22:18:04.392433 [error] [Thread-1  ]: 2 of 2 ERROR creating sql view model oscreditrisk.cohorts_advanced ............. [[31mERROR[0m in 2.80s]
[0m22:18:04.394252 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_advanced
[0m22:18:04.397001 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:18:04.397728 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_advanced' was properly closed.
[0m22:18:04.399034 [info ] [MainThread]: 
[0m22:18:04.399920 [info ] [MainThread]: Finished running 1 table model, 1 view model, 1 project hook in 0 hours 0 minutes and 49.77 seconds (49.77s).
[0m22:18:04.401561 [debug] [MainThread]: Command end result
[0m22:18:04.469637 [info ] [MainThread]: 
[0m22:18:04.470740 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m22:18:04.471541 [info ] [MainThread]: 
[0m22:18:04.472588 [error] [MainThread]:   Database Error in model cohorts_advanced (models/example/2_cohort_visualizations/cohorts_advanced.sql)
  Unrecognized name: downpayment; Did you mean down_payment? at [61:50]
  compiled code at target/run/creditrisk/models/example/2_cohort_visualizations/cohorts_advanced.sql
[0m22:18:04.473254 [info ] [MainThread]: 
[0m22:18:04.473865 [info ] [MainThread]: Done. PASS=1 WARN=0 ERROR=1 SKIP=0 TOTAL=2
[0m22:18:04.474737 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 54.450024, "process_user_time": 5.413385, "process_kernel_time": 0.922376, "process_mem_max_rss": "229748736", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:18:04.476025 [debug] [MainThread]: Command `dbt run` failed at 22:18:04.475629 after 54.45 seconds
[0m22:18:04.476849 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f89142215b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f891466f8e0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7f8915acd280>]}
[0m22:18:04.477820 [debug] [MainThread]: Flushing usage events
[0m22:18:25.651821 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb87a33520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb89b71d60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb89b710a0>]}


============================== 22:18:25.657335 | ff6245b6-661b-4c65-b734-deeac7955056 ==============================
[0m22:18:25.657335 [info ] [MainThread]: Running with dbt=1.8.8
[0m22:18:25.658289 [debug] [MainThread]: running dbt with arguments {'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'write_json': 'True', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run --select 1+cohorts_advanced', 'empty': 'False', 'static_parser': 'True', 'warn_error': 'None', 'log_path': '/Users/david/bbplus-os-credit-risk/bbplus-os-credit-risk/logs', 'introspect': 'True', 'log_format': 'default', 'log_cache_events': 'False', 'fail_fast': 'False', 'no_print': 'None', 'target_path': 'None', 'version_check': 'True', 'printer_width': '80', 'indirect_selection': 'eager', 'profiles_dir': '/Users/david/.dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'use_colors': 'True', 'debug': 'False', 'quiet': 'False'}
[0m22:18:30.252169 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb88573820>]}
[0m22:18:30.343261 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8dbfc1c0>]}
[0m22:18:30.344481 [info ] [MainThread]: Registered adapter: bigquery=1.8.3
[0m22:18:30.381277 [debug] [MainThread]: checksum: ec53e341a936509427e16df1c646386a84befec52c1957e3f4359fbc36fc93f5, vars: {}, profile: , target: , version: 1.8.8
[0m22:18:31.202773 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:18:31.203589 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:18:31.341480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8df6a130>]}
[0m22:18:31.687263 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8df8e0a0>]}
[0m22:18:31.688853 [info ] [MainThread]: Found 7 models, 2 seeds, 1 operation, 480 macros
[0m22:18:31.690390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8df66fd0>]}
[0m22:18:31.694930 [info ] [MainThread]: 
[0m22:18:31.698169 [debug] [MainThread]: Acquiring new bigquery connection 'master'
[0m22:18:31.711354 [debug] [ThreadPool]: Acquiring new bigquery connection 'list_steam-outlet-209412'
[0m22:18:31.712594 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:18:35.098919 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_steam-outlet-209412, now list_steam-outlet-209412_oscreditrisk)
[0m22:18:35.099919 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:18:35.673147 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8dd0b5b0>]}
[0m22:18:35.674089 [info ] [MainThread]: 
[0m22:18:35.674683 [info ] [MainThread]: Running 1 on-run-start hook
[0m22:18:35.695982 [debug] [MainThread]: Writing injected SQL for node "operation.creditrisk.creditrisk-on-run-start-0"
[0m22:18:35.705810 [info ] [MainThread]: 1 of 1 START hook: creditrisk.on-run-start.0 ................................... [RUN]
[0m22:18:35.707010 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:18:35.707908 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "connection_name": "master"} */


CREATE SCHEMA IF NOT EXISTS oscreditrisk;

CREATE OR REPLACE FUNCTION oscreditrisk.payment_linearization(
  payment_amounts ARRAY<FLOAT64>,
  daily_rate ARRAY<FLOAT64>,
  reporting_dates ARRAY<STRING>
)

RETURNS ARRAY<FLOAT64>
LANGUAGE js AS """
    let result = [];
    let balance = 0.0;

    for (let i = 0; i < payment_amounts.length; i++) {
        if (payment_amounts[i] > 0) {
            // Add payment to balance
            balance += payment_amounts[i];
        }

        if (balance >= daily_rate[i]) {
            result.push(daily_rate[i]);
            balance = balance - daily_rate[i];
        }
        else if (balance > 0.0) {
            result.push(balance);
            balance = 0.0
        } 
        else {
            // Push zero for days with no payment distribution
            result.push(0.0);
            balance = 0.0
        }
    }
    return result;
""";
  

[0m22:18:36.340140 [debug] [MainThread]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:de282174-2bb9-4d93-8108-497b8d4d235b&page=queryresults
[0m22:18:38.083561 [info ] [MainThread]: 1 of 1 OK hook: creditrisk.on-run-start.0 ...................................... [[32mSCRIPT (0 processed)[0m in 2.38s]
[0m22:18:38.084271 [info ] [MainThread]: 
[0m22:18:38.085016 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:18:38.085599 [info ] [MainThread]: 
[0m22:18:38.092392 [debug] [Thread-1  ]: Began running node model.creditrisk.accounts_history_advanced
[0m22:18:38.093721 [info ] [Thread-1  ]: 1 of 2 START sql table model oscreditrisk.accounts_history_advanced ............ [RUN]
[0m22:18:38.094756 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly list_steam-outlet-209412_oscreditrisk, now model.creditrisk.accounts_history_advanced)
[0m22:18:38.096107 [debug] [Thread-1  ]: Began compiling node model.creditrisk.accounts_history_advanced
[0m22:18:38.107550 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.accounts_history_advanced"
[0m22:18:38.109299 [debug] [Thread-1  ]: Began executing node model.creditrisk.accounts_history_advanced
[0m22:18:38.160013 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:18:38.797669 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.accounts_history_advanced"
[0m22:18:38.799004 [debug] [Thread-1  ]: On model.creditrisk.accounts_history_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.accounts_history_advanced"} */

  
    

    create or replace table `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
      
    partition by timestamp_trunc(reporting_date, day)
    cluster by account_id

    OPTIONS()
    as (
      /*
    This transformations is generating the second version of the core dataset (advanced version)
    The main complexity lies in the fact that SQL is not sufficient to calculate the linearized payments. 
    We thus need to use a User Defined Function (here in Javascript) - but we could also use another programming language. 
*/



WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_beginner`
),

additional_kpis as (
    SELECT 
        *,
        
        CASE 
            WHEN reporting_day <= down_payment_days_included THEN Null
            WHEN reporting_day = down_payment_days_included + 1 THEN paid_total
            ELSE amount_excl_dp
        END as amount_excl_dp_period, -- This step is necessary to 'record' payments at the end of the downpayment period.

        CASE  
            WHEN reporting_day < down_payment_days_included THEN Null
            WHEN reporting_day >= down_payment_days_included THEN reporting_day - down_payment_days_included
        END as reporting_day_excl_dp, -- Necessary to remove the downpayment period from analyses

    FROM accounts_history
),

-- Preparing the data for the UDF (consuming arrays)
prepared_for_udf as (
    SELECT
        account_id,
        ARRAY_AGG(COALESCE(amount_excl_dp_period, 0)     ORDER BY reporting_day) as payment_amounts,
        ARRAY_AGG(daily_rate                             ORDER BY reporting_day) as daily_rates,
        ARRAY_AGG(CAST(DATE(reporting_date) as STRING)   ORDER BY reporting_day) as casted_reporting_dates,
    FROM additional_kpis
    GROUP BY ALL
),

-- applying the UDF on prepared data format
apply_udf AS (
    SELECT 
        *,
        oscreditrisk.payment_linearization(
        prepared_for_udf.payment_amounts, 
        prepared_for_udf.daily_rates, 
        prepared_for_udf.casted_reporting_dates
        ) as payment_amount_lin_excl_dp
    FROM prepared_for_udf
),

-- Expanding the results before joining them back
expand_udf_result AS (
    SELECT
        account_id,
        CAST(reporting_date AS TIMESTAMP) as reporting_date,
        amount_lin
    FROM
        apply_udf,
        UNNEST(apply_udf.casted_reporting_dates)            AS reporting_date   WITH OFFSET AS pos
    JOIN UNNEST(apply_udf.payment_amount_lin_excl_dp)     AS amount_lin       WITH OFFSET AS val_pos
    ON pos = val_pos
),

join_back_on_dataset as (
    SELECT 
        *,
        SUM(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as paid_total_lin,
        IF(
            amount_lin = 0 AND LAG(amount_lin) OVER(PARTITION BY account_id ORDER BY reporting_day) > 0,
            reporting_date,
            Null
        ) as last_disablement,
    FROM additional_kpis 
    LEFT JOIN expand_udf_result USING(account_id, reporting_date)
),

-- As a last step, use this information to calculate useful fields: status and number of days disabled.
final_kpis as (
  SELECT 
    *,
    CASE 
        WHEN reporting_day <= down_payment_days_included THEN 'ENABLED'
        WHEN paid_total >= unlock_price THEN 'UNLOCKED'
        WHEN amount_lin > 0   THEN 'ENABLED'
        WHEN amount_lin <= 0  THEN 'DISABLED'
    END as reporting_date_status,
    CASE 
        WHEN amount_lin = 0 
        THEN DATE_DIFF(
            reporting_date, 
            LAST_VALUE(last_disablement IGNORE NULLS) OVER(PARTITION BY account_id ORDER BY reporting_day),
            DAY
        ) 
    END as days_disabled,
  FROM join_back_on_dataset
)

SELECT * FROM final_kpis
    );
  
[0m22:18:39.338361 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:a34be21e-9332-4d34-8ac2-e7aacf661df6&page=queryresults
[0m22:19:25.999793 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8d5da670>]}
[0m22:19:26.001184 [info ] [Thread-1  ]: 1 of 2 OK created sql table model oscreditrisk.accounts_history_advanced ....... [[32mCREATE TABLE (3.4m rows, 485.9 MiB processed)[0m in 47.90s]
[0m22:19:26.002235 [debug] [Thread-1  ]: Finished running node model.creditrisk.accounts_history_advanced
[0m22:19:26.003640 [debug] [Thread-1  ]: Began running node model.creditrisk.cohorts_advanced
[0m22:19:26.004500 [info ] [Thread-1  ]: 2 of 2 START sql view model oscreditrisk.cohorts_advanced ...................... [RUN]
[0m22:19:26.005292 [debug] [Thread-1  ]: Re-using an available connection from the pool (formerly model.creditrisk.accounts_history_advanced, now model.creditrisk.cohorts_advanced)
[0m22:19:26.005900 [debug] [Thread-1  ]: Began compiling node model.creditrisk.cohorts_advanced
[0m22:19:26.010918 [debug] [Thread-1  ]: Writing injected SQL for node "model.creditrisk.cohorts_advanced"
[0m22:19:26.012022 [debug] [Thread-1  ]: Began executing node model.creditrisk.cohorts_advanced
[0m22:19:26.041340 [debug] [Thread-1  ]: Writing runtime sql for node "model.creditrisk.cohorts_advanced"
[0m22:19:26.043287 [debug] [Thread-1  ]: Opening a new connection, currently in state closed
[0m22:19:26.044196 [debug] [Thread-1  ]: On model.creditrisk.cohorts_advanced: /* {"app": "dbt", "dbt_version": "1.8.8", "profile_name": "creditrisk", "target_name": "dev", "node_id": "model.creditrisk.cohorts_advanced"} */


  create or replace view `steam-outlet-209412`.`oscreditrisk`.`cohorts_advanced`
  OPTIONS()
  as /*
    This transformations is aggregating on a cohort level for visualisation.
    It uses the advanced core dataset.
    Produces information on linearized payments and with a term elapsed in % excluding downpayment.
*/

WITH accounts_history as (
    SELECT * FROM `steam-outlet-209412`.`oscreditrisk`.`accounts_history_advanced`
),

perc_elapsed as (
    SELECT 
        *,
        SAFE_DIVIDE(reporting_day_excl_dp, nominal_term_excl_dp) as perc_term_elapsed,
    FROM accounts_history
),

approximating as (
    SELECT
        *,
        -- Flooring the perc paid to the next 5% (we could choose another grain)
        FLOOR(perc_term_elapsed * 20) * 5 as perc_term_elapsed_approx,
    FROM perc_elapsed
),

downsampling as (
    SELECT 
        * 
    FROM approximating
    -- Optional : limit the time horizon to 200% of contractual term. Often sufficient.
    WHERE perc_term_elapsed_approx <= 200
    -- Ensure the dataset ends up with only one row per grain on % of contractual term
    QUALIFY ROW_NUMBER() OVER(PARTITION BY account_id, CAST(perc_term_elapsed_approx AS STRING) ORDER BY reporting_day_excl_dp) = 1
),

counting_accounts as (
  SELECT 
    *,
    COUNT(account_id) OVER (PARTITION BY cohort_month, CAST(perc_term_elapsed_approx AS INT64)) as cnt_accounts,
  FROM downsampling
),

filtering as (
    SELECT 
        *,
    FROM counting_accounts
    -- optional - removes the end of cohorts where calculation is not representative of the whole cohort. 
    -- We take 98% and not 100% as otherwise only a few outliers might prevent us from showing the cohort.
    QUALIFY cnt_accounts >= 0.98 * MAX(cnt_accounts) OVER(PARTITION BY cohort_month) 
),

aggregating as (
    SELECT 
        cohort_month,
        perc_term_elapsed_approx,
        SUM(paid_total_lin) / SUM(unlock_price - down_payment) as amount_paid_percent,
    FROM filtering
    GROUP BY ALL 
)

SELECT * FROM aggregating;


[0m22:19:26.844466 [debug] [Thread-1  ]: BigQuery adapter: https://console.cloud.google.com/bigquery?project=steam-outlet-209412&j=bq:EU:a058c943-aacc-49c0-949e-adae4cafbf97&page=queryresults
[0m22:19:27.534499 [debug] [Thread-1  ]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'ff6245b6-661b-4c65-b734-deeac7955056', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8e85e5b0>]}
[0m22:19:27.535554 [info ] [Thread-1  ]: 2 of 2 OK created sql view model oscreditrisk.cohorts_advanced ................. [[32mCREATE VIEW (0 processed)[0m in 1.53s]
[0m22:19:27.536873 [debug] [Thread-1  ]: Finished running node model.creditrisk.cohorts_advanced
[0m22:19:27.538738 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:19:27.539458 [debug] [MainThread]: Connection 'model.creditrisk.cohorts_advanced' was properly closed.
[0m22:19:27.540643 [info ] [MainThread]: 
[0m22:19:27.542321 [info ] [MainThread]: Finished running 1 table model, 1 view model, 1 project hook in 0 hours 0 minutes and 55.84 seconds (55.84s).
[0m22:19:27.544602 [debug] [MainThread]: Command end result
[0m22:19:27.613385 [info ] [MainThread]: 
[0m22:19:27.614326 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:19:27.614920 [info ] [MainThread]: 
[0m22:19:27.615546 [info ] [MainThread]: Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
[0m22:19:27.616454 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 62.06488, "process_user_time": 6.502736, "process_kernel_time": 1.218672, "process_mem_max_rss": "228012032", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:19:27.617958 [debug] [MainThread]: Command `dbt run` succeeded at 22:19:27.617745 after 62.07 seconds
[0m22:19:27.618777 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb87a33520>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8dfc3a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7feb8dbfc1c0>]}
[0m22:19:27.619498 [debug] [MainThread]: Flushing usage events
